<div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700 h-full">
  <div class="px-4 py-3 border-b border-gray-100 dark:border-gray-700">
    <div class="flex items-center justify-between">
      <h3 class="text-base font-semibold text-gray-900 dark:text-gray-100">Cost by Model</h3>
      <span class="text-xs text-gray-500 dark:text-gray-400">
        $<%= number_with_precision(model_stats.sum { |m| m[:total_cost] }, precision: 2) %> total
      </span>
    </div>
  </div>

  <% if model_stats.any? && model_stats.sum { |m| m[:total_cost] } > 0 %>
    <div class="p-4">
      <div id="model-cost-chart" style="width: 100%; height: 200px;"></div>

      <!-- Legend -->
      <div class="mt-4 space-y-2">
        <% colors = ['#6366F1', '#8B5CF6', '#EC4899', '#F59E0B', '#10B981', '#3B82F6', '#EF4444', '#6B7280'] %>
        <% model_stats.first(5).each_with_index do |model, i| %>
          <div class="flex items-center justify-between text-sm">
            <div class="flex items-center gap-2">
              <span class="w-3 h-3 rounded-full flex-shrink-0" style="background-color: <%= colors[i % colors.length] %>"></span>
              <span class="text-gray-700 dark:text-gray-300 truncate max-w-[140px]" title="<%= model[:model_id] %>">
                <%= model[:model_id].to_s.split('/').last.truncate(18) %>
              </span>
            </div>
            <div class="flex items-center gap-2">
              <span class="text-gray-900 dark:text-gray-100 font-medium">$<%= number_with_precision(model[:total_cost], precision: 2) %></span>
              <span class="text-gray-500 dark:text-gray-400 text-xs w-12 text-right"><%= model[:cost_percentage] %>%</span>
            </div>
          </div>
        <% end %>
        <% if model_stats.length > 5 %>
          <% other_cost = model_stats[5..].sum { |m| m[:total_cost] } %>
          <% other_percentage = model_stats[5..].sum { |m| m[:cost_percentage] } %>
          <div class="flex items-center justify-between text-sm">
            <div class="flex items-center gap-2">
              <span class="w-3 h-3 rounded-full flex-shrink-0 bg-gray-400"></span>
              <span class="text-gray-700 dark:text-gray-300">Other (<%= model_stats.length - 5 %> models)</span>
            </div>
            <div class="flex items-center gap-2">
              <span class="text-gray-900 dark:text-gray-100 font-medium">$<%= number_with_precision(other_cost, precision: 2) %></span>
              <span class="text-gray-500 dark:text-gray-400 text-xs w-12 text-right"><%= other_percentage.round(1) %>%</span>
            </div>
          </div>
        <% end %>
      </div>
    </div>

    <script>
      (function() {
        const colors = ['#6366F1', '#8B5CF6', '#EC4899', '#F59E0B', '#10B981', '#3B82F6', '#EF4444', '#6B7280'];
        const data = [
          <% model_stats.first(5).each_with_index do |model, i| %>
            { name: '<%= model[:model_id].to_s.split('/').last.truncate(15).gsub("'", "\\'") %>', y: <%= model[:total_cost] %>, color: colors[<%= i %>] },
          <% end %>
          <% if model_stats.length > 5 %>
            { name: 'Other', y: <%= model_stats[5..].sum { |m| m[:total_cost] } %>, color: '#9CA3AF' },
          <% end %>
        ];

        function initChart() {
          if (typeof Highcharts === 'undefined') {
            setTimeout(initChart, 100);
            return;
          }

          Highcharts.chart('model-cost-chart', {
            chart: {
              type: 'pie',
              backgroundColor: 'transparent',
              spacing: [0, 0, 0, 0]
            },
            title: { text: null },
            credits: { enabled: false },
            tooltip: {
              backgroundColor: 'rgba(17, 24, 39, 0.95)',
              borderColor: 'transparent',
              borderRadius: 8,
              style: { color: '#F3F4F6', fontSize: '12px' },
              pointFormat: '<b>${point.y:.2f}</b> ({point.percentage:.1f}%)'
            },
            plotOptions: {
              pie: {
                innerSize: '60%',
                dataLabels: { enabled: false },
                borderWidth: 0,
                states: {
                  hover: { brightness: 0.1 }
                }
              }
            },
            series: [{
              name: 'Cost',
              data: data
            }]
          });
        }

        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', initChart);
        } else {
          initChart();
        }
      })();
    </script>
  <% else %>
    <div class="px-4 py-8 text-center text-gray-500 dark:text-gray-400">
      <svg class="w-8 h-8 mx-auto mb-2 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M11 3.055A9.001 9.001 0 1020.945 13H11V3.055z"/>
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M20.488 9H15V3.512A9.025 9.025 0 0120.488 9z"/>
      </svg>
      <p class="text-sm">No cost data yet</p>
    </div>
  <% end %>
</div>
