<!-- Action Center (only when critical alerts exist) -->
<%= render partial: "ruby_llm/agents/dashboard/action_center", locals: { critical_alerts: @critical_alerts } %>

<!-- Now Strip -->
<%= render partial: "ruby_llm/agents/dashboard/now_strip", locals: { now_strip: @now_strip } %>

<!-- Tenant Budget (when viewing specific tenant) -->
<%= render partial: "ruby_llm/agents/dashboard/tenant_budget", locals: { tenant_budget: @tenant_budget } %>

<!-- Activity Chart -->
<div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700 mb-6">
  <div class="px-6 py-3 border-b border-gray-100 dark:border-gray-700">
    <div class="flex items-center justify-between">
      <h3 class="text-base font-semibold text-gray-900 dark:text-gray-100">Activity</h3>
      <span id="chart-totals" class="text-sm text-gray-500 dark:text-gray-400"></span>
    </div>
  </div>

  <div id="activity-chart-container" class="p-4 h-[320px] sm:h-[380px]">
    <div id="activity-chart" style="width: 100%; height: 100%;"></div>
  </div>

  <script>
    (function() {
      const range = '<%= @selected_range %>';
      const chartUrl = '<%= ruby_llm_agents.chart_data_path %>?range=' + range;
      const hourMs = 3600000;
      const dayMs = 24 * hourMs;

      function convertToDatetimePoints(data, range) {
        const now = Date.now();
        const numPoints = data.length;
        if (range === 'today') {
          return data.map((val, i) => [now - (numPoints - 1 - i) * hourMs, val]);
        } else {
          return data.map((val, i) => [now - (numPoints - 1 - i) * dayMs, val]);
        }
      }

      function formatNumber(num) {
        return num.toLocaleString();
      }

      function initChart() {
        fetch(chartUrl)
          .then(res => res.json())
          .then(data => {
            const now = Date.now();
            const successData = convertToDatetimePoints(data.series[0].data, range);
            const failedData = convertToDatetimePoints(data.series[1].data, range);
            const costData = convertToDatetimePoints(data.series[2].data, range);

            // Update totals in header
            const totals = data.totals;
            const totalExecs = totals.success + totals.failed;
            document.getElementById('chart-totals').textContent =
              formatNumber(totalExecs) + ' executions â€¢ $' + totals.cost.toFixed(2);

            const timeRange = range === 'today' ? dayMs : (range === '7d' ? 7 * dayMs : 30 * dayMs);
            const dateFormat = range === 'today' ? '%H:%M' : '%b %d';

            Highcharts.chart('activity-chart', {
              chart: { type: 'areaspline', backgroundColor: 'transparent' },
              title: { text: null },
              xAxis: {
                type: 'datetime',
                min: now - timeRange,
                max: now,
                labels: { style: { color: '#9CA3AF' }, format: '{value:' + dateFormat + '}' },
                lineColor: 'rgba(156, 163, 175, 0.2)'
              },
              yAxis: [{
                title: { text: null },
                min: 0,
                allowDecimals: false,
                labels: { style: { color: '#9CA3AF' } },
                gridLineColor: 'rgba(156, 163, 175, 0.2)'
              }, {
                title: { text: null },
                min: 0,
                labels: { style: { color: '#F59E0B' }, format: '${value}' },
                opposite: true,
                gridLineWidth: 0
              }],
              legend: {
                enabled: true,
                align: 'center',
                verticalAlign: 'bottom',
                itemStyle: { color: '#9CA3AF', fontWeight: 'normal' },
                itemHoverStyle: { color: '#D1D5DB' }
              },
              credits: { enabled: false },
              tooltip: {
                shared: true,
                backgroundColor: 'rgba(17, 24, 39, 0.95)',
                borderColor: 'rgba(75, 85, 99, 0.5)',
                style: { color: '#F3F4F6' },
                xDateFormat: range === 'today' ? '%H:%M' : '%b %d'
              },
              plotOptions: {
                areaspline: {
                  fillOpacity: 0.15,
                  lineWidth: 2,
                  marker: { enabled: false, states: { hover: { enabled: true, radius: 4 } } }
                },
                spline: {
                  lineWidth: 2,
                  marker: { enabled: false, states: { hover: { enabled: true, radius: 4 } } }
                }
              },
              series: [
                { name: 'Success', type: 'areaspline', color: '#10B981', data: successData, yAxis: 0 },
                { name: 'Failed', type: 'areaspline', color: '#EF4444', data: failedData, yAxis: 0 },
                { name: 'Cost', type: 'spline', color: '#F59E0B', data: costData, yAxis: 1, tooltip: { valuePrefix: '$' } }
              ]
            });
          })
          .catch(err => console.log('[RubyLLM::Agents] Chart error:', err));
      }

      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initChart);
      } else {
        initChart();
      }
    })();
  </script>
</div>

<!-- Live Activity Feed -->
<div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700 mb-6">
  <div class="px-6 py-3 border-b border-gray-100 dark:border-gray-700">
    <div class="flex justify-between items-center">
      <h3 class="text-base font-semibold text-gray-900 dark:text-gray-100">Recent Activity</h3>
      <%= link_to "View All", ruby_llm_agents.executions_path, class: "text-blue-600 dark:text-blue-400 hover:text-blue-700 dark:hover:text-blue-300 text-sm font-medium" %>
    </div>
  </div>
  <div id="activity-feed" class="px-6 py-2">
    <% if @recent_executions.any? %>
      <% @recent_executions.first(5).each do |execution| %>
        <%= render partial: "ruby_llm/agents/dashboard/execution_item", locals: { execution: execution } %>
      <% end %>
    <% else %>
      <div class="py-8 text-center text-gray-500 dark:text-gray-400">
        <p class="text-sm">No executions yet</p>
      </div>
    <% end %>
  </div>
</div>

<!-- Agent Comparison + Top Errors -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
  <%= render partial: "ruby_llm/agents/dashboard/agent_comparison", locals: { agent_stats: @agent_stats } %>
  <%= render partial: "ruby_llm/agents/dashboard/top_errors", locals: { top_errors: @top_errors } %>
</div>
