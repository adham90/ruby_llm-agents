<!-- Page Header -->
<div class="mb-5 flex items-center justify-between">
  <h1 class="text-xl font-semibold text-gray-900 dark:text-gray-100">Dashboard</h1>
  <%= render "ruby_llm/agents/shared/doc_link" %>
</div>

<!-- Action Center (only when critical alerts exist) -->
<%= render partial: "ruby_llm/agents/dashboard/action_center", locals: { critical_alerts: @critical_alerts } %>

<!-- Activity Section -->
<div class="mb-8 pb-6 border-b border-gray-100 dark:border-gray-800">
  <div class="flex items-center justify-between mb-3">
    <div class="flex items-center gap-4">
      <h2 class="text-sm font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wide">Activity</h2>
      <div class="flex items-center gap-2 text-sm text-gray-600 dark:text-gray-300">
        <% total = @now_strip[:success_today] + @now_strip[:errors_today] %>
        <span><span class="font-medium text-gray-900 dark:text-gray-100"><%= number_with_delimiter(total) %></span> runs</span>
        <span class="text-gray-300 dark:text-gray-600">·</span>
        <span class="<%= @now_strip[:errors_today] > 0 ? 'text-red-600 dark:text-red-400' : '' %>">
          <span class="font-medium <%= @now_strip[:errors_today] > 0 ? '' : 'text-gray-900 dark:text-gray-100' %>"><%= @now_strip[:errors_today] %></span> errors<% if total > 0 && @now_strip[:errors_today] > 0 %> <span class="text-gray-400">(<%= (@now_strip[:errors_today].to_f / total * 100).round(1) %>%)</span><% end %>
        </span>
        <span class="text-gray-300 dark:text-gray-600">·</span>
        <span><span class="font-medium text-gray-900 dark:text-gray-100">$<%= number_with_precision(@now_strip[:cost_today], precision: 2) %></span></span>
      </div>
    </div>
    <div class="flex text-sm">
      <%= link_to "Today", ruby_llm_agents.root_path(range: "today"),
          class: "px-2 py-1 rounded #{@selected_range == 'today' ? 'bg-gray-900 dark:bg-gray-100 text-white dark:text-gray-900 font-medium' : 'text-gray-500 dark:text-gray-400 hover:text-gray-900 dark:hover:text-gray-100'}" %>
      <%= link_to "7d", ruby_llm_agents.root_path(range: "7d"),
          class: "px-2 py-1 rounded #{@selected_range == '7d' ? 'bg-gray-900 dark:bg-gray-100 text-white dark:text-gray-900 font-medium' : 'text-gray-500 dark:text-gray-400 hover:text-gray-900 dark:hover:text-gray-100'}" %>
      <%= link_to "30d", ruby_llm_agents.root_path(range: "30d"),
          class: "px-2 py-1 rounded #{@selected_range == '30d' ? 'bg-gray-900 dark:bg-gray-100 text-white dark:text-gray-900 font-medium' : 'text-gray-500 dark:text-gray-400 hover:text-gray-900 dark:hover:text-gray-100'}" %>
    </div>
  </div>

  <div id="activity-chart" style="width: 100%; height: 220px;"></div>

  <script>
    (function() {
      const range = '<%= @selected_range %>';
      const chartUrl = '<%= ruby_llm_agents.chart_data_path %>?range=' + range;
      const hourMs = 3600000;
      const dayMs = 24 * hourMs;

      function getTimeRangeMs(range) {
        if (range === 'today') return dayMs;
        if (range === '7d') return 7 * dayMs;
        if (range === '30d') return 30 * dayMs;
        return dayMs;
      }

      function convertToDatetimePoints(data, range) {
        const now = Date.now();
        const numPoints = data.length;
        return data.map((val, i) => [
          now - (numPoints - 1 - i) * (range === 'today' ? hourMs : dayMs),
          val
        ]);
      }

      function initChart() {
        fetch(chartUrl)
          .then(res => res.json())
          .then(data => {
            const timeRange = getTimeRangeMs(range);
            const dateFormat = range === 'today' ? '%H:%M' : '%b %d';
            const now = Date.now();

            Highcharts.chart('activity-chart', {
              chart: { type: 'areaspline', backgroundColor: 'transparent', spacing: [5, 0, 5, 0] },
              title: { text: null },
              xAxis: {
                type: 'datetime',
                min: now - timeRange,
                max: now,
                labels: { style: { color: '#9CA3AF', fontSize: '10px' }, format: '{value:' + dateFormat + '}' },
                lineColor: 'transparent',
                tickLength: 0
              },
              yAxis: {
                title: { text: null },
                min: 0,
                allowDecimals: false,
                labels: { style: { color: '#9CA3AF', fontSize: '10px' } },
                gridLineColor: 'rgba(156, 163, 175, 0.1)'
              },
              legend: { enabled: false },
              credits: { enabled: false },
              tooltip: {
                backgroundColor: 'rgba(17, 24, 39, 0.9)',
                borderColor: 'transparent',
                borderRadius: 4,
                style: { color: '#F3F4F6', fontSize: '11px' },
                shared: true,
                formatter: function() {
                  let html = '<b>' + Highcharts.dateFormat(dateFormat, this.x) + '</b>';
                  this.points.forEach(p => html += '<br/>' + p.series.name + ': ' + p.y);
                  return html;
                }
              },
              plotOptions: {
                areaspline: {
                  stacking: 'normal',
                  lineWidth: 1.5,
                  marker: { enabled: false, states: { hover: { enabled: true, radius: 3 } } }
                }
              },
              series: [
                {
                  name: 'Errors',
                  data: convertToDatetimePoints(data.series[1].data, range),
                  color: '#EF4444',
                  fillColor: { linearGradient: { x1: 0, y1: 0, x2: 0, y2: 1 }, stops: [[0, 'rgba(239, 68, 68, 0.15)'], [1, 'rgba(239, 68, 68, 0)']] }
                },
                {
                  name: 'Success',
                  data: convertToDatetimePoints(data.series[0].data, range),
                  color: '#10B981',
                  fillColor: { linearGradient: { x1: 0, y1: 0, x2: 0, y2: 1 }, stops: [[0, 'rgba(16, 185, 129, 0.15)'], [1, 'rgba(16, 185, 129, 0)']] }
                }
              ]
            });
          })
          .catch(err => console.log('[RubyLLM::Agents] Chart error:', err));
      }

      document.readyState === 'loading'
        ? document.addEventListener('DOMContentLoaded', initChart)
        : initChart();
    })();
  </script>
</div>

<!-- Tenant Budget (when viewing specific tenant) -->
<%= render partial: "ruby_llm/agents/dashboard/tenant_budget", locals: { tenant_budget: @tenant_budget } %>

<!-- Recent Activity -->
<div class="mb-8 pb-6 border-b border-gray-100 dark:border-gray-800">
  <div class="flex items-center justify-between mb-2">
    <h2 class="text-sm font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wide">Recent Activity</h2>
    <%= link_to "View All →", ruby_llm_agents.executions_path, class: "text-sm text-gray-500 dark:text-gray-400 hover:text-gray-900 dark:hover:text-gray-100" %>
  </div>

  <% if @recent_executions.any? %>
    <table class="w-full text-sm">
      <thead>
        <tr class="text-left text-xs text-gray-400 dark:text-gray-500">
          <th class="py-2 font-medium">Agent</th>
          <th class="py-2 font-medium">Status</th>
          <th class="py-2 font-medium text-right">Duration</th>
          <th class="py-2 font-medium text-right">When</th>
        </tr>
      </thead>
      <tbody>
        <% @recent_executions.first(5).each do |execution| %>
          <tr class="border-t border-gray-100 dark:border-gray-800 hover:bg-gray-50 dark:hover:bg-gray-800/50 cursor-pointer"
              onclick="window.location='<%= ruby_llm_agents.execution_path(execution) %>'"
              <% if execution.status_error? && execution.error_message.present? %>title="<%= execution.error_class %>: <%= execution.error_message.truncate(100) %>"<% end %>>
            <td class="py-2.5 font-medium text-gray-900 dark:text-gray-100">
              <%= execution.agent_type.gsub(/Agent$/, '') %>
            </td>
            <td class="py-2.5">
              <%= render "ruby_llm/agents/shared/status_badge", status: execution.status, size: :sm %>
            </td>
            <td class="py-2.5 text-right text-gray-500 dark:text-gray-400">
              <% if execution.status_running? %>
                <span class="text-blue-500 animate-pulse">...</span>
              <% else %>
                <%= execution.duration_ms ? format_duration_ms(execution.duration_ms) : '-' %>
              <% end %>
            </td>
            <td class="py-2.5 text-right text-gray-400 dark:text-gray-500">
              <%= time_ago_in_words(execution.created_at) %>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
  <% else %>
    <p class="py-4 text-gray-400 dark:text-gray-500 text-sm">No executions yet</p>
  <% end %>
</div>

<!-- Performance + Top Errors -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8 pb-6 border-b border-gray-100 dark:border-gray-800">
  <!-- Performance -->
  <div>
    <h2 class="text-sm font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wide mb-2">Performance</h2>
    <%
      all_stats = [@agent_stats, @embedder_stats, @transcriber_stats, @speaker_stats, @image_generator_stats]
        .flatten.compact.select { |a| a[:executions].to_i > 0 }.sort_by { |a| -a[:executions].to_i }.first(8)
    %>
    <% if all_stats.any? %>
      <table class="w-full text-sm">
        <thead>
          <tr class="text-left text-xs text-gray-400 dark:text-gray-500">
            <th class="py-2 font-medium">Agent</th>
            <th class="py-2 font-medium text-right">Runs</th>
            <th class="py-2 font-medium text-right">Cost</th>
            <th class="py-2 font-medium text-right">Success</th>
          </tr>
        </thead>
        <tbody>
          <% all_stats.each do |item| %>
            <tr class="border-t border-gray-100 dark:border-gray-800">
              <td class="py-2 text-gray-900 dark:text-gray-100 truncate max-w-[140px]"><%= item[:agent_type].to_s.demodulize %></td>
              <td class="py-2 text-right text-gray-500 dark:text-gray-400"><%= number_with_delimiter(item[:executions]) %></td>
              <td class="py-2 text-right text-gray-500 dark:text-gray-400">$<%= number_with_precision(item[:total_cost], precision: 2) %></td>
              <td class="py-2 text-right">
                <span class="<%= item[:success_rate] >= 95 ? 'text-green-600 dark:text-green-400' : item[:success_rate] >= 80 ? 'text-yellow-600 dark:text-yellow-400' : 'text-red-600 dark:text-red-400' %>"><%= item[:success_rate].round %>%</span>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    <% else %>
      <p class="py-4 text-gray-400 dark:text-gray-500 text-sm">No data yet</p>
    <% end %>
  </div>

  <!-- Top Errors -->
  <div>
    <h2 class="text-sm font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wide mb-2">Top Errors</h2>
    <% if @top_errors.any? %>
      <table class="w-full text-sm">
        <thead>
          <tr class="text-left text-xs text-gray-400 dark:text-gray-500">
            <th class="py-2 font-medium">Error</th>
            <th class="py-2 font-medium text-right">Count</th>
            <th class="py-2 font-medium text-right">Last seen</th>
          </tr>
        </thead>
        <tbody>
          <% @top_errors.first(5).each do |error| %>
            <tr class="border-t border-gray-100 dark:border-gray-800">
              <td class="py-2 text-gray-900 dark:text-gray-100 truncate max-w-[180px]" title="<%= error[:error_class] %>"><%= error[:error_class].to_s.split("::").last %></td>
              <td class="py-2 text-right">
                <span class="text-red-600 dark:text-red-400 font-medium"><%= error[:count] %></span>
                <span class="text-gray-400 text-xs ml-1">(<%= error[:percentage] %>%)</span>
              </td>
              <td class="py-2 text-right text-gray-400 dark:text-gray-500"><%= error[:last_seen] ? time_ago_in_words(error[:last_seen]) : '-' %></td>
            </tr>
          <% end %>
        </tbody>
      </table>
    <% else %>
      <p class="py-4 text-green-600 dark:text-green-400 text-sm">✓ No errors</p>
    <% end %>
  </div>
</div>

<!-- Models -->
<div class="mb-6">
  <h2 class="text-sm font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wide mb-2">Models</h2>
  <% if @model_stats.any? %>
    <table class="w-full text-sm">
      <thead>
        <tr class="text-left text-xs text-gray-400 dark:text-gray-500">
          <th class="py-2 font-medium">Model</th>
          <th class="py-2 font-medium text-right">Runs</th>
          <th class="py-2 font-medium text-right">$/1K tok</th>
          <th class="py-2 font-medium text-right">Avg time</th>
          <th class="py-2 font-medium text-right">Success</th>
        </tr>
      </thead>
      <tbody>
        <% @model_stats.first(6).each do |model| %>
          <tr class="border-t border-gray-100 dark:border-gray-800">
            <td class="py-2 font-mono text-xs text-gray-900 dark:text-gray-100 truncate max-w-[140px]" title="<%= model[:model_id] %>"><%= model[:model_id].to_s.split('/').last.truncate(24) %></td>
            <td class="py-2 text-right text-gray-500 dark:text-gray-400"><%= number_with_delimiter(model[:executions]) %></td>
            <td class="py-2 text-right text-gray-500 dark:text-gray-400">$<%= number_with_precision(model[:cost_per_1k_tokens], precision: 4) %></td>
            <td class="py-2 text-right text-gray-500 dark:text-gray-400"><%= format_duration_ms(model[:avg_duration_ms]) %></td>
            <td class="py-2 text-right">
              <span class="<%= model[:success_rate] >= 95 ? 'text-green-600 dark:text-green-400' : model[:success_rate] >= 80 ? 'text-yellow-600 dark:text-yellow-400' : 'text-red-600 dark:text-red-400' %>"><%= model[:success_rate].round %>%</span>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
  <% else %>
    <p class="py-4 text-gray-400 dark:text-gray-500 text-sm">No model data yet</p>
  <% end %>
</div>
