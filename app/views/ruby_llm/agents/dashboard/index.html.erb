<!-- Action Center (only when critical alerts exist) -->
<%= render partial: "ruby_llm/agents/dashboard/action_center", locals: { critical_alerts: @critical_alerts } %>

<!-- Unified Metrics + Chart Component (Plausible-style) -->
<div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700 mb-6">
  <!-- Header with range picker -->
  <div class="px-6 py-4 border-b border-gray-100 dark:border-gray-700">
    <div class="flex items-center justify-between">
      <h3 class="text-lg font-semibold text-gray-900 dark:text-gray-100">Activity</h3>
      <div class="flex space-x-1 bg-gray-100 dark:bg-gray-700 rounded-lg p-1">
        <%= link_to "Today", ruby_llm_agents.root_path(range: "today"),
            class: "px-3 py-1 text-xs font-medium rounded-md transition-colors #{@selected_range == 'today' ? 'bg-white dark:bg-gray-600 text-gray-900 dark:text-white shadow-sm' : 'text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white'}" %>
        <%= link_to "7 Days", ruby_llm_agents.root_path(range: "7d"),
            class: "px-3 py-1 text-xs font-medium rounded-md transition-colors #{@selected_range == '7d' ? 'bg-white dark:bg-gray-600 text-gray-900 dark:text-white shadow-sm' : 'text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white'}" %>
        <%= link_to "30 Days", ruby_llm_agents.root_path(range: "30d"),
            class: "px-3 py-1 text-xs font-medium rounded-md transition-colors #{@selected_range == '30d' ? 'bg-white dark:bg-gray-600 text-gray-900 dark:text-white shadow-sm' : 'text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white'}" %>
      </div>
    </div>
  </div>

  <!-- Metric Row (Plausible-style: simple text, no cards) -->
  <div class="px-6 py-4 border-b border-gray-100 dark:border-gray-700">
    <div class="flex flex-wrap items-baseline gap-x-8 gap-y-2">
      <% metrics = [
        { key: "success", label: "SUCCESS", value: @now_strip[:success_today], change: @now_strip.dig(:comparisons, :success_change) },
        { key: "errors", label: "ERRORS", value: @now_strip[:errors_today], change: @now_strip.dig(:comparisons, :errors_change), is_error: @now_strip[:errors_today] > 0 },
        { key: "cost", label: "COST", value: "$#{number_with_precision(@now_strip[:cost_today], precision: 2)}", change: @now_strip.dig(:comparisons, :cost_change) },
        { key: "duration", label: "AVG TIME", value: format_duration_ms(@now_strip[:avg_duration_ms]), change: @now_strip.dig(:comparisons, :duration_change) },
        { key: "tokens", label: "TOKENS", value: number_to_human_short(@now_strip[:total_tokens]), change: @now_strip.dig(:comparisons, :tokens_change) }
      ] %>

      <% metrics.each_with_index do |metric, i| %>
        <button type="button"
                data-metric="<%= metric[:key] %>"
                data-index="<%= i %>"
                class="metric-btn group text-left transition-all <%= i == 0 ? 'border-b-2 border-indigo-500' : 'border-b-2 border-transparent hover:border-gray-300 dark:hover:border-gray-600' %>">
          <span class="text-xs font-medium tracking-wide text-gray-500 dark:text-gray-400 uppercase"><%= metric[:label] %></span>
          <div class="flex items-baseline gap-1">
            <span class="text-2xl font-bold <%= metric[:is_error] ? 'text-red-600 dark:text-red-400' : 'text-gray-900 dark:text-gray-100' %>"><%= metric[:value] %></span>
            <% if metric[:change] %>
              <span class="text-xs font-medium <%= metric[:change] > 0 ? (metric[:key].in?(%w[success tokens]) ? 'text-green-600' : 'text-red-600') : (metric[:key].in?(%w[success tokens]) ? 'text-red-600' : 'text-green-600') %>">
                <%= metric[:change] > 0 ? '+' : '' %><%= metric[:change] %>%
              </span>
            <% end %>
          </div>
        </button>
      <% end %>
    </div>
  </div>

  <!-- Chart -->
  <div id="activity-chart-container" class="px-4 py-2 h-[250px]">
    <div id="activity-chart" style="width: 100%; height: 100%;"></div>
  </div>

  <script>
    (function() {
      const range = '<%= @selected_range %>';
      const chartUrl = '<%= ruby_llm_agents.chart_data_path %>?range=' + range;
      const hourMs = 3600000;
      const dayMs = 24 * hourMs;

      let chartData = null;
      let chart = null;
      let selectedMetric = 0;

      const metricConfig = [
        { name: 'Success', color: '#6366F1' },
        { name: 'Errors', color: '#6366F1' },
        { name: 'Cost', color: '#6366F1', isCurrency: true },
        { name: 'Duration', color: '#6366F1', isDuration: true },
        { name: 'Tokens', color: '#6366F1' }
      ];

      function convertToDatetimePoints(data, range) {
        const now = Date.now();
        const numPoints = data.length;
        if (range === 'today') {
          return data.map((val, i) => [now - (numPoints - 1 - i) * hourMs, val]);
        } else {
          return data.map((val, i) => [now - (numPoints - 1 - i) * dayMs, val]);
        }
      }

      function formatNumber(num) {
        return num.toLocaleString();
      }

      function formatDuration(ms) {
        if (!ms || ms === 0) return '0ms';
        if (ms < 1000) return ms.toFixed(0) + 'ms';
        if (ms < 60000) return (ms / 1000).toFixed(1) + 's';
        return (ms / 60000).toFixed(1) + 'm';
      }

      function updateChart(metricIndex) {
        if (!chartData || !chart) return;

        const config = metricConfig[metricIndex];
        const series = chartData.series[metricIndex];

        chart.series[0].update({
          name: config.name,
          data: convertToDatetimePoints(series.data, range),
          color: config.color
        }, false);

        chart.yAxis[0].update({
          labels: {
            style: { color: '#9CA3AF' },
            formatter: function() {
              if (config.isCurrency) return '$' + this.value;
              if (config.isDuration) return formatDuration(this.value);
              return this.value;
            }
          }
        }, false);

        chart.tooltip.update({
          formatter: function() {
            const dateFormat = range === 'today' ? '%H:%M' : '%b %d';
            const dateStr = Highcharts.dateFormat(dateFormat, this.x);
            let valueStr;
            if (config.isCurrency) valueStr = '$' + this.y.toFixed(4);
            else if (config.isDuration) valueStr = formatDuration(this.y);
            else valueStr = formatNumber(this.y);
            return '<b>' + dateStr + '</b><br/>' + config.name + ': ' + valueStr;
          }
        });

        chart.redraw();

        // Update selection styles
        document.querySelectorAll('.metric-btn').forEach((btn, i) => {
          btn.classList.remove('border-indigo-500', 'border-transparent');
          btn.classList.add(i === metricIndex ? 'border-indigo-500' : 'border-transparent');
        });
      }

      function initChart() {
        fetch(chartUrl)
          .then(res => res.json())
          .then(data => {
            chartData = data;
            const config = metricConfig[0];
            const timeRange = range === 'today' ? dayMs : (range === '7d' ? 7 * dayMs : 30 * dayMs);
            const dateFormat = range === 'today' ? '%H:%M' : '%b %d';
            const now = Date.now();

            chart = Highcharts.chart('activity-chart', {
              chart: { type: 'areaspline', backgroundColor: 'transparent', spacing: [10, 0, 10, 0] },
              title: { text: null },
              xAxis: {
                type: 'datetime',
                min: now - timeRange,
                max: now,
                labels: { style: { color: '#9CA3AF', fontSize: '11px' }, format: '{value:' + dateFormat + '}' },
                lineColor: 'transparent',
                tickLength: 0
              },
              yAxis: {
                title: { text: null },
                min: 0,
                allowDecimals: false,
                labels: { style: { color: '#9CA3AF', fontSize: '11px' } },
                gridLineColor: 'rgba(156, 163, 175, 0.15)'
              },
              legend: { enabled: false },
              credits: { enabled: false },
              tooltip: {
                backgroundColor: 'rgba(17, 24, 39, 0.95)',
                borderColor: 'transparent',
                borderRadius: 8,
                style: { color: '#F3F4F6', fontSize: '12px' },
                formatter: function() {
                  return '<b>' + Highcharts.dateFormat(dateFormat, this.x) + '</b><br/>' +
                    config.name + ': ' + formatNumber(this.y);
                }
              },
              plotOptions: {
                areaspline: {
                  fillColor: {
                    linearGradient: { x1: 0, y1: 0, x2: 0, y2: 1 },
                    stops: [[0, 'rgba(99, 102, 241, 0.3)'], [1, 'rgba(99, 102, 241, 0)']]
                  },
                  lineWidth: 2,
                  marker: { enabled: false, states: { hover: { enabled: true, radius: 4 } } }
                }
              },
              series: [{
                name: config.name,
                data: convertToDatetimePoints(data.series[0].data, range),
                color: config.color
              }]
            });
          })
          .catch(err => console.log('[RubyLLM::Agents] Chart error:', err));

        document.querySelectorAll('.metric-btn').forEach(btn => {
          btn.addEventListener('click', function() {
            const index = parseInt(this.dataset.index);
            selectedMetric = index;
            updateChart(index);
          });
        });
      }

      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initChart);
      } else {
        initChart();
      }
    })();
  </script>
</div>

<!-- Tenant Budget (when viewing specific tenant) -->
<%= render partial: "ruby_llm/agents/dashboard/tenant_budget", locals: { tenant_budget: @tenant_budget } %>

<!-- Live Activity Feed -->
<div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700 mb-6">
  <div class="px-6 py-3 border-b border-gray-100 dark:border-gray-700">
    <div class="flex justify-between items-center">
      <h3 class="text-base font-semibold text-gray-900 dark:text-gray-100">Recent Activity</h3>
      <%= link_to "View All", ruby_llm_agents.executions_path, class: "text-blue-600 dark:text-blue-400 hover:text-blue-700 dark:hover:text-blue-300 text-sm font-medium" %>
    </div>
  </div>
  <div id="activity-feed" class="px-6 py-2">
    <% if @recent_executions.any? %>
      <% @recent_executions.first(5).each do |execution| %>
        <%= render partial: "ruby_llm/agents/dashboard/execution_item", locals: { execution: execution } %>
      <% end %>
    <% else %>
      <div class="py-8 text-center text-gray-500 dark:text-gray-400">
        <p class="text-sm">No executions yet</p>
      </div>
    <% end %>
  </div>
</div>

<!-- Agent Comparison + Top Errors -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
  <%= render partial: "ruby_llm/agents/dashboard/agent_comparison", locals: { agent_stats: @agent_stats } %>
  <%= render partial: "ruby_llm/agents/dashboard/top_errors", locals: { top_errors: @top_errors } %>
</div>
