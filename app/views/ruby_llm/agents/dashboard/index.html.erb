<!-- Page Header -->
<div class="mb-6">
  <div class="flex items-center gap-2">
    <h1 class="text-2xl font-bold text-gray-900 dark:text-gray-100">Dashboard</h1>
    <%= render "ruby_llm/agents/shared/doc_link" %>
  </div>
</div>

<!-- Action Center (only when critical alerts exist) -->
<%= render partial: "ruby_llm/agents/dashboard/action_center", locals: { critical_alerts: @critical_alerts } %>

<!-- Activity Card -->
<div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700 mb-6">
  <!-- Header with inline metrics and range picker -->
  <div class="px-5 py-3 border-b border-gray-100 dark:border-gray-700">
    <div class="flex items-center justify-between">
      <div class="flex items-center gap-4">
        <h3 class="text-base font-semibold text-gray-900 dark:text-gray-100">Activity</h3>
        <div class="flex items-center gap-3 text-sm">
          <% total = @now_strip[:success_today] + @now_strip[:errors_today] %>
          <span class="text-gray-700 dark:text-gray-300">
            <span class="font-semibold"><%= number_with_delimiter(total) %></span> runs
          </span>
          <span class="text-gray-300 dark:text-gray-600">·</span>
          <span class="<%= @now_strip[:errors_today] > 0 ? 'text-red-600 dark:text-red-400' : 'text-gray-700 dark:text-gray-300' %>">
            <span class="font-semibold"><%= @now_strip[:errors_today] %></span> errors<% if total > 0 && @now_strip[:errors_today] > 0 %> (<%= (@now_strip[:errors_today].to_f / total * 100).round(1) %>%)<% end %>
          </span>
          <span class="text-gray-300 dark:text-gray-600">·</span>
          <span class="text-gray-700 dark:text-gray-300">
            <span class="font-semibold">$<%= number_with_precision(@now_strip[:cost_today], precision: 2) %></span>
          </span>
        </div>
      </div>
      <div class="flex space-x-1 bg-gray-100 dark:bg-gray-700 rounded-lg p-1">
        <%= link_to "Today", ruby_llm_agents.root_path(range: "today"),
            class: "px-2.5 py-1 text-xs font-medium rounded-md transition-colors #{@selected_range == 'today' ? 'bg-white dark:bg-gray-600 text-gray-900 dark:text-white shadow-sm' : 'text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white'}" %>
        <%= link_to "7d", ruby_llm_agents.root_path(range: "7d"),
            class: "px-2.5 py-1 text-xs font-medium rounded-md transition-colors #{@selected_range == '7d' ? 'bg-white dark:bg-gray-600 text-gray-900 dark:text-white shadow-sm' : 'text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white'}" %>
        <%= link_to "30d", ruby_llm_agents.root_path(range: "30d"),
            class: "px-2.5 py-1 text-xs font-medium rounded-md transition-colors #{@selected_range == '30d' ? 'bg-white dark:bg-gray-600 text-gray-900 dark:text-white shadow-sm' : 'text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white'}" %>
      </div>
    </div>
  </div>

  <!-- Chart (stacked success/errors) -->
  <div id="activity-chart-container" class="px-4 py-3">
    <div id="activity-chart" style="width: 100%; height: 180px;"></div>
  </div>

  <script>
    (function() {
      const range = '<%= @selected_range %>';
      const chartUrl = '<%= ruby_llm_agents.chart_data_path %>?range=' + range;
      const hourMs = 3600000;
      const dayMs = 24 * hourMs;

      function getTimeRangeMs(range) {
        if (range === 'today') return dayMs;
        if (range === '7d') return 7 * dayMs;
        if (range === '30d') return 30 * dayMs;
        return dayMs;
      }

      function convertToDatetimePoints(data, range) {
        const now = Date.now();
        const numPoints = data.length;
        if (range === 'today') {
          return data.map((val, i) => [now - (numPoints - 1 - i) * hourMs, val]);
        } else {
          return data.map((val, i) => [now - (numPoints - 1 - i) * dayMs, val]);
        }
      }

      function initChart() {
        fetch(chartUrl)
          .then(res => res.json())
          .then(data => {
            const timeRange = getTimeRangeMs(range);
            const dateFormat = range === 'today' ? '%H:%M' : '%b %d';
            const now = Date.now();

            Highcharts.chart('activity-chart', {
              chart: {
                type: 'areaspline',
                backgroundColor: 'transparent',
                spacing: [10, 0, 10, 0]
              },
              title: { text: null },
              xAxis: {
                type: 'datetime',
                min: now - timeRange,
                max: now,
                labels: {
                  style: { color: '#9CA3AF', fontSize: '11px' },
                  format: '{value:' + dateFormat + '}'
                },
                lineColor: 'transparent',
                tickLength: 0
              },
              yAxis: {
                title: { text: null },
                min: 0,
                allowDecimals: false,
                labels: { style: { color: '#9CA3AF', fontSize: '11px' } },
                gridLineColor: 'rgba(156, 163, 175, 0.15)',
                stackLabels: { enabled: false }
              },
              legend: { enabled: false },
              credits: { enabled: false },
              tooltip: {
                backgroundColor: 'rgba(17, 24, 39, 0.95)',
                borderColor: 'transparent',
                borderRadius: 8,
                style: { color: '#F3F4F6', fontSize: '12px' },
                shared: true,
                formatter: function() {
                  const dateStr = Highcharts.dateFormat(dateFormat, this.x);
                  let html = '<b>' + dateStr + '</b>';
                  this.points.forEach(function(point) {
                    html += '<br/>' + point.series.name + ': ' + point.y;
                  });
                  return html;
                }
              },
              plotOptions: {
                areaspline: {
                  stacking: 'normal',
                  lineWidth: 2,
                  marker: { enabled: false, states: { hover: { enabled: true, radius: 4 } } }
                }
              },
              series: [
                {
                  name: 'Errors',
                  data: convertToDatetimePoints(data.series[1].data, range),
                  color: '#EF4444',
                  fillColor: {
                    linearGradient: { x1: 0, y1: 0, x2: 0, y2: 1 },
                    stops: [[0, 'rgba(239, 68, 68, 0.3)'], [1, 'rgba(239, 68, 68, 0)']]
                  }
                },
                {
                  name: 'Success',
                  data: convertToDatetimePoints(data.series[0].data, range),
                  color: '#10B981',
                  fillColor: {
                    linearGradient: { x1: 0, y1: 0, x2: 0, y2: 1 },
                    stops: [[0, 'rgba(16, 185, 129, 0.3)'], [1, 'rgba(16, 185, 129, 0)']]
                  }
                }
              ]
            });
          })
          .catch(err => console.log('[RubyLLM::Agents] Chart error:', err));
      }

      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initChart);
      } else {
        initChart();
      }
    })();
  </script>
</div>

<!-- Tenant Budget (when viewing specific tenant) -->
<%= render partial: "ruby_llm/agents/dashboard/tenant_budget", locals: { tenant_budget: @tenant_budget } %>

<!-- Recent Activity Table -->
<div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700 mb-6">
  <div class="px-6 py-3 border-b border-gray-100 dark:border-gray-700">
    <div class="flex justify-between items-center">
      <h3 class="text-base font-semibold text-gray-900 dark:text-gray-100">Recent Activity</h3>
      <%= link_to "View All", ruby_llm_agents.executions_path, class: "text-blue-600 dark:text-blue-400 hover:text-blue-700 dark:hover:text-blue-300 text-sm font-medium" %>
    </div>
  </div>

  <% if @recent_executions.any? %>
    <div class="overflow-x-auto">
      <table class="w-full text-sm">
        <thead>
          <tr class="text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider border-b border-gray-100 dark:border-gray-700">
            <th class="px-4 py-3">Agent</th>
            <th class="px-4 py-3">Status</th>
            <th class="px-4 py-3 text-right">Duration</th>
            <th class="px-4 py-3 text-right">When</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-gray-100 dark:divide-gray-700">
          <% @recent_executions.first(5).each do |execution| %>
            <tr class="hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors cursor-pointer"
                onclick="window.location='<%= ruby_llm_agents.execution_path(execution) %>'"
                <% if execution.status_error? && execution.error_message.present? %>
                  title="<%= execution.error_class %>: <%= execution.error_message.truncate(100) %>"
                <% end %>>
              <td class="px-4 py-3">
                <span class="font-medium text-gray-900 dark:text-gray-100">
                  <%= execution.agent_type.gsub(/Agent$/, '') %>
                </span>
              </td>
              <td class="px-4 py-3">
                <%= render "ruby_llm/agents/shared/status_badge", status: execution.status, size: :sm %>
              </td>
              <td class="px-4 py-3 text-right text-gray-600 dark:text-gray-300">
                <% if execution.status_running? %>
                  <span class="text-blue-500 dark:text-blue-400 animate-pulse">...</span>
                <% else %>
                  <%= execution.duration_ms ? format_duration_ms(execution.duration_ms) : '-' %>
                <% end %>
              </td>
              <td class="px-4 py-3 text-right text-gray-500 dark:text-gray-400 whitespace-nowrap">
                <%= time_ago_in_words(execution.created_at) %> ago
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>
  <% else %>
    <div class="py-8 text-center text-gray-500 dark:text-gray-400">
      <p class="text-sm">No executions yet</p>
    </div>
  <% end %>
</div>

<!-- Performance + Top Errors -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
  <%= render partial: "ruby_llm/agents/dashboard/agent_comparison", locals: { agent_stats: @agent_stats } %>
  <%= render partial: "ruby_llm/agents/dashboard/top_errors", locals: { top_errors: @top_errors } %>
</div>

<!-- Model Performance -->
<%= render partial: "ruby_llm/agents/dashboard/model_comparison", locals: { model_stats: @model_stats } %>
