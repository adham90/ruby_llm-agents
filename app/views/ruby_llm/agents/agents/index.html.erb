<div class="mb-6">
  <h1 class="text-2xl font-bold text-gray-900 dark:text-gray-100">Agents</h1>
  <p class="text-gray-500 dark:text-gray-400 mt-1">All available agents with execution statistics</p>
</div>

<div x-data="{
  activeSubTab: <%= params[:subtab].present? ? "'#{params[:subtab]}'" : 'null' %>,
  updateUrl() {
    const url = new URL(window.location);
    if (this.activeSubTab) {
      url.searchParams.set('subtab', this.activeSubTab);
    } else {
      url.searchParams.delete('subtab');
    }
    history.replaceState({}, '', url);
  }
}">
  <!-- Agent Sub-tabs -->
  <div class="mb-4">
    <div class="flex flex-wrap gap-2">
      <button type="button" @click="activeSubTab = null; updateUrl()"
              :class="activeSubTab === null ? 'bg-gray-900 dark:bg-gray-100 text-white dark:text-gray-900' : 'bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-600'"
              class="px-3 py-1.5 rounded-md text-sm font-medium transition-colors">
        All (<%= @agent_count %>)
      </button>
      <button type="button" @click="activeSubTab = 'agent'; updateUrl()"
              :class="activeSubTab === 'agent' ? 'bg-blue-600 text-white' : 'bg-blue-100 dark:bg-blue-900/50 text-blue-700 dark:text-blue-300 hover:bg-blue-200 dark:hover:bg-blue-800'"
              class="px-3 py-1.5 rounded-md text-sm font-medium transition-colors">
        Agents (<%= @agents_by_type[:agent].size %>)
      </button>
      <button type="button" @click="activeSubTab = 'embedder'; updateUrl()"
              :class="activeSubTab === 'embedder' ? 'bg-purple-600 text-white' : 'bg-purple-100 dark:bg-purple-900/50 text-purple-700 dark:text-purple-300 hover:bg-purple-200 dark:hover:bg-purple-800'"
              class="px-3 py-1.5 rounded-md text-sm font-medium transition-colors">
        Embedders (<%= @agents_by_type[:embedder].size %>)
      </button>
      <button type="button" @click="activeSubTab = 'moderator'; updateUrl()"
              :class="activeSubTab === 'moderator' ? 'bg-orange-600 text-white' : 'bg-orange-100 dark:bg-orange-900/50 text-orange-700 dark:text-orange-300 hover:bg-orange-200 dark:hover:bg-orange-800'"
              class="px-3 py-1.5 rounded-md text-sm font-medium transition-colors">
        Moderators (<%= @agents_by_type[:moderator].size %>)
      </button>
      <% audio_count = @agents_by_type[:speaker].size + @agents_by_type[:transcriber].size %>
      <% if audio_count > 0 %>
        <button type="button" @click="activeSubTab = 'audio'; updateUrl()"
                :class="activeSubTab === 'audio' ? 'bg-pink-600 text-white' : 'bg-pink-100 dark:bg-pink-900/50 text-pink-700 dark:text-pink-300 hover:bg-pink-200 dark:hover:bg-pink-800'"
                class="px-3 py-1.5 rounded-md text-sm font-medium transition-colors">
          Audio (<%= audio_count %>)
        </button>
      <% end %>
      <% if @agents_by_type[:image_generator].size > 0 %>
        <button type="button" @click="activeSubTab = 'image_generator'; updateUrl()"
                :class="activeSubTab === 'image_generator' ? 'bg-teal-600 text-white' : 'bg-teal-100 dark:bg-teal-900/50 text-teal-700 dark:text-teal-300 hover:bg-teal-200 dark:hover:bg-teal-800'"
                class="px-3 py-1.5 rounded-md text-sm font-medium transition-colors">
          Image Generators (<%= @agents_by_type[:image_generator].size %>)
        </button>
      <% end %>
    </div>
  </div>

  <!-- Agents Content -->
  <% if @agents.empty? %>
    <%= render "ruby_llm/agents/agents/empty_state", type: "agents" %>
  <% else %>
    <div class="space-y-3 sm:space-y-4">
      <% @agents.each do |agent| %>
        <%
          # Determine if this agent should be shown based on sub-tab
          # 'audio' sub-tab shows both speakers and transcribers
          show_condition = if agent[:agent_type] == 'speaker' || agent[:agent_type] == 'transcriber'
            "activeSubTab === null || activeSubTab === 'audio' || activeSubTab === '#{agent[:agent_type]}'"
          else
            "activeSubTab === null || activeSubTab === '#{agent[:agent_type]}'"
          end
        %>
        <div x-show="<%= show_condition %>">
          <%= render partial: "ruby_llm/agents/agents/agent", locals: { agent: agent, current_subtab: params[:subtab] } %>
        </div>
      <% end %>
    </div>
  <% end %>
</div>
