<div class="mb-6">
  <h1 class="text-2xl font-bold text-gray-900 dark:text-gray-100">Agents</h1>
  <p class="text-gray-500 dark:text-gray-400 mt-1">All available agents with execution statistics</p>
</div>

<%
  audio_count = @agents_by_type[:speaker].size + @agents_by_type[:transcriber].size
%>
<div x-data="{
  activeSubTab: <%= params[:subtab].present? ? "'#{params[:subtab]}'" : 'null' %>,
  counts: {
    all: <%= @agent_count %>,
    agent: <%= @agents_by_type[:agent].size %>,
    embedder: <%= @agents_by_type[:embedder].size %>,
    moderator: <%= @agents_by_type[:moderator].size %>,
    speaker: <%= @agents_by_type[:speaker].size %>,
    transcriber: <%= @agents_by_type[:transcriber].size %>,
    audio: <%= audio_count %>,
    image_generator: <%= @agents_by_type[:image_generator].size %>,
    deleted: <%= @deleted_count %>
  },
  get currentCount() {
    if (this.activeSubTab === null) return this.counts.all;
    if (this.activeSubTab === 'audio') return this.counts.audio;
    return this.counts[this.activeSubTab] || 0;
  },
  updateUrl() {
    const url = new URL(window.location);
    if (this.activeSubTab) {
      url.searchParams.set('subtab', this.activeSubTab);
    } else {
      url.searchParams.delete('subtab');
    }
    history.replaceState({}, '', url);
  }
}">
  <!-- Agent Sub-tabs -->
  <div class="mb-4">
    <div class="flex flex-wrap gap-2">
      <button type="button" @click="activeSubTab = null; updateUrl()"
              :class="activeSubTab === null ? 'bg-gray-900 dark:bg-gray-100 text-white dark:text-gray-900' : 'bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-600'"
              class="px-3 py-1.5 rounded-md text-sm font-medium transition-colors">
        All (<%= @agent_count %>)
      </button>
      <button type="button" @click="activeSubTab = 'agent'; updateUrl()"
              :class="activeSubTab === 'agent' ? 'bg-blue-600 text-white' : 'bg-blue-100 dark:bg-blue-900/50 text-blue-700 dark:text-blue-300 hover:bg-blue-200 dark:hover:bg-blue-800'"
              class="px-3 py-1.5 rounded-md text-sm font-medium transition-colors">
        Agents (<%= @agents_by_type[:agent].size %>)
      </button>
      <button type="button" @click="activeSubTab = 'embedder'; updateUrl()"
              :class="activeSubTab === 'embedder' ? 'bg-purple-600 text-white' : 'bg-purple-100 dark:bg-purple-900/50 text-purple-700 dark:text-purple-300 hover:bg-purple-200 dark:hover:bg-purple-800'"
              class="px-3 py-1.5 rounded-md text-sm font-medium transition-colors">
        Embedders (<%= @agents_by_type[:embedder].size %>)
      </button>
      <button type="button" @click="activeSubTab = 'moderator'; updateUrl()"
              :class="activeSubTab === 'moderator' ? 'bg-orange-600 text-white' : 'bg-orange-100 dark:bg-orange-900/50 text-orange-700 dark:text-orange-300 hover:bg-orange-200 dark:hover:bg-orange-800'"
              class="px-3 py-1.5 rounded-md text-sm font-medium transition-colors">
        Moderators (<%= @agents_by_type[:moderator].size %>)
      </button>
      <% if audio_count > 0 %>
        <button type="button" @click="activeSubTab = 'audio'; updateUrl()"
                :class="activeSubTab === 'audio' ? 'bg-pink-600 text-white' : 'bg-pink-100 dark:bg-pink-900/50 text-pink-700 dark:text-pink-300 hover:bg-pink-200 dark:hover:bg-pink-800'"
                class="px-3 py-1.5 rounded-md text-sm font-medium transition-colors">
          Audio (<%= audio_count %>)
        </button>
      <% end %>
      <% if @agents_by_type[:image_generator].size > 0 %>
        <button type="button" @click="activeSubTab = 'image_generator'; updateUrl()"
                :class="activeSubTab === 'image_generator' ? 'bg-teal-600 text-white' : 'bg-teal-100 dark:bg-teal-900/50 text-teal-700 dark:text-teal-300 hover:bg-teal-200 dark:hover:bg-teal-800'"
                class="px-3 py-1.5 rounded-md text-sm font-medium transition-colors">
          Image Generators (<%= @agents_by_type[:image_generator].size %>)
        </button>
      <% end %>
      <% if @deleted_count > 0 %>
        <button type="button" @click="activeSubTab = 'deleted'; updateUrl()"
                :class="activeSubTab === 'deleted' ? 'bg-gray-600 text-white' : 'bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-600'"
                class="px-3 py-1.5 rounded-md text-sm font-medium transition-colors">
          Deleted (<%= @deleted_count %>)
        </button>
      <% end %>
    </div>
  </div>

  <!-- Agents Table -->
  <% if @agents.empty? && @deleted_agents.empty? %>
    <%= render "ruby_llm/agents/agents/empty_state", type: "agents" %>
  <% else %>
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow overflow-hidden">
      <div class="overflow-x-auto">
        <table class="w-full divide-y divide-gray-200 dark:divide-gray-700">
          <thead class="bg-gray-50 dark:bg-gray-900">
            <tr>
              <%= render "ruby_llm/agents/agents/sortable_header",
                  column: "name", label: "Name",
                  current_sort: @sort_params[:column], current_direction: @sort_params[:direction] %>

              <%= render "ruby_llm/agents/agents/sortable_header",
                  column: "agent_type", label: "Type",
                  current_sort: @sort_params[:column], current_direction: @sort_params[:direction] %>

              <th scope="col" class="px-4 py-3 text-left text-xs font-semibold uppercase tracking-wider text-gray-500 dark:text-gray-400">
                Status
              </th>

              <%= render "ruby_llm/agents/agents/sortable_header",
                  column: "model", label: "Model",
                  current_sort: @sort_params[:column], current_direction: @sort_params[:direction],
                  th_class: "hidden lg:table-cell" %>

              <%= render "ruby_llm/agents/agents/sortable_header",
                  column: "execution_count", label: "Executions",
                  current_sort: @sort_params[:column], current_direction: @sort_params[:direction] %>

              <%= render "ruby_llm/agents/agents/sortable_header",
                  column: "total_cost", label: "Cost",
                  current_sort: @sort_params[:column], current_direction: @sort_params[:direction],
                  th_class: "hidden md:table-cell" %>

              <%= render "ruby_llm/agents/agents/sortable_header",
                  column: "success_rate", label: "Success",
                  current_sort: @sort_params[:column], current_direction: @sort_params[:direction] %>

              <%= render "ruby_llm/agents/agents/sortable_header",
                  column: "last_executed", label: "Last Run",
                  current_sort: @sort_params[:column], current_direction: @sort_params[:direction] %>
            </tr>
          </thead>

          <tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-100/50 dark:divide-gray-700/50">
            <% @agents.each_with_index do |agent, index| %>
              <%
                # Determine if this agent should be shown based on sub-tab (exclude deleted tab)
                show_condition = if agent[:agent_type] == 'speaker' || agent[:agent_type] == 'transcriber'
                  "activeSubTab !== 'deleted' && (activeSubTab === null || activeSubTab === 'audio' || activeSubTab === '#{agent[:agent_type]}')"
                else
                  "activeSubTab !== 'deleted' && (activeSubTab === null || activeSubTab === '#{agent[:agent_type]}')"
                end
                row_bg = index.even? ? '' : 'bg-gray-50/50 dark:bg-gray-900/30'
                success_rate = agent[:success_rate] || 0
              %>
              <tr
                x-show="<%= show_condition %>"
                class="<%= row_bg %> hover:bg-blue-50/50 dark:hover:bg-blue-900/20 transition-colors cursor-pointer"
                onclick="window.location='<%= ruby_llm_agents.agent_path(ERB::Util.url_encode(agent[:name]), subtab: params[:subtab]) %>'"
              >
                <!-- Name -->
                <td class="px-4 py-3">
                  <div class="flex items-center gap-2">
                    <span class="text-sm font-medium text-gray-900 dark:text-gray-100">
                      <%= agent[:name].split('::').last.gsub(/Agent$/, '') %>
                    </span>
                    <span class="hidden lg:inline text-xs text-gray-400 dark:text-gray-500">v<%= agent[:version] %></span>
                  </div>
                  <% if agent[:description].present? %>
                    <p class="text-xs text-gray-500 dark:text-gray-400 truncate max-w-64 mt-0.5" title="<%= agent[:description] %>">
                      <%= agent[:description] %>
                    </p>
                  <% end %>
                </td>

                <!-- Type -->
                <td class="px-4 py-3 whitespace-nowrap">
                  <span class="text-sm text-gray-600 dark:text-gray-400">
                    <%= agent[:agent_type]&.titleize || 'Agent' %>
                  </span>
                </td>

                <!-- Status -->
                <td class="px-4 py-3 whitespace-nowrap">
                  <% if agent[:active] %>
                    <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-green-100 dark:bg-green-900/50 text-green-800 dark:text-green-300">
                      Active
                    </span>
                  <% else %>
                    <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-400">
                      Deleted
                    </span>
                  <% end %>
                </td>

                <!-- Model -->
                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400 hidden lg:table-cell">
                  <span title="<%= agent[:model] %>">
                    <%= agent[:model]&.split("/")&.last || agent[:model] || "-" %>
                  </span>
                </td>

                <!-- Executions -->
                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700 dark:text-gray-300 font-mono">
                  <%= number_with_delimiter(agent[:execution_count] || 0) %>
                </td>

                <!-- Cost -->
                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700 dark:text-gray-300 font-mono hidden md:table-cell">
                  $<%= number_with_precision(agent[:total_cost] || 0, precision: 4) %>
                </td>

                <!-- Success Rate -->
                <td class="px-4 py-3 whitespace-nowrap">
                  <div class="flex items-center gap-1.5">
                    <% if success_rate >= 95 %>
                      <span class="w-2 h-2 rounded-full bg-green-500"></span>
                      <span class="text-sm text-green-600 dark:text-green-400"><%= success_rate %>%</span>
                    <% elsif success_rate >= 80 %>
                      <span class="w-2 h-2 rounded-full bg-yellow-500"></span>
                      <span class="text-sm text-yellow-600 dark:text-yellow-400"><%= success_rate %>%</span>
                    <% else %>
                      <span class="w-2 h-2 rounded-full bg-red-500"></span>
                      <span class="text-sm text-red-600 dark:text-red-400"><%= success_rate %>%</span>
                    <% end %>
                  </div>
                </td>

                <!-- Last Executed -->
                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">
                  <% if agent[:last_executed] %>
                    <%= time_ago_in_words(agent[:last_executed]) %> ago
                  <% else %>
                    <span class="text-gray-400 dark:text-gray-500">Never</span>
                  <% end %>
                </td>
              </tr>
            <% end %>

            <!-- Deleted Agents -->
            <% @deleted_agents.each_with_index do |agent, index| %>
              <%
                row_bg = index.even? ? '' : 'bg-gray-50/50 dark:bg-gray-900/30'
                success_rate = agent[:success_rate] || 0
              %>
              <tr
                x-show="activeSubTab === 'deleted'"
                class="<%= row_bg %> hover:bg-blue-50/50 dark:hover:bg-blue-900/20 transition-colors cursor-pointer"
                onclick="window.location='<%= ruby_llm_agents.agent_path(ERB::Util.url_encode(agent[:name]), subtab: params[:subtab]) %>'"
              >
                <!-- Name -->
                <td class="px-4 py-3">
                  <div class="flex items-center gap-2">
                    <span class="text-sm font-medium text-gray-900 dark:text-gray-100">
                      <%= agent[:name].split('::').last.gsub(/Agent$/, '') %>
                    </span>
                    <span class="hidden lg:inline text-xs text-gray-400 dark:text-gray-500">v<%= agent[:version] %></span>
                  </div>
                  <% if agent[:description].present? %>
                    <p class="text-xs text-gray-500 dark:text-gray-400 truncate max-w-48 mt-0.5" title="<%= agent[:description] %>">
                      <%= agent[:description] %>
                    </p>
                  <% end %>
                </td>

                <!-- Type -->
                <td class="px-4 py-3 whitespace-nowrap">
                  <span class="text-sm text-gray-600 dark:text-gray-400">
                    <%= agent[:agent_type]&.titleize || 'Agent' %>
                  </span>
                </td>

                <!-- Status -->
                <td class="px-4 py-3 whitespace-nowrap">
                  <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-400">
                    Deleted
                  </span>
                </td>

                <!-- Model -->
                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400 hidden lg:table-cell">
                  <span title="<%= agent[:model] %>">
                    <%= agent[:model]&.split("/")&.last || agent[:model] || "-" %>
                  </span>
                </td>

                <!-- Executions -->
                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700 dark:text-gray-300 font-mono">
                  <%= number_with_delimiter(agent[:execution_count] || 0) %>
                </td>

                <!-- Cost -->
                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700 dark:text-gray-300 font-mono hidden md:table-cell">
                  $<%= number_with_precision(agent[:total_cost] || 0, precision: 4) %>
                </td>

                <!-- Success Rate -->
                <td class="px-4 py-3 whitespace-nowrap">
                  <div class="flex items-center gap-1.5">
                    <% if success_rate >= 95 %>
                      <span class="w-2 h-2 rounded-full bg-green-500"></span>
                      <span class="text-sm text-green-600 dark:text-green-400"><%= success_rate %>%</span>
                    <% elsif success_rate >= 80 %>
                      <span class="w-2 h-2 rounded-full bg-yellow-500"></span>
                      <span class="text-sm text-yellow-600 dark:text-yellow-400"><%= success_rate %>%</span>
                    <% else %>
                      <span class="w-2 h-2 rounded-full bg-red-500"></span>
                      <span class="text-sm text-red-600 dark:text-red-400"><%= success_rate %>%</span>
                    <% end %>
                  </div>
                </td>

                <!-- Last Executed -->
                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">
                  <% if agent[:last_executed] %>
                    <%= time_ago_in_words(agent[:last_executed]) %> ago
                  <% else %>
                    <span class="text-gray-400 dark:text-gray-500">Never</span>
                  <% end %>
                </td>
              </tr>
            <% end %>

            <!-- Empty State -->
            <tr x-show="currentCount === 0" x-cloak>
              <td colspan="8" class="px-6 py-12 text-center">
                <div class="text-gray-400 dark:text-gray-500">
                  <svg class="mx-auto h-12 w-12 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                  </svg>
                  <p class="text-lg font-medium text-gray-500 dark:text-gray-400">No agents in this category</p>
                  <p class="text-sm mt-1">Try selecting a different filter</p>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  <% end %>
</div>
