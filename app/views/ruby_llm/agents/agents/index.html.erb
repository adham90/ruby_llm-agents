<%
  audio_count = @agents_by_type[:speaker].size + @agents_by_type[:transcriber].size
  sc = @sort_params[:column]
  sd = @sort_params[:direction]
  sort_url = ->(col) {
    dir = (col == sc && sd == "asc") ? "desc" : "asc"
    url_for(request.query_parameters.merge(sort: col, direction: dir))
  }
  sort_active = ->(col) { col == sc ? "text-gray-600 dark:text-gray-300" : "" }
  sort_arrow = ->(col) { col == sc ? (sd == "asc" ? " ↑" : " ↓") : "" }
%>
<div x-data="{
  activeSubTab: <%= params[:subtab].present? ? "'#{params[:subtab]}'" : 'null' %>,
  counts: {
    all: <%= @agent_count %>,
    agent: <%= @agents_by_type[:agent].size %>,
    embedder: <%= @agents_by_type[:embedder].size %>,
    audio: <%= audio_count %>,
    image_generator: <%= @agents_by_type[:image_generator].size %>,
    deleted: <%= @deleted_count %>
  },
  get currentCount() {
    if (this.activeSubTab === null) return this.counts.all;
    if (this.activeSubTab === 'audio') return this.counts.audio;
    return this.counts[this.activeSubTab] || 0;
  },
  updateUrl() {
    const url = new URL(window.location);
    if (this.activeSubTab) {
      url.searchParams.set('subtab', this.activeSubTab);
    } else {
      url.searchParams.delete('subtab');
    }
    history.replaceState({}, '', url);
  }
}">
  <!-- ── agents ──────────────────────────── -->
  <div class="flex items-center gap-3 mb-4">
    <span class="text-[10px] font-medium text-gray-400 dark:text-gray-600 uppercase tracking-widest font-mono">agents</span>
    <div class="font-mono text-xs text-gray-400 dark:text-gray-500 flex items-center gap-1.5">
      <span x-text="currentCount"></span>
      <%= render "ruby_llm/agents/shared/doc_link" %>
    </div>
    <div class="flex-1 border-t border-gray-200 dark:border-gray-800"></div>
    <div class="flex font-mono text-xs gap-0.5">
      <button type="button" @click="activeSubTab = null; updateUrl()"
              :class="activeSubTab === null ? 'text-gray-900 dark:text-gray-100' : 'text-gray-400 dark:text-gray-500 hover:text-gray-700 dark:hover:text-gray-300'"
              class="px-2 py-0.5">all</button>
      <button type="button" @click="activeSubTab = 'agent'; updateUrl()"
              :class="activeSubTab === 'agent' ? 'text-gray-900 dark:text-gray-100' : 'text-gray-400 dark:text-gray-500 hover:text-gray-700 dark:hover:text-gray-300'"
              class="px-2 py-0.5">agents</button>
      <button type="button" @click="activeSubTab = 'embedder'; updateUrl()"
              :class="activeSubTab === 'embedder' ? 'text-gray-900 dark:text-gray-100' : 'text-gray-400 dark:text-gray-500 hover:text-gray-700 dark:hover:text-gray-300'"
              class="px-2 py-0.5">embedders</button>
      <% if audio_count > 0 %>
        <button type="button" @click="activeSubTab = 'audio'; updateUrl()"
                :class="activeSubTab === 'audio' ? 'text-gray-900 dark:text-gray-100' : 'text-gray-400 dark:text-gray-500 hover:text-gray-700 dark:hover:text-gray-300'"
                class="px-2 py-0.5">audio</button>
      <% end %>
      <% if @agents_by_type[:image_generator].size > 0 %>
        <button type="button" @click="activeSubTab = 'image_generator'; updateUrl()"
                :class="activeSubTab === 'image_generator' ? 'text-gray-900 dark:text-gray-100' : 'text-gray-400 dark:text-gray-500 hover:text-gray-700 dark:hover:text-gray-300'"
                class="px-2 py-0.5">image</button>
      <% end %>
      <% if @deleted_count > 0 %>
        <button type="button" @click="activeSubTab = 'deleted'; updateUrl()"
                :class="activeSubTab === 'deleted' ? 'text-gray-900 dark:text-gray-100' : 'text-gray-400 dark:text-gray-500 hover:text-gray-700 dark:hover:text-gray-300'"
                class="px-2 py-0.5">deleted</button>
      <% end %>
    </div>
  </div>

  <% if @agents.empty? && @deleted_agents.empty? %>
    <%= render "ruby_llm/agents/agents/empty_state", type: "agents" %>
  <% else %>
    <!-- Column headers -->
    <div class="flex items-center gap-3 px-2 -mx-2 font-mono text-[10px] text-gray-400 dark:text-gray-600 uppercase tracking-wider mb-1">
      <%= link_to "name#{sort_arrow.call('name')}".html_safe, sort_url.call("name"),
          class: "w-40 hover:text-gray-600 dark:hover:text-gray-300 #{sort_active.call('name')}" %>
      <%= link_to "type#{sort_arrow.call('agent_type')}".html_safe, sort_url.call("agent_type"),
          class: "w-20 hidden sm:block hover:text-gray-600 dark:hover:text-gray-300 #{sort_active.call('agent_type')}" %>
      <span class="w-1.5 flex-shrink-0"></span>
      <%= link_to "model#{sort_arrow.call('model')}".html_safe, sort_url.call("model"),
          class: "w-32 hidden lg:block hover:text-gray-600 dark:hover:text-gray-300 #{sort_active.call('model')}" %>
      <%= link_to "runs#{sort_arrow.call('execution_count')}".html_safe, sort_url.call("execution_count"),
          class: "w-14 text-right hover:text-gray-600 dark:hover:text-gray-300 #{sort_active.call('execution_count')}" %>
      <%= link_to "cost#{sort_arrow.call('total_cost')}".html_safe, sort_url.call("total_cost"),
          class: "w-16 text-right hidden md:block hover:text-gray-600 dark:hover:text-gray-300 #{sort_active.call('total_cost')}" %>
      <%= link_to "ok%#{sort_arrow.call('success_rate')}".html_safe, sort_url.call("success_rate"),
          class: "w-12 text-right hover:text-gray-600 dark:hover:text-gray-300 #{sort_active.call('success_rate')}" %>
      <%= link_to "last run#{sort_arrow.call('last_executed')}".html_safe, sort_url.call("last_executed"),
          class: "ml-auto text-right hover:text-gray-600 dark:hover:text-gray-300 #{sort_active.call('last_executed')}" %>
    </div>

    <!-- Data rows -->
    <div class="font-mono text-xs space-y-px">
      <% @agents.each do |agent| %>
        <%
          show_condition = if agent[:agent_type] == 'speaker' || agent[:agent_type] == 'transcriber'
            "activeSubTab !== 'deleted' && (activeSubTab === null || activeSubTab === 'audio' || activeSubTab === '#{agent[:agent_type]}')"
          else
            "activeSubTab !== 'deleted' && (activeSubTab === null || activeSubTab === '#{agent[:agent_type]}')"
          end
          success_rate = agent[:success_rate] || 0
          dot_color = agent[:active] ? (success_rate >= 95 ? 'bg-green-500' : success_rate >= 80 ? 'bg-yellow-500' : 'bg-red-500') : 'bg-gray-400'
        %>
        <div x-show="<%= show_condition %>"
             class="group flex items-center gap-3 py-1.5 px-2 -mx-2 rounded hover:bg-gray-100 dark:hover:bg-gray-800/50 cursor-pointer"
             onclick="window.location='<%= ruby_llm_agents.agent_path(ERB::Util.url_encode(agent[:name]), subtab: params[:subtab]) %>'"
             title="<%= agent[:description] %>">
          <span class="w-40 truncate text-gray-900 dark:text-gray-200">
            <%= agent[:name].split('::').last.gsub(/Agent$/, '') %><span class="hidden lg:inline text-gray-400 dark:text-gray-600 ml-1 text-[10px]">v<%= agent[:version] %></span>
          </span>
          <span class="w-20 truncate text-gray-500 dark:text-gray-400 hidden sm:inline"><%= agent[:agent_type]&.to_s || 'agent' %></span>
          <span class="w-1.5 h-1.5 rounded-full flex-shrink-0 <%= dot_color %>"></span>
          <span class="w-32 truncate text-gray-400 dark:text-gray-600 hidden lg:inline"><%= agent[:model]&.split("/")&.last || "—" %></span>
          <span class="w-14 text-right text-gray-500 dark:text-gray-400"><%= number_with_delimiter(agent[:execution_count] || 0) %><span class="text-gray-400 dark:text-gray-600">r</span></span>
          <span class="w-16 text-right text-gray-500 dark:text-gray-400 hidden md:inline">$<%= number_with_precision(agent[:total_cost] || 0, precision: 2) %></span>
          <span class="w-12 text-right <%= success_rate >= 95 ? 'text-green-500' : success_rate >= 80 ? 'text-yellow-500' : 'text-red-500' %>"><%= success_rate.round %>%</span>
          <span class="ml-auto text-gray-400 dark:text-gray-600 text-right whitespace-nowrap">
            <% if agent[:last_executed] %>
              <%= time_ago_in_words(agent[:last_executed]) %>
            <% else %>
              —
            <% end %>
          </span>
        </div>
      <% end %>

      <!-- Deleted agents -->
      <% @deleted_agents.each do |agent| %>
        <% success_rate = agent[:success_rate] || 0 %>
        <div x-show="activeSubTab === 'deleted'"
             class="group flex items-center gap-3 py-1.5 px-2 -mx-2 rounded hover:bg-gray-100 dark:hover:bg-gray-800/50 cursor-pointer"
             onclick="window.location='<%= ruby_llm_agents.agent_path(ERB::Util.url_encode(agent[:name]), subtab: params[:subtab]) %>'"
             title="<%= agent[:description] %>">
          <span class="w-40 truncate text-gray-500 dark:text-gray-400 line-through"><%= agent[:name].split('::').last.gsub(/Agent$/, '') %></span>
          <span class="w-20 truncate text-gray-400 dark:text-gray-600 hidden sm:inline"><%= agent[:agent_type]&.to_s || 'agent' %></span>
          <span class="w-1.5 h-1.5 rounded-full flex-shrink-0 bg-gray-400 dark:bg-gray-600"></span>
          <span class="w-32 truncate text-gray-400 dark:text-gray-600 hidden lg:inline"><%= agent[:model]&.split("/")&.last || "—" %></span>
          <span class="w-14 text-right text-gray-400 dark:text-gray-600"><%= number_with_delimiter(agent[:execution_count] || 0) %><span class="text-gray-400 dark:text-gray-600">r</span></span>
          <span class="w-16 text-right text-gray-400 dark:text-gray-600 hidden md:inline">$<%= number_with_precision(agent[:total_cost] || 0, precision: 2) %></span>
          <span class="w-12 text-right text-gray-400 dark:text-gray-600"><%= success_rate.round %>%</span>
          <span class="ml-auto text-gray-400 dark:text-gray-600 text-right whitespace-nowrap">
            <% if agent[:last_executed] %>
              <%= time_ago_in_words(agent[:last_executed]) %>
            <% else %>
              —
            <% end %>
          </span>
        </div>
      <% end %>

      <!-- Empty filter state -->
      <div x-show="currentCount === 0" x-cloak class="py-4 px-2 text-gray-400 dark:text-gray-600">
        no agents in this category
      </div>
    </div>
  <% end %>
</div>
