<!-- Back link -->
<nav class="font-mono text-xs mb-6">
  <%= link_to "← agents", ruby_llm_agents.agents_path(subtab: params[:subtab]), class: "text-gray-400 dark:text-gray-500 hover:text-gray-700 dark:hover:text-gray-300" %>
</nav>

<!-- ── agent header ──────────────── -->
<div class="flex items-start justify-between gap-8 mb-2">
  <!-- Left: identity -->
  <div class="min-w-0">
    <div class="flex items-center gap-3 mb-1.5">
      <span class="text-[10px] font-medium text-gray-400 dark:text-gray-600 uppercase tracking-widest font-mono"><%= @agent_type.gsub(/Agent$/, '') %></span>
      <div class="font-mono text-xs text-gray-400 dark:text-gray-500 flex items-center gap-1.5">
        <span class="badge badge-sm <%= @agent_active ? 'badge-success' : 'badge-error' %>"><%= @agent_active ? 'active' : 'inactive' %></span>
        <% if @config %>
          <span class="text-gray-800 dark:text-gray-200"><%= @config[:model] %></span>
          <% if @config[:temperature] %>
            <span class="text-gray-300 dark:text-gray-700">&middot;</span>
            <span>temp <%= @config[:temperature] %></span>
          <% end %>
          <% if @config[:timeout] %>
            <span class="text-gray-300 dark:text-gray-700">&middot;</span>
            <span><%= @config[:timeout] %>s</span>
          <% end %>
          <% if @config[:cache_enabled] %>
            <span class="text-gray-300 dark:text-gray-700">&middot;</span>
            <%
              ttl = @config[:cache_ttl]
              cache_label = if ttl.is_a?(ActiveSupport::Duration)
                secs = ttl.to_i
                if secs >= 3600 then "#{secs / 3600}h"
                elsif secs >= 60 then "#{secs / 60}m"
                else "#{secs}s"
                end
              else
                ttl.to_s
              end
            %>
            <span>cache <%= cache_label %></span>
          <% end %>
          <% if @config[:dimensions] %>
            <span class="text-gray-300 dark:text-gray-700">&middot;</span>
            <span><%= @config[:dimensions] %> dims</span>
          <% end %>
          <% if @config[:voice] %>
            <span class="text-gray-300 dark:text-gray-700">&middot;</span>
            <span>voice: <%= @config[:voice] %></span>
          <% end %>
          <% if @streaming_rate && @streaming_rate > 0 %>
            <span class="text-gray-300 dark:text-gray-700">&middot;</span>
            <span>streaming</span>
          <% end %>
        <% end %>
      </div>
      <%= render "ruby_llm/agents/shared/doc_link" %>
    </div>
    <% if @config && @config[:description].present? %>
      <p class="font-mono text-xs text-gray-500 dark:text-gray-400"><%= @config[:description] %></p>
    <% end %>
  </div>

  <!-- Right: stats -->
  <div class="flex-shrink-0 text-right font-mono text-xs text-gray-400 dark:text-gray-500 space-y-1">
    <% success_rate = @stats[:success_rate] || 0 %>
    <div class="flex items-center justify-end gap-x-4">
      <span><span class="text-gray-800 dark:text-gray-200"><%= number_with_delimiter(@stats[:count]) %></span> runs</span>
      <span class="<%= success_rate >= 95 ? 'text-green-500' : success_rate >= 80 ? 'text-yellow-500' : 'text-red-500' %>"><%= success_rate %>% ok</span>
      <span><span class="text-gray-800 dark:text-gray-200">$<%= number_with_precision(@stats[:total_cost] || 0, precision: 4) %></span> cost</span>
    </div>
    <div class="flex items-center justify-end gap-x-4 text-gray-500 dark:text-gray-600">
      <span><span class="text-gray-600 dark:text-gray-400"><%= number_with_delimiter(@stats[:total_tokens] || 0) %></span> tokens</span>
      <span><span class="text-gray-600 dark:text-gray-400"><%= number_with_delimiter(@stats[:avg_duration_ms] || 0) %></span>ms avg</span>
      <% if (@config && @config[:cache_enabled]) || @cache_hit_rate > 0 %>
        <span><span class="text-gray-600 dark:text-gray-400"><%= @cache_hit_rate %>%</span> cache</span>
      <% end %>
    </div>
    <% if @stats_today[:count] > 0 %>
      <% today_success_rate = @stats_today[:success_rate] || 0 %>
      <div class="flex items-center justify-end gap-x-4 pt-1 border-t border-gray-200 dark:border-gray-800">
        <span class="text-gray-300 dark:text-gray-700">today</span>
        <span><span class="text-gray-800 dark:text-gray-200"><%= number_with_delimiter(@stats_today[:count]) %></span> runs</span>
        <span class="<%= today_success_rate >= 95 ? 'text-green-500' : today_success_rate >= 80 ? 'text-yellow-500' : 'text-red-500' %>"><%= today_success_rate %>% ok</span>
        <span><span class="text-gray-800 dark:text-gray-200">$<%= number_with_precision(@stats_today[:total_cost] || 0, precision: 4) %></span> cost</span>
        <span><span class="text-gray-800 dark:text-gray-200"><%= number_with_delimiter(@stats_today[:avg_duration_ms] || 0) %></span>ms</span>
      </div>
    <% end %>
  </div>
</div>
<div class="border-t border-gray-200 dark:border-gray-800 mb-2"></div>

<!-- 30d trend chart -->
<div class="flex items-center gap-3 mt-6 mb-2">
  <span class="text-[10px] font-medium text-gray-400 dark:text-gray-600 uppercase tracking-widest font-mono">last 30 days</span>
  <div class="flex-1 border-t border-gray-200 dark:border-gray-800"></div>
</div>
<div id="agent-trend-chart" style="width: 100%; height: 160px;"></div>
<script>
(function() {
  const trendData = <%= raw @trend_data.map { |d|
    { date: d[:date] || d["date"], count: d[:count] || d["count"] || 0,
      cost: (d[:total_cost] || d["total_cost"] || 0).to_f.round(6),
      errors: d[:error_count] || d["error_count"] || 0 }
  }.to_json %>;

  const successData = trendData.map(d => [new Date(d.date).getTime(), d.count - d.errors]);
  const errorData = trendData.map(d => [new Date(d.date).getTime(), d.errors]);

  Highcharts.chart('agent-trend-chart', {
    chart: { type: 'areaspline', backgroundColor: 'transparent', spacing: [5, 0, 0, 0] },
    title: { text: null },
    xAxis: {
      type: 'datetime',
      labels: { style: { color: '#6B7280', fontSize: '9px', fontFamily: 'ui-monospace, monospace' }, format: '{value:%b %d}' },
      lineColor: 'transparent',
      tickLength: 0,
      gridLineWidth: 0
    },
    yAxis: {
      title: { text: null },
      min: 0,
      allowDecimals: false,
      labels: { style: { color: '#6B7280', fontSize: '9px', fontFamily: 'ui-monospace, monospace' } },
      gridLineColor: 'rgba(107, 114, 128, 0.08)'
    },
    legend: { enabled: false },
    credits: { enabled: false },
    tooltip: {
      backgroundColor: 'rgba(0, 0, 0, 0.85)',
      borderColor: 'transparent',
      borderRadius: 3,
      style: { color: '#E5E7EB', fontSize: '10px', fontFamily: 'ui-monospace, monospace' },
      shared: true,
      formatter: function() {
        let html = '<span style="color:#9CA3AF">' + Highcharts.dateFormat('%b %d', this.x) + '</span>';
        let cost = trendData.find(d => new Date(d.date).getTime() === this.x);
        this.points.forEach(p => html += '<br/>' + p.series.name + ': <b>' + p.y + '</b>');
        if (cost) html += '<br/>cost: <b>$' + cost.cost.toFixed(4) + '</b>';
        return html;
      }
    },
    plotOptions: {
      areaspline: {
        stacking: 'normal',
        lineWidth: 1.5,
        marker: { enabled: false, states: { hover: { enabled: true, radius: 2 } } }
      }
    },
    series: [
      {
        name: 'errors',
        data: errorData,
        color: '#EF4444',
        fillColor: { linearGradient: { x1: 0, y1: 0, x2: 0, y2: 1 }, stops: [[0, 'rgba(239, 68, 68, 0.08)'], [1, 'rgba(239, 68, 68, 0)']] }
      },
      {
        name: 'success',
        data: successData,
        color: '#10B981',
        fillColor: { linearGradient: { x1: 0, y1: 0, x2: 0, y2: 1 }, stops: [[0, 'rgba(16, 185, 129, 0.08)'], [1, 'rgba(16, 185, 129, 0)']] }
      }
    ]
  });
})();
</script>

<!-- ── tools ──────────────────────── -->
<% if @config && @agent_type_kind == "agent" %>
  <%
    class_tools = @agent_class.respond_to?(:tools) ? (@agent_class.tools || []) : []
    has_dynamic_tools = @agent_class.instance_methods(false).include?(:tools)
  %>
  <% if class_tools.any? || has_dynamic_tools %>
    <div class="flex items-center gap-3 mt-6 mb-3">
      <span class="text-[10px] font-medium text-gray-400 dark:text-gray-600 uppercase tracking-widest font-mono">tools (<%= class_tools.size %>)</span>
      <div class="flex-1 border-t border-gray-200 dark:border-gray-800"></div>
    </div>
    <div class="flex flex-wrap gap-1.5 font-mono text-xs">
      <% class_tools.each do |tool_class| %>
        <span class="badge badge-cyan"><%= tool_class.respond_to?(:tool_name) ? tool_class.tool_name : tool_class.name.demodulize %></span>
      <% end %>
      <% if has_dynamic_tools %>
        <span class="badge badge-purple">dynamic</span>
      <% end %>
    </div>
  <% end %>

  <% if @config[:params].present? && @config[:params].any? %>
    <div class="mt-3">
      <span class="text-[10px] text-gray-400 dark:text-gray-600 uppercase tracking-wider font-mono">parameters</span>
    </div>
    <div class="grid grid-cols-2 sm:grid-cols-3 gap-x-6 gap-y-0.5 font-mono text-xs mt-1.5">
      <% @config[:params].each do |name, opts| %>
        <div class="flex items-center gap-2 py-0.5">
          <span class="text-gray-900 dark:text-gray-200"><%= name %></span>
          <% if opts[:required] %>
            <span class="text-red-500">required</span>
          <% elsif opts[:default].present? %>
            <span class="text-gray-400 dark:text-gray-600">= <%= opts[:default].inspect %></span>
          <% else %>
            <span class="text-gray-400 dark:text-gray-600">optional</span>
          <% end %>
        </div>
      <% end %>
    </div>
  <% end %>
<% end %>

<!-- ── model health ──────────────── -->
<%
  if @config && @agent_type_kind == "agent"
    retries_config = @config[:retries] || {}
    fallback_models = Array(@config[:fallback_models]).compact
    has_retries = (retries_config[:max] || 0) > 0
    has_fallbacks = fallback_models.any?
    has_circuit_breaker = @config[:circuit_breaker].present?
    has_any_reliability = has_retries || has_fallbacks || has_circuit_breaker
    show_model_health = has_any_reliability || @circuit_breaker_status.present?
  end
%>
<% if show_model_health %>
  <div class="flex items-center gap-3 mt-6 mb-3">
    <span class="text-[10px] font-medium text-gray-400 dark:text-gray-600 uppercase tracking-widest font-mono">model health</span>
    <div class="flex-1 border-t border-gray-200 dark:border-gray-800"></div>
  </div>
  <% if has_any_reliability %>
    <div class="font-mono text-xs text-gray-400 dark:text-gray-500 mb-2 flex flex-wrap gap-x-1.5 gap-y-0.5">
      <% if has_retries %>
        <span>retries: <%= retries_config[:max] %> max</span>
      <% end %>
      <% if has_retries && (has_fallbacks || has_circuit_breaker) %>
        <span class="text-gray-300 dark:text-gray-700">&middot;</span>
      <% end %>
      <% if has_fallbacks %>
        <span>fallbacks: <%= fallback_models.join(" → ") %></span>
      <% end %>
      <% if has_fallbacks && has_circuit_breaker %>
        <span class="text-gray-300 dark:text-gray-700">&middot;</span>
      <% end %>
      <% if has_circuit_breaker %>
        <% cb = @config[:circuit_breaker] %>
        <span>pauses after <%= cb[:errors] %> errors in <%= cb[:within] %>s</span>
      <% end %>
    </div>
  <% end %>
  <% if @circuit_breaker_status.present? %>
    <div class="font-mono text-xs">
      <% @circuit_breaker_status.each do |model_id, status| %>
        <div class="flex items-center gap-3 py-1 px-2 -mx-2">
          <span class="w-1.5 h-1.5 rounded-full flex-shrink-0 <%= status[:open] ? 'bg-red-500 animate-pulse' : 'bg-green-500' %>"></span>
          <span class="text-gray-900 dark:text-gray-200"><%= model_id %></span>
          <% if status[:open] %>
            <span class="text-red-500">paused</span>
            <% if status[:cooldown_remaining] %>
              <span class="text-gray-400 dark:text-gray-600">retrying in <%= status[:cooldown_remaining] %>s</span>
            <% end %>
          <% else %>
            <span class="text-green-500">healthy</span>
            <% if status[:failure_count] && status[:failure_count] > 0 %>
              <span class="text-yellow-500"><%= status[:failure_count] %>/<%= status[:threshold] %> failures before pause</span>
            <% end %>
          <% end %>
        </div>
      <% end %>
    </div>
  <% end %>
<% end %>

<!-- ── config (non-agent types only) ── -->
<% if @config && @agent_type_kind && @agent_type_kind != "agent" %>
  <div class="flex items-center gap-3 mt-6 mb-3">
    <span class="text-[10px] font-medium text-gray-400 dark:text-gray-600 uppercase tracking-widest font-mono">config</span>
    <div class="flex-1 border-t border-gray-200 dark:border-gray-800"></div>
  </div>
  <%= render "ruby_llm/agents/agents/config_#{@agent_type_kind}", config: @config %>
<% end %>

<!-- ── executions ──────────────────── -->
<div class="flex items-center gap-3 mt-6 mb-3">
  <span class="text-[10px] font-medium text-gray-400 dark:text-gray-600 uppercase tracking-widest font-mono">recent executions</span>
  <div class="flex-1 border-t border-gray-200 dark:border-gray-800"></div>
</div>

<%= render "ruby_llm/agents/shared/executions_table", executions: @executions, pagination: @pagination, hide_agent_column: true %>

<% if @stats[:count] > 0 %>
  <div class="mt-3 font-mono text-xs">
    <%= link_to ruby_llm_agents.executions_path("agent_types[]": @agent_type),
        class: "text-gray-400 dark:text-gray-500 hover:text-gray-700 dark:hover:text-gray-300" do %>
      show all <%= number_with_delimiter(@stats[:count]) %> executions →
    <% end %>
  </div>
<% end %>
