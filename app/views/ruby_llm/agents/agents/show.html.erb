<!-- Back link -->
<nav class="font-mono text-xs mb-6">
  <%= link_to "← agents", ruby_llm_agents.agents_path(subtab: params[:subtab]), class: "text-gray-400 dark:text-gray-500 hover:text-gray-700 dark:hover:text-gray-300" %>
</nav>

<!-- ── agent header ──────────────── -->
<div class="flex items-center gap-3 mb-1.5">
  <span class="text-[10px] font-medium text-gray-400 dark:text-gray-600 uppercase tracking-widest font-mono"><%= @agent_type.gsub(/Agent$/, '') %></span>
  <div class="font-mono text-xs text-gray-400 dark:text-gray-500 flex items-center gap-1.5">
    <span class="w-1.5 h-1.5 rounded-full flex-shrink-0 <%= @agent_active ? 'bg-green-500' : 'bg-gray-400' %>"></span>
    <% if @config %>
      <span class="text-gray-800 dark:text-gray-200"><%= @config[:model] %></span>
      <% if @config[:temperature] %>
        <span class="text-gray-300 dark:text-gray-700">&middot;</span>
        <span>temp <%= @config[:temperature] %></span>
      <% end %>
      <% if @config[:timeout] %>
        <span class="text-gray-300 dark:text-gray-700">&middot;</span>
        <span><%= @config[:timeout] %>s</span>
      <% end %>
      <% if @config[:dimensions] %>
        <span class="text-gray-300 dark:text-gray-700">&middot;</span>
        <span><%= @config[:dimensions] %> dims</span>
      <% end %>
      <% if @config[:voice] %>
        <span class="text-gray-300 dark:text-gray-700">&middot;</span>
        <span>voice: <%= @config[:voice] %></span>
      <% end %>
    <% end %>
  </div>
  <%= render "ruby_llm/agents/shared/doc_link" %>
  <div class="flex-1 border-t border-gray-200 dark:border-gray-800"></div>
</div>

<% if @config && @config[:description].present? %>
  <p class="font-mono text-xs text-gray-500 dark:text-gray-400 mb-4"><%= @config[:description] %></p>
<% end %>

<!-- Stats -->
<% success_rate = @stats[:success_rate] || 0 %>
<div class="flex flex-wrap items-center gap-x-4 gap-y-1 font-mono text-xs text-gray-400 dark:text-gray-500 mb-2">
  <span><span class="text-gray-800 dark:text-gray-200"><%= number_with_delimiter(@stats[:count]) %></span> runs</span>
  <span class="<%= success_rate >= 95 ? 'text-green-500' : success_rate >= 80 ? 'text-yellow-500' : 'text-red-500' %>"><%= success_rate %>% ok</span>
  <span><span class="text-gray-800 dark:text-gray-200">$<%= number_with_precision(@stats[:total_cost] || 0, precision: 4) %></span> cost</span>
  <span><span class="text-gray-800 dark:text-gray-200"><%= number_with_delimiter(@stats[:total_tokens] || 0) %></span> tok</span>
  <span><span class="text-gray-800 dark:text-gray-200"><%= number_with_delimiter(@stats[:avg_duration_ms] || 0) %></span>ms avg</span>
  <span><span class="text-gray-800 dark:text-gray-200"><%= @cache_hit_rate %>%</span> cache</span>
</div>

<!-- Status + finish reasons -->
<div class="flex flex-wrap items-center gap-x-4 gap-y-1 font-mono text-xs text-gray-400 dark:text-gray-500">
  <% status_colors = { "success" => "bg-green-500", "error" => "bg-red-500", "timeout" => "bg-yellow-500", "running" => "bg-blue-500" } %>
  <% @status_distribution.each do |status, count| %>
    <div class="flex items-center gap-1.5">
      <span class="w-1.5 h-1.5 rounded-full <%= status_colors[status] || 'bg-gray-400' %> <%= status == 'running' ? 'animate-pulse' : '' %>"></span>
      <span><%= number_with_delimiter(count) %> <%= status %></span>
    </div>
  <% end %>
  <% if @finish_reason_distribution.present? && @finish_reason_distribution.any? %>
    <span class="text-gray-300 dark:text-gray-700">|</span>
    <% finish_colors = { 'stop' => 'bg-green-500', 'length' => 'bg-yellow-500', 'content_filter' => 'bg-red-500', 'tool_calls' => 'bg-blue-500' } %>
    <% @finish_reason_distribution.each do |reason, count| %>
      <div class="flex items-center gap-1.5">
        <span class="w-1.5 h-1.5 rounded-full <%= finish_colors[reason] || 'bg-gray-400' %>"></span>
        <span><%= number_with_delimiter(count) %> <%= reason || 'unknown' %></span>
      </div>
    <% end %>
  <% end %>
</div>

<!-- Sparklines (30d) -->
<%
  sparkline_chars = %w[▁ ▂ ▃ ▄ ▅ ▆ ▇ █]
  exec_values = @trend_data.map { |d| d["count"] || d[:count] || 0 }
  cost_values = @trend_data.map { |d| (d["total_cost"] || d[:total_cost] || 0).to_f }
  exec_max = exec_values.max.to_f
  cost_max = cost_values.max.to_f

  make_sparkline = ->(values, max_val) {
    return "▁" * values.length if max_val == 0
    values.map { |v| sparkline_chars[[(v.to_f / max_val * 7).round, 7].min] }.join
  }

  exec_spark = make_sparkline.call(exec_values, exec_max)
  cost_spark = make_sparkline.call(cost_values, cost_max)
  exec_total = exec_values.sum
  cost_total = cost_values.sum
%>
<div class="flex items-center gap-3 mt-6 mb-2">
  <span class="text-[10px] font-medium text-gray-400 dark:text-gray-600 uppercase tracking-widest font-mono">30d</span>
  <div class="flex-1 border-t border-gray-200 dark:border-gray-800"></div>
</div>
<div class="flex flex-wrap gap-x-10 gap-y-2 font-mono text-xs">
  <div class="flex items-center gap-3">
    <span class="text-gray-400 dark:text-gray-600 w-16">executions</span>
    <span class="text-green-500 leading-none" style="font-size: 14px; letter-spacing: -0.5px;"><%= exec_spark %></span>
    <span class="text-gray-800 dark:text-gray-200"><%= exec_total %></span>
  </div>
  <div class="flex items-center gap-3">
    <span class="text-gray-400 dark:text-gray-600 w-16">cost</span>
    <span class="text-green-500 leading-none" style="font-size: 14px; letter-spacing: -0.5px;"><%= cost_spark %></span>
    <span class="text-gray-800 dark:text-gray-200">$<%= number_with_precision(cost_total, precision: 4) %></span>
  </div>
</div>

<!-- ── circuit breaker ──────────────── -->
<% if @config && @agent_type_kind == "agent" && @circuit_breaker_status.present? %>
  <div class="flex items-center gap-3 mt-6 mb-3">
    <span class="text-[10px] font-medium text-gray-400 dark:text-gray-600 uppercase tracking-widest font-mono">circuit breaker</span>
    <span class="font-mono text-[10px] text-gray-400 dark:text-gray-600">auto-refreshes 30s</span>
    <div class="flex-1 border-t border-gray-200 dark:border-gray-800"></div>
  </div>
  <div class="font-mono text-xs space-y-0.5">
    <% @circuit_breaker_status.each do |model_id, status| %>
      <div class="flex items-center gap-3 py-1.5 px-2 -mx-2">
        <span class="w-1.5 h-1.5 rounded-full flex-shrink-0 <%= status[:open] ? 'bg-red-500 animate-pulse' : 'bg-green-500' %>"></span>
        <span class="text-gray-900 dark:text-gray-200"><%= model_id %></span>
        <span class="<%= status[:open] ? 'text-red-500' : 'text-green-500' %>"><%= status[:open] ? 'OPEN' : 'OK' %></span>
        <% if status[:open] && status[:cooldown_remaining] %>
          <span class="text-gray-400 dark:text-gray-600">resets in <%= status[:cooldown_remaining] %>s</span>
        <% elsif !status[:open] && status[:failure_count] && status[:failure_count] > 0 %>
          <span class="text-yellow-500"><%= status[:failure_count] %>/<%= status[:threshold] %> failures</span>
        <% end %>
      </div>
    <% end %>
  </div>
  <% if @circuit_breaker_status.values.any? { |s| s[:open] } %>
    <p class="font-mono text-xs text-gray-400 dark:text-gray-600 mt-2 px-2">
      open circuits skip model and try fallbacks. auto-resets after cooldown.
    </p>
  <% end %>
<% end %>

<!-- ── config ──────────────────────── -->
<% if @config && @agent_type_kind %>
  <div class="flex items-center gap-3 mt-6 mb-3">
    <span class="text-[10px] font-medium text-gray-400 dark:text-gray-600 uppercase tracking-widest font-mono">config</span>
    <div class="flex-1 border-t border-gray-200 dark:border-gray-800"></div>
  </div>
  <%= render "ruby_llm/agents/agents/config_#{@agent_type_kind}", config: @config %>
<% end %>

<!-- ── executions ──────────────────── -->
<div class="flex items-center gap-3 mt-6 mb-3">
  <span class="text-[10px] font-medium text-gray-400 dark:text-gray-600 uppercase tracking-widest font-mono">executions</span>
  <div class="flex-1 border-t border-gray-200 dark:border-gray-800"></div>
</div>

<div id="executions_table">
  <%
    has_filters = params[:statuses].present? || params[:models].present? || params[:temperatures].present? || params[:days].present?
    selected_statuses = params[:statuses].present? ? (params[:statuses].is_a?(Array) ? params[:statuses] : params[:statuses].split(",")) : []
    selected_models = params[:models].present? ? (params[:models].is_a?(Array) ? params[:models] : params[:models].split(",")) : []
    selected_temperatures = params[:temperatures].present? ? (params[:temperatures].is_a?(Array) ? params[:temperatures] : params[:temperatures].split(",")).map(&:to_s) : []

    status_options = [
      { value: "success", label: "Success", color: "bg-green-500" },
      { value: "error", label: "Error", color: "bg-red-500" },
      { value: "running", label: "Running", color: "bg-blue-500" },
      { value: "timeout", label: "Timeout", color: "bg-yellow-500" }
    ]
    model_options = @models.map { |m| { value: m, label: m } }
    temperature_options = @temperatures.map { |t| { value: t.to_s, label: t.to_s } }
    days_options = [
      { value: "", label: "All Time" },
      { value: "1", label: "Today" },
      { value: "7", label: "Last 7 Days" },
      { value: "30", label: "Last 30 Days" }
    ]
  %>

  <%= form_with url: ruby_llm_agents.agent_path(@agent_type), method: :get, local: true do |f| %>
    <div class="flex flex-wrap items-center gap-3 mb-4">
      <%= render "ruby_llm/agents/shared/filter_dropdown",
          name: "statuses[]",
          filter_id: "statuses",
          label: "Status",
          all_label: "All Statuses",
          options: status_options,
          selected: selected_statuses %>

      <% if @models.length > 1 %>
        <%= render "ruby_llm/agents/shared/filter_dropdown",
            name: "models[]",
            filter_id: "models",
            label: "Model",
            all_label: "All Models",
            options: model_options,
            selected: selected_models,
            icon: "M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" %>
      <% end %>

      <% if @temperatures.length > 1 %>
        <%= render "ruby_llm/agents/shared/filter_dropdown",
            name: "temperatures[]",
            filter_id: "temperatures",
            label: "Temp",
            all_label: "All Temps",
            options: temperature_options,
            selected: selected_temperatures,
            icon: "M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" %>
      <% end %>

      <%= render "ruby_llm/agents/shared/select_dropdown",
          name: "days",
          filter_id: "days",
          options: days_options,
          selected: params[:days].to_s,
          icon: "M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" %>

      <% if has_filters %>
        <%= link_to ruby_llm_agents.agent_path(@agent_type),
            class: "flex items-center gap-1 px-2 py-1 font-mono text-xs text-red-500 dark:text-red-400 hover:text-red-600 dark:hover:text-red-300" do %>
          &times; clear
        <% end %>
      <% end %>

      <div class="ml-auto flex items-center gap-3 font-mono text-xs text-gray-400 dark:text-gray-500">
        <span><span class="text-gray-800 dark:text-gray-200"><%= number_with_delimiter(@filter_stats[:total_count]) %></span> results</span>
        <span><span class="text-gray-800 dark:text-gray-200">$<%= number_with_precision(@filter_stats[:total_cost] || 0, precision: 4) %></span></span>
        <span><span class="text-gray-800 dark:text-gray-200"><%= number_with_delimiter(@filter_stats[:total_tokens] || 0) %></span> tok</span>
      </div>
    </div>
  <% end %>

  <%= render "ruby_llm/agents/shared/executions_table", executions: @executions, pagination: @pagination %>
</div>
