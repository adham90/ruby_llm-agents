<!-- Back link -->
<nav class="font-mono text-xs mb-6">
  <%= link_to "← agents", ruby_llm_agents.agents_path(subtab: params[:subtab]), class: "text-gray-400 dark:text-gray-500 hover:text-gray-700 dark:hover:text-gray-300" %>
</nav>

<!-- ── agent header ──────────────── -->
<div class="flex items-center gap-3 mb-3">
  <span class="text-[10px] font-medium text-gray-400 dark:text-gray-600 uppercase tracking-widest font-mono"><%= @agent_type.gsub(/Agent$/, '') %></span>
  <div class="font-mono text-xs text-gray-400 dark:text-gray-500 flex items-center gap-1.5">
    <span class="w-1.5 h-1.5 rounded-full flex-shrink-0 <%= @agent_active ? 'bg-green-500' : 'bg-gray-400' %>"></span>
    <% if @config %>
      <span class="text-gray-800 dark:text-gray-200"><%= @config[:model] %></span>
      <% if @config[:temperature] %>
        <span class="text-gray-300 dark:text-gray-700">&middot;</span>
        <span>temp <%= @config[:temperature] %></span>
      <% end %>
      <% if @config[:timeout] %>
        <span class="text-gray-300 dark:text-gray-700">&middot;</span>
        <span><%= @config[:timeout] %>s</span>
      <% end %>
      <% if @config[:dimensions] %>
        <span class="text-gray-300 dark:text-gray-700">&middot;</span>
        <span><%= @config[:dimensions] %> dims</span>
      <% end %>
      <% if @config[:voice] %>
        <span class="text-gray-300 dark:text-gray-700">&middot;</span>
        <span>voice: <%= @config[:voice] %></span>
      <% end %>
    <% end %>
  </div>
  <%= render "ruby_llm/agents/shared/doc_link" %>
  <div class="flex-1 border-t border-gray-200 dark:border-gray-800"></div>
</div>

<% if @config && @config[:description].present? %>
  <p class="font-mono text-xs text-gray-500 dark:text-gray-400 mb-3"><%= @config[:description] %></p>
<% end %>

<!-- Stats strip -->
<% success_rate = @stats[:success_rate] || 0 %>
<div class="flex flex-wrap items-center gap-x-1.5 gap-y-1 font-mono text-xs text-gray-400 dark:text-gray-500 mb-2">
  <span class="text-gray-800 dark:text-gray-200"><%= number_with_delimiter(@stats[:count]) %></span> runs
  <span class="text-gray-300 dark:text-gray-700">&middot;</span>
  <span class="<%= success_rate >= 95 ? 'text-green-500' : success_rate >= 80 ? 'text-yellow-500' : 'text-red-500' %>"><%= success_rate %>%</span> ok
  <span class="text-gray-300 dark:text-gray-700">&middot;</span>
  <span class="text-gray-800 dark:text-gray-200">$<%= number_with_precision(@stats[:total_cost] || 0, precision: 4) %></span>
  <span class="text-gray-300 dark:text-gray-700">&middot;</span>
  <span class="text-gray-800 dark:text-gray-200"><%= number_with_delimiter(@stats[:total_tokens] || 0) %></span> tok
  <span class="text-gray-300 dark:text-gray-700">&middot;</span>
  <span class="text-gray-800 dark:text-gray-200"><%= number_with_delimiter(@stats[:avg_duration_ms] || 0) %></span>ms avg
  <span class="text-gray-300 dark:text-gray-700">&middot;</span>
  <span class="text-gray-800 dark:text-gray-200"><%= @cache_hit_rate %>%</span> cache
</div>

<!-- Status distribution -->
<div class="flex items-center gap-3 font-mono text-xs text-gray-400 dark:text-gray-500">
  <% status_colors = { "success" => "bg-green-500", "error" => "bg-red-500", "timeout" => "bg-yellow-500", "running" => "bg-blue-500" } %>
  <% @status_distribution.each do |status, count| %>
    <div class="flex items-center gap-1">
      <span class="w-1.5 h-1.5 rounded-full <%= status_colors[status] || 'bg-gray-400' %> <%= status == 'running' ? 'animate-pulse' : '' %>"></span>
      <span><%= number_with_delimiter(count) %> <%= status %></span>
    </div>
  <% end %>
</div>

<!-- Charts -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mt-8">
  <div>
    <span class="font-mono text-[10px] text-gray-400 dark:text-gray-600 uppercase tracking-wider">executions (30d)</span>
    <div id="executions-chart" style="height: 180px;"></div>
  </div>
  <div>
    <span class="font-mono text-[10px] text-gray-400 dark:text-gray-600 uppercase tracking-wider">cost (30d)</span>
    <div id="cost-chart" style="height: 180px;"></div>
  </div>
</div>

<script>
(function() {
  const trendData = <%= raw @trend_data.to_json %>;
  const dayMs = 86400000;
  const now = Date.now();
  const fmt = '%b %d';
  const toPoints = (data, fn) => data.map((d, i) => [now - (data.length - 1 - i) * dayMs, fn(d)]);

  Highcharts.chart('executions-chart', {
    chart: { type: 'areaspline', backgroundColor: 'transparent', spacing: [5, 0, 0, 0] },
    title: { text: null },
    legend: { enabled: false },
    credits: { enabled: false },
    xAxis: {
      type: 'datetime',
      labels: { style: { color: '#6B7280', fontSize: '9px', fontFamily: 'ui-monospace, monospace' }, format: '{value:' + fmt + '}' },
      lineColor: 'transparent', tickLength: 0, gridLineWidth: 0
    },
    yAxis: {
      title: { text: null }, min: 0, allowDecimals: false,
      labels: { style: { color: '#6B7280', fontSize: '9px', fontFamily: 'ui-monospace, monospace' } },
      gridLineColor: 'rgba(107, 114, 128, 0.08)'
    },
    tooltip: {
      backgroundColor: 'rgba(0, 0, 0, 0.85)', borderColor: 'transparent', borderRadius: 3,
      style: { color: '#E5E7EB', fontSize: '10px', fontFamily: 'ui-monospace, monospace' },
      shared: true,
      formatter: function() {
        var html = '<span style="color:#9CA3AF">' + Highcharts.dateFormat(fmt, this.x) + '</span>';
        this.points.forEach(p => html += '<br>' + p.series.name + ': <b>' + p.y + '</b>');
        return html;
      }
    },
    plotOptions: { areaspline: { stacking: 'normal', lineWidth: 1.5, marker: { enabled: false, states: { hover: { enabled: true, radius: 2 } } } } },
    series: [
      { name: 'errors', data: toPoints(trendData, d => d.error_count || 0), color: '#EF4444', fillColor: { linearGradient: { x1: 0, y1: 0, x2: 0, y2: 1 }, stops: [[0, 'rgba(239, 68, 68, 0.08)'], [1, 'rgba(239, 68, 68, 0)']] } },
      { name: 'success', data: toPoints(trendData, d => d.count - (d.error_count || 0)), color: '#10B981', fillColor: { linearGradient: { x1: 0, y1: 0, x2: 0, y2: 1 }, stops: [[0, 'rgba(16, 185, 129, 0.08)'], [1, 'rgba(16, 185, 129, 0)']] } }
    ]
  });

  Highcharts.chart('cost-chart', {
    chart: { type: 'spline', backgroundColor: 'transparent', spacing: [5, 0, 0, 0] },
    title: { text: null },
    legend: { enabled: false },
    credits: { enabled: false },
    xAxis: {
      type: 'datetime',
      labels: { style: { color: '#6B7280', fontSize: '9px', fontFamily: 'ui-monospace, monospace' }, format: '{value:' + fmt + '}' },
      lineColor: 'transparent', tickLength: 0, gridLineWidth: 0
    },
    yAxis: {
      title: { text: null }, min: 0,
      labels: { style: { color: '#6B7280', fontSize: '9px', fontFamily: 'ui-monospace, monospace' }, format: '${value}' },
      gridLineColor: 'rgba(107, 114, 128, 0.08)'
    },
    tooltip: {
      backgroundColor: 'rgba(0, 0, 0, 0.85)', borderColor: 'transparent', borderRadius: 3,
      style: { color: '#E5E7EB', fontSize: '10px', fontFamily: 'ui-monospace, monospace' },
      valuePrefix: '$'
    },
    plotOptions: { spline: { lineWidth: 1.5, marker: { enabled: false, states: { hover: { enabled: true, radius: 2 } } } } },
    series: [{ name: 'cost', data: toPoints(trendData, d => parseFloat(d.total_cost) || 0), color: '#10B981' }]
  });
})();
</script>

<!-- ── finish reasons ──────────────── -->
<% if @finish_reason_distribution.present? && @finish_reason_distribution.any? %>
  <div class="flex items-center gap-3 mt-8 mb-3">
    <span class="text-[10px] font-medium text-gray-400 dark:text-gray-600 uppercase tracking-widest font-mono">finish reasons</span>
    <div class="flex-1 border-t border-gray-200 dark:border-gray-800"></div>
  </div>
  <div class="flex flex-wrap gap-4 font-mono text-xs">
    <% finish_colors = { 'stop' => 'bg-green-500', 'length' => 'bg-yellow-500', 'content_filter' => 'bg-red-500', 'tool_calls' => 'bg-blue-500' } %>
    <% @finish_reason_distribution.each do |reason, count| %>
      <div class="flex items-center gap-1.5">
        <span class="w-1.5 h-1.5 rounded-full <%= finish_colors[reason] || 'bg-gray-400' %>"></span>
        <span class="text-gray-500 dark:text-gray-400"><%= reason || 'unknown' %></span>
        <span class="text-gray-800 dark:text-gray-200"><%= number_with_delimiter(count) %></span>
      </div>
    <% end %>
  </div>
<% end %>

<!-- ── circuit breaker ──────────────── -->
<% if @config && @agent_type_kind == "agent" && @circuit_breaker_status.present? %>
  <div class="flex items-center gap-3 mt-8 mb-3">
    <span class="text-[10px] font-medium text-gray-400 dark:text-gray-600 uppercase tracking-widest font-mono">circuit breaker</span>
    <span class="font-mono text-[10px] text-gray-400 dark:text-gray-600">auto-refreshes 30s</span>
    <div class="flex-1 border-t border-gray-200 dark:border-gray-800"></div>
  </div>
  <div class="font-mono text-xs space-y-px">
    <% @circuit_breaker_status.each do |model_id, status| %>
      <div class="flex items-center gap-3 py-1.5 px-2 -mx-2">
        <span class="w-1.5 h-1.5 rounded-full flex-shrink-0 <%= status[:open] ? 'bg-red-500 animate-pulse' : 'bg-green-500' %>"></span>
        <span class="text-gray-900 dark:text-gray-200"><%= model_id %></span>
        <span class="<%= status[:open] ? 'text-red-500' : 'text-green-500' %>"><%= status[:open] ? 'OPEN' : 'OK' %></span>
        <% if status[:open] && status[:cooldown_remaining] %>
          <span class="text-gray-400 dark:text-gray-600">resets in <%= status[:cooldown_remaining] %>s</span>
        <% elsif !status[:open] && status[:failure_count] && status[:failure_count] > 0 %>
          <span class="text-yellow-500"><%= status[:failure_count] %>/<%= status[:threshold] %> failures</span>
        <% end %>
      </div>
    <% end %>
  </div>
  <% if @circuit_breaker_status.values.any? { |s| s[:open] } %>
    <p class="font-mono text-xs text-gray-400 dark:text-gray-600 mt-2 px-2">
      open circuits skip model and try fallbacks. auto-resets after cooldown.
    </p>
  <% end %>
<% end %>

<!-- ── config ──────────────────────── -->
<% if @config && @agent_type_kind %>
  <div class="flex items-center gap-3 mt-8 mb-3">
    <span class="text-[10px] font-medium text-gray-400 dark:text-gray-600 uppercase tracking-widest font-mono">config</span>
    <div class="flex-1 border-t border-gray-200 dark:border-gray-800"></div>
  </div>
  <%= render "ruby_llm/agents/agents/config_#{@agent_type_kind}", config: @config %>
<% end %>

<!-- ── executions ──────────────────── -->
<div class="flex items-center gap-3 mt-8 mb-3">
  <span class="text-[10px] font-medium text-gray-400 dark:text-gray-600 uppercase tracking-widest font-mono">executions</span>
  <div class="flex-1 border-t border-gray-200 dark:border-gray-800"></div>
</div>

<div id="executions_table">
  <%
    has_filters = params[:statuses].present? || params[:models].present? || params[:temperatures].present? || params[:days].present?
    selected_statuses = params[:statuses].present? ? (params[:statuses].is_a?(Array) ? params[:statuses] : params[:statuses].split(",")) : []
    selected_models = params[:models].present? ? (params[:models].is_a?(Array) ? params[:models] : params[:models].split(",")) : []
    selected_temperatures = params[:temperatures].present? ? (params[:temperatures].is_a?(Array) ? params[:temperatures] : params[:temperatures].split(",")).map(&:to_s) : []

    status_options = [
      { value: "success", label: "Success", color: "bg-green-500" },
      { value: "error", label: "Error", color: "bg-red-500" },
      { value: "running", label: "Running", color: "bg-blue-500" },
      { value: "timeout", label: "Timeout", color: "bg-yellow-500" }
    ]
    model_options = @models.map { |m| { value: m, label: m } }
    temperature_options = @temperatures.map { |t| { value: t.to_s, label: t.to_s } }
    days_options = [
      { value: "", label: "All Time" },
      { value: "1", label: "Today" },
      { value: "7", label: "Last 7 Days" },
      { value: "30", label: "Last 30 Days" }
    ]
  %>

  <%= form_with url: ruby_llm_agents.agent_path(@agent_type), method: :get, local: true do |f| %>
    <div class="flex flex-wrap items-center gap-3 mb-4">
      <%= render "ruby_llm/agents/shared/filter_dropdown",
          name: "statuses[]",
          filter_id: "statuses",
          label: "Status",
          all_label: "All Statuses",
          options: status_options,
          selected: selected_statuses %>

      <% if @models.length > 1 %>
        <%= render "ruby_llm/agents/shared/filter_dropdown",
            name: "models[]",
            filter_id: "models",
            label: "Model",
            all_label: "All Models",
            options: model_options,
            selected: selected_models,
            icon: "M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" %>
      <% end %>

      <% if @temperatures.length > 1 %>
        <%= render "ruby_llm/agents/shared/filter_dropdown",
            name: "temperatures[]",
            filter_id: "temperatures",
            label: "Temp",
            all_label: "All Temps",
            options: temperature_options,
            selected: selected_temperatures,
            icon: "M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" %>
      <% end %>

      <%= render "ruby_llm/agents/shared/select_dropdown",
          name: "days",
          filter_id: "days",
          options: days_options,
          selected: params[:days].to_s,
          icon: "M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" %>

      <% if has_filters %>
        <%= link_to ruby_llm_agents.agent_path(@agent_type),
            class: "flex items-center gap-1 px-2 py-1 font-mono text-xs text-red-500 dark:text-red-400 hover:text-red-600 dark:hover:text-red-300" do %>
          &times; clear
        <% end %>
      <% end %>

      <div class="ml-auto flex items-center gap-1.5 font-mono text-xs text-gray-400 dark:text-gray-500">
        <span class="text-gray-800 dark:text-gray-200"><%= number_with_delimiter(@filter_stats[:total_count]) %></span> results
        <span class="text-gray-300 dark:text-gray-700">&middot;</span>
        <span class="text-gray-800 dark:text-gray-200">$<%= number_with_precision(@filter_stats[:total_cost] || 0, precision: 4) %></span>
        <span class="text-gray-300 dark:text-gray-700">&middot;</span>
        <span class="text-gray-800 dark:text-gray-200"><%= number_with_delimiter(@filter_stats[:total_tokens] || 0) %></span> tok
      </div>
    </div>
  <% end %>

  <%= render "ruby_llm/agents/shared/executions_table", executions: @executions, pagination: @pagination %>
</div>
