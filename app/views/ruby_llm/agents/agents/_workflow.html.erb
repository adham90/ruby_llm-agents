<%
  workflow_colors = {
    "pipeline" => { border: "border-l-indigo-500", icon_bg: "bg-indigo-100 dark:bg-indigo-900/50", icon_text: "text-indigo-600 dark:text-indigo-300" },
    "parallel" => { border: "border-l-cyan-500", icon_bg: "bg-cyan-100 dark:bg-cyan-900/50", icon_text: "text-cyan-600 dark:text-cyan-300" },
    "router" => { border: "border-l-amber-500", icon_bg: "bg-amber-100 dark:bg-amber-900/50", icon_text: "text-amber-600 dark:text-amber-300" }
  }
  colors = workflow_colors[workflow[:workflow_type]] || { border: "border-l-gray-400", icon_bg: "bg-gray-100", icon_text: "text-gray-600" }

  child_label = case workflow[:workflow_type]
    when "pipeline" then "steps"
    when "parallel" then "branches"
    when "router" then "routes"
    else "children"
  end
%>

<div x-data="{ expanded: false }" class="block bg-white dark:bg-gray-800 rounded-lg shadow hover:shadow-md transition-shadow border-l-4 <%= colors[:border] %>">
  <%= link_to ruby_llm_agents.agent_path(ERB::Util.url_encode(workflow[:name])), class: "block p-4 sm:p-5" do %>
    <!-- Header Row -->
    <div class="flex items-center justify-between gap-2">
      <div class="flex items-center gap-2 min-w-0">
        <%= render "ruby_llm/agents/shared/workflow_type_badge", workflow_type: workflow[:workflow_type], size: :sm %>
        <h3 class="font-semibold text-gray-900 dark:text-gray-100 truncate">
          <% name_parts = workflow[:name].gsub(/Workflow$/, '').gsub(/Pipeline$|Parallel$|Router$/, '').split('::') %>
          <% if name_parts.length > 1 %>
            <span class="text-gray-400 dark:text-gray-500 font-normal"><%= name_parts[0..-2].join('::') %>::</span>
          <% end %>
          <%= name_parts.last %>
        </h3>
        <span class="hidden sm:inline text-sm text-gray-500 dark:text-gray-400">v<%= workflow[:version] %></span>
        <% if workflow[:active] %>
          <span class="inline-flex items-center px-1.5 py-0.5 rounded text-[10px] font-medium bg-green-100 dark:bg-green-900/50 text-green-800 dark:text-green-300">Active</span>
        <% else %>
          <span class="inline-flex items-center px-1.5 py-0.5 rounded text-[10px] font-medium bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-400">Deleted</span>
        <% end %>
      </div>
      <span class="hidden sm:block text-sm text-gray-500 dark:text-gray-400">
        <%= workflow[:workflow_children]&.size || 0 %> <%= child_label %>
      </span>
    </div>

    <!-- Description -->
    <% if workflow[:description].present? %>
      <p class="mt-1 text-sm text-gray-500 dark:text-gray-400 line-clamp-2">
        <%= workflow[:description] %>
      </p>
    <% end %>

    <!-- Stats Row -->
    <div class="mt-2 sm:mt-3 sm:border-t sm:border-gray-100 sm:dark:border-gray-700 sm:pt-3">
      <% success_rate = workflow[:success_rate] || 0 %>
      <!-- Mobile: compact inline -->
      <div class="sm:hidden text-xs text-gray-500 dark:text-gray-400">
        <%= number_with_delimiter(workflow[:execution_count]) %> runs
        <span class="mx-1 text-gray-300 dark:text-gray-600">-</span>
        $<%= number_with_precision(workflow[:total_cost] || 0, precision: 2) %>
        <span class="mx-1 text-gray-300 dark:text-gray-600">-</span>
        <span class="<%= success_rate >= 95 ? 'text-green-600 dark:text-green-400' : success_rate >= 80 ? 'text-yellow-600 dark:text-yellow-400' : 'text-red-600 dark:text-red-400' %>">
          <%= success_rate %>%
        </span>
      </div>

      <!-- Desktop: full stats with icons -->
      <div class="hidden sm:flex items-center justify-between text-sm">
        <div class="flex items-center space-x-6">
          <div class="flex items-center text-gray-600 dark:text-gray-300">
            <svg class="w-4 h-4 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
            </svg>
            <span><%= number_with_delimiter(workflow[:execution_count]) %> executions</span>
          </div>
          <div class="flex items-center text-gray-600 dark:text-gray-300">
            <svg class="w-4 h-4 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            <span>$<%= number_with_precision(workflow[:total_cost] || 0, precision: 4) %></span>
          </div>
          <div class="flex items-center">
            <% if success_rate >= 95 %>
              <span class="w-2 h-2 rounded-full bg-green-500 mr-1.5"></span>
              <span class="text-green-600 dark:text-green-400"><%= success_rate %>%</span>
            <% elsif success_rate >= 80 %>
              <span class="w-2 h-2 rounded-full bg-yellow-500 mr-1.5"></span>
              <span class="text-yellow-600 dark:text-yellow-400"><%= success_rate %>%</span>
            <% else %>
              <span class="w-2 h-2 rounded-full bg-red-500 mr-1.5"></span>
              <span class="text-red-600 dark:text-red-400"><%= success_rate %>%</span>
            <% end %>
          </div>
        </div>
        <div class="text-gray-400 dark:text-gray-500">
          <% if workflow[:last_executed] %>
            <%= time_ago_in_words(workflow[:last_executed]) %> ago
          <% else %>
            Never executed
          <% end %>
        </div>
      </div>
    </div>
  <% end %>

  <!-- Expandable Child Agents Section -->
  <% if workflow[:workflow_children].present? && workflow[:workflow_children].any? %>
    <div class="border-t border-gray-100 dark:border-gray-700 px-4 sm:px-5 py-2">
      <button type="button" @click.prevent="expanded = !expanded" class="w-full flex items-center justify-between text-sm text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300">
        <span class="font-medium">
          <%= child_label.capitalize %> (<%= workflow[:workflow_children].size %>)
        </span>
        <svg class="w-4 h-4 transition-transform duration-200" :class="{ 'rotate-180': expanded }" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
        </svg>
      </button>

      <div x-show="expanded" x-cloak x-transition:enter="transition ease-out duration-200" x-transition:enter-start="opacity-0 -translate-y-1" x-transition:enter-end="opacity-100 translate-y-0" class="mt-2 space-y-1">
        <% workflow[:workflow_children].each_with_index do |child, index| %>
          <div class="flex items-center gap-2 text-sm py-1.5 px-2 rounded bg-gray-50 dark:bg-gray-900/50">
            <span class="w-5 h-5 flex items-center justify-center rounded-full <%= colors[:icon_bg] %> text-xs <%= colors[:icon_text] %>">
              <%= index + 1 %>
            </span>
            <span class="font-medium text-gray-700 dark:text-gray-300"><%= child[:name] %></span>
            <span class="text-gray-400 dark:text-gray-500">-></span>
            <span class="text-gray-600 dark:text-gray-400 font-mono text-xs"><%= child[:agent] %></span>
            <% if child[:optional] %>
              <span class="text-xs text-gray-400 dark:text-gray-500 italic">(optional)</span>
            <% end %>
            <% if child[:description].present? %>
              <span class="text-xs text-gray-400 dark:text-gray-500 truncate max-w-xs" title="<%= child[:description] %>">
                - <%= child[:description].truncate(30) %>
              </span>
            <% end %>
          </div>
        <% end %>
      </div>
    </div>
  <% end %>
</div>
