<%
  # Multi-select filter dropdown with Alpine.js
  # Usage:
  #   render "ruby_llm/agents/shared/filter_dropdown",
  #     name: "statuses[]",
  #     filter_id: "statuses",
  #     label: "Status",
  #     all_label: "All Statuses",
  #     options: [
  #       { value: "success", label: "Success", color: "bg-green-500" },
  #       { value: "error", label: "Error", color: "bg-red-500" }
  #     ],
  #     selected: ["success"]

  selected = local_assigns[:selected] || []
  show_all = local_assigns.fetch(:show_all_option, true)
  all_label = local_assigns[:all_label] || "All"

  current_label = if selected.empty?
    label
  elsif selected.length == 1
    opt = options.find { |o| o[:value].to_s == selected.first.to_s }
    opt ? opt[:label] : selected.first
  else
    "#{selected.length} #{label}"
  end

  current_color = if selected.length == 1
    opt = options.find { |o| o[:value].to_s == selected.first.to_s }
    opt&.dig(:color)
  end

  has_selection = selected.any?
%>
<div class="relative" x-data="{ open: false }" @click.outside="open = false" data-filter="<%= filter_id %>">
  <button type="button" @click="open = !open"
    class="flex items-center gap-1.5 px-2 py-1 font-mono text-xs rounded
           hover:bg-gray-100 dark:hover:bg-gray-800/50 transition-colors
           <%= has_selection ? 'text-gray-900 dark:text-gray-100' : 'text-gray-400 dark:text-gray-500' %>">
    <% if current_color.present? %>
      <span class="w-1.5 h-1.5 rounded-full <%= current_color %> <%= current_color.include?('blue') && selected.first == 'running' ? 'animate-pulse' : '' %>"></span>
    <% end %>
    <span><%= current_label %></span>
    <svg class="w-3 h-3 text-gray-400 dark:text-gray-600 transition-transform" :class="{ 'rotate-180': open }" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
    </svg>
  </button>

  <div x-show="open" x-cloak x-transition:enter="transition ease-out duration-100"
       x-transition:enter-start="opacity-0 scale-95" x-transition:enter-end="opacity-100 scale-100"
       x-transition:leave="transition ease-in duration-75"
       x-transition:leave-start="opacity-100 scale-100" x-transition:leave-end="opacity-0 scale-95"
       class="absolute z-20 mt-1 min-w-max bg-white dark:bg-gray-800 rounded-lg shadow-lg border border-gray-200 dark:border-gray-700 py-1 max-h-64 overflow-y-auto">

    <% if show_all %>
      <div class="px-3 py-1.5 border-b border-gray-100 dark:border-gray-700">
        <label class="flex items-center gap-2 cursor-pointer font-mono text-xs">
          <input type="checkbox"
                 class="rounded border-gray-300 dark:border-gray-600 text-blue-600 focus:ring-blue-500 dark:bg-gray-700"
                 <%= selected.empty? ? 'checked' : '' %>
                 @change="
                   $el.closest('[data-filter]').querySelectorAll('.filter-cb').forEach(c => c.checked = false);
                   $el.closest('form').requestSubmit();
                 ">
          <span class="text-gray-700 dark:text-gray-200"><%= all_label %></span>
        </label>
      </div>
    <% end %>

    <% options.each do |option| %>
      <div class="flex items-center gap-2 px-3 py-1.5 font-mono text-xs text-gray-700 dark:text-gray-200 hover:bg-gray-50 dark:hover:bg-gray-700">
        <input type="checkbox"
               name="<%= name %>"
               value="<%= option[:value] %>"
               class="filter-cb rounded border-gray-300 dark:border-gray-600 text-blue-600 focus:ring-blue-500 dark:bg-gray-700"
               <%= selected.include?(option[:value].to_s) ? 'checked' : '' %>
               @change="$el.closest('form').requestSubmit()">
        <span class="flex-1 flex items-center gap-1.5 cursor-pointer"
              @click.prevent="
                $el.closest('[data-filter]').querySelectorAll('.filter-cb').forEach(c => c.checked = false);
                $el.previousElementSibling.checked = true;
                open = false;
                $el.closest('form').requestSubmit();
              ">
          <% if option[:color].present? %>
            <span class="w-1.5 h-1.5 rounded-full <%= option[:color] %> <%= option[:color].include?('blue') && option[:value] == 'running' ? 'animate-pulse' : '' %>"></span>
          <% end %>
          <%= option[:label] %>
        </span>
      </div>
    <% end %>
  </div>
</div>
