<%# Show tenant column when multi-tenancy is enabled and no specific tenant is selected %>
<% show_tenant_column = tenant_filter_enabled? && current_tenant_id.blank? %>
<% show_agent_column = !local_assigns.fetch(:hide_agent_column, false) %>

<% if executions.empty? %>
  <div class="font-mono text-xs text-gray-400 dark:text-gray-600 py-4 px-2">no executions found</div>
<% else %>
  <!-- Column headers -->
  <div class="flex items-center gap-3 px-2 -mx-2 font-mono text-[10px] text-gray-400 dark:text-gray-600 uppercase tracking-wider mb-1">
    <span class="w-20 flex-shrink-0">status</span>
    <% if show_agent_column %>
      <span class="flex-1 min-w-0">agent</span>
    <% end %>
    <% if show_tenant_column %>
      <span class="flex-1 min-w-0 hidden sm:block">tenant</span>
    <% end %>
    <span class="flex-1 min-w-0 hidden lg:block">model</span>
    <span class="w-16 flex-shrink-0 text-right">duration</span>
    <span class="w-16 flex-shrink-0 text-right hidden md:block">tokens</span>
    <span class="w-16 flex-shrink-0 text-right hidden md:block">cost</span>
    <span class="w-24 flex-shrink-0 text-right">time</span>
  </div>

  <!-- Rows -->
  <div class="font-mono text-xs space-y-px">
    <% executions.each do |execution| %>
      <%
        status_badge_class = case execution.status.to_s
          when "running" then "badge-running"
          when "success" then "badge-success"
          when "error" then "badge-error"
          when "timeout" then "badge-timeout"
          else "badge-timeout"
        end
      %>
      <div class="group flex items-center gap-3 py-1.5 px-2 -mx-2 rounded hover:bg-gray-100 dark:hover:bg-gray-800/50 cursor-pointer"
           onclick="window.location='<%= ruby_llm_agents.execution_path(execution) %>'">
        <span class="w-20 flex-shrink-0"><span class="badge <%= status_badge_class %>" style="font-size: 10px; padding: 1px 6px;"><%= execution.status %></span></span>
        <% if show_agent_column %>
          <span class="flex-1 min-w-0 truncate text-gray-900 dark:text-gray-200"><%= execution.agent_type.gsub(/Agent$/, "") %></span>
        <% end %>
        <% if show_tenant_column %>
          <span class="flex-1 min-w-0 truncate text-gray-400 dark:text-gray-600 hidden sm:inline"><%= execution.tenant_id.present? ? truncate(execution.tenant_id, length: 30) : "—" %></span>
        <% end %>
        <span class="flex-1 min-w-0 truncate text-gray-400 dark:text-gray-600 hidden lg:inline"><%= execution.model_id %></span>
        <span class="w-16 flex-shrink-0 text-right text-gray-500 dark:text-gray-400">
          <% if execution.status_running? %>
            <span class="text-blue-500 animate-pulse">...</span>
          <% else %>
            <%= execution.duration_ms ? format_duration_ms(execution.duration_ms) : "—" %>
          <% end %>
        </span>
        <span class="w-16 flex-shrink-0 text-right text-gray-500 dark:text-gray-400 hidden md:inline"><%= number_with_delimiter(execution.total_tokens || 0) %></span>
        <span class="w-16 flex-shrink-0 text-right text-gray-500 dark:text-gray-400 hidden md:inline">$<%= number_with_precision(execution.total_cost || 0, precision: 4) %></span>
        <span class="w-24 flex-shrink-0 text-gray-400 dark:text-gray-600 text-right whitespace-nowrap"><%= time_ago_in_words(execution.created_at) %></span>
      </div>
      <% if execution.status_error? && execution.error_message.present? %>
        <div class="flex items-center gap-1 pl-5 py-0.5 text-red-400 dark:text-red-500/70 text-xs font-mono">
          <span class="text-gray-300 dark:text-gray-700">└</span>
          <span class="truncate"><%= execution.error_class %>: <%= truncate(execution.error_message, length: 100) %></span>
        </div>
      <% end %>
    <% end %>
  </div>

  <%# Pagination %>
  <% if pagination[:total_pages] > 1 %>
    <%
      current_page = pagination[:current_page]
      total_pages = pagination[:total_pages]
      total_count = pagination[:total_count]
      per_page = pagination[:per_page]
      from_record = ((current_page - 1) * per_page) + 1
      to_record = [current_page * per_page, total_count].min
    %>
    <div class="flex items-center justify-between font-mono text-xs mt-4 pt-4 border-t border-gray-200 dark:border-gray-800">
      <span class="text-gray-400 dark:text-gray-600"><%= from_record %>-<%= to_record %> of <%= number_with_delimiter(total_count) %></span>
      <nav class="flex items-center gap-1">
        <% if current_page > 1 %>
          <%= link_to "prev", url_for(request.query_parameters.merge(page: current_page - 1)),
              class: "px-2 py-0.5 text-gray-400 dark:text-gray-500 hover:text-gray-700 dark:hover:text-gray-300" %>
        <% else %>
          <span class="px-2 py-0.5 text-gray-300 dark:text-gray-700">prev</span>
        <% end %>

        <%
          window = 2
          pages_to_show = []
          (1..total_pages).each do |page|
            if page <= 1 || page >= total_pages || (page >= current_page - window && page <= current_page + window)
              pages_to_show << page
            elsif pages_to_show.last != :gap
              pages_to_show << :gap
            end
          end
        %>

        <% pages_to_show.each do |page| %>
          <% if page == :gap %>
            <span class="px-1 text-gray-400 dark:text-gray-600">...</span>
          <% elsif page == current_page %>
            <span class="px-2 py-0.5 text-gray-900 dark:text-gray-100"><%= page %></span>
          <% else %>
            <%= link_to page, url_for(request.query_parameters.merge(page: page)),
                class: "px-2 py-0.5 text-gray-400 dark:text-gray-500 hover:text-gray-700 dark:hover:text-gray-300" %>
          <% end %>
        <% end %>

        <% if current_page < total_pages %>
          <%= link_to "next", url_for(request.query_parameters.merge(page: current_page + 1)),
              class: "px-2 py-0.5 text-gray-400 dark:text-gray-500 hover:text-gray-700 dark:hover:text-gray-300" %>
        <% else %>
          <span class="px-2 py-0.5 text-gray-300 dark:text-gray-700">next</span>
        <% end %>
      </nav>
    </div>
  <% end %>
<% end %>
