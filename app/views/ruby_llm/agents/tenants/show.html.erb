<!-- Back link -->
<nav class="font-mono text-xs mb-6">
  <%= link_to "← tenants", ruby_llm_agents.tenants_path, class: "text-gray-400 dark:text-gray-500 hover:text-gray-700 dark:hover:text-gray-300" %>
</nav>

<%
  enforcement = @tenant.effective_enforcement.to_s
  total_executions = @usage_stats[:total_executions]
  total_cost = @usage_stats[:total_cost]
  total_tokens = @usage_stats[:total_tokens]
  success_count = @tenant.executions.where(status: "success").count
  success_rate = total_executions > 0 ? (success_count.to_f / total_executions * 100).round : 100

  has_any_limit = @tenant.effective_daily_limit || @tenant.effective_monthly_limit ||
                  @tenant.effective_daily_token_limit || @tenant.effective_monthly_token_limit

  has_per_agent = @tenant.per_agent_daily.present? || @tenant.per_agent_monthly.present?

  # Build config line parts
  config_parts = [@tenant.tenant_id]
  config_parts << enforcement if enforcement != "none"
  config_parts << "daily $#{number_with_precision(@tenant.effective_daily_limit, precision: 2)}" if @tenant.effective_daily_limit
  config_parts << "monthly $#{number_with_precision(@tenant.effective_monthly_limit, precision: 2)}" if @tenant.effective_monthly_limit
%>

<!-- ── tenant header ──────────────── -->
<div class="flex items-start justify-between gap-8 mb-2">
  <!-- Left: identity -->
  <div class="min-w-0">
    <div class="flex items-center gap-3 mb-1.5">
      <span class="text-[10px] font-medium text-gray-400 dark:text-gray-600 uppercase tracking-widest font-mono"><%= @tenant.display_name %></span>
      <%= link_to edit_tenant_path(@tenant), class: "text-gray-400 dark:text-gray-500 hover:text-gray-600 dark:hover:text-gray-300 transition-colors", title: "Edit tenant" do %>
        <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
        </svg>
      <% end %>
      <%= render "ruby_llm/agents/shared/doc_link" %>
    </div>
    <div class="font-mono text-xs text-gray-400 dark:text-gray-500 flex items-center gap-1.5 flex-wrap">
      <span class="text-gray-500 dark:text-gray-400"><%= @tenant.tenant_id %></span>
      <% if enforcement != "none" %>
        <span class="text-gray-300 dark:text-gray-700">&middot;</span>
        <%
          enforcement_badge = enforcement == "hard" ? "badge-error" : "badge-timeout"
        %>
        <span class="badge badge-sm <%= enforcement_badge %>"><%= enforcement %></span>
      <% end %>
      <% if @tenant.effective_daily_limit %>
        <span class="text-gray-300 dark:text-gray-700">&middot;</span>
        <span>daily $<%= number_with_precision(@tenant.effective_daily_limit, precision: 2) %></span>
      <% end %>
      <% if @tenant.effective_monthly_limit %>
        <span class="text-gray-300 dark:text-gray-700">&middot;</span>
        <span>monthly $<%= number_with_precision(@tenant.effective_monthly_limit, precision: 2) %></span>
      <% end %>
    </div>
  </div>

  <!-- Right: stats -->
  <div class="flex-shrink-0 text-right font-mono text-xs text-gray-400 dark:text-gray-500 space-y-1">
    <div class="flex items-center justify-end gap-x-4">
      <span><span class="text-gray-800 dark:text-gray-200"><%= number_with_delimiter(total_executions) %></span> runs</span>
      <span class="<%= success_rate >= 95 ? 'text-green-500' : success_rate >= 80 ? 'text-yellow-500' : 'text-red-500' %>"><%= success_rate %>% ok</span>
      <span><span class="text-gray-800 dark:text-gray-200">$<%= number_with_precision(total_cost, precision: 4) %></span> cost</span>
    </div>
    <div class="flex items-center justify-end gap-x-4 text-gray-500 dark:text-gray-600">
      <span><span class="text-gray-600 dark:text-gray-400"><%= number_with_delimiter(total_tokens) %></span> tokens</span>
    </div>
  </div>
</div>
<div class="border-t border-gray-200 dark:border-gray-800 mb-2"></div>

<% if has_any_limit %>
  <!-- ── budget ──────────────────────── -->
  <div class="flex items-center gap-3 mt-6 mb-3">
    <span class="text-[10px] font-medium text-gray-400 dark:text-gray-600 uppercase tracking-widest font-mono">budget</span>
    <div class="flex-1 border-t border-gray-200 dark:border-gray-800"></div>
  </div>

  <div class="font-mono text-xs space-y-2">
    <% if @tenant.effective_daily_limit %>
      <%
        pct = @usage_stats[:daily_spend_percentage]
        bar_color = pct >= 90 ? 'bg-red-500' : pct >= 70 ? 'bg-yellow-500' : 'bg-green-500'
      %>
      <div class="flex items-center gap-3">
        <span class="w-28 flex-shrink-0 text-gray-500 dark:text-gray-400">daily cost</span>
        <span class="w-44 flex-shrink-0 text-gray-800 dark:text-gray-200">$<%= number_with_precision(@usage_stats[:daily_spend], precision: 2) %> <span class="text-gray-400 dark:text-gray-600">/ $<%= number_with_precision(@tenant.effective_daily_limit, precision: 2) %></span></span>
        <span class="w-12 flex-shrink-0 text-right text-gray-400 dark:text-gray-600"><%= pct %>%</span>
        <div class="flex-1 bg-gray-200 dark:bg-gray-800 rounded-full h-1">
          <div class="<%= bar_color %> h-1 rounded-full transition-all" style="width: <%= [pct, 100].min %>%"></div>
        </div>
      </div>
    <% end %>

    <% if @tenant.effective_monthly_limit %>
      <%
        pct = @usage_stats[:monthly_spend_percentage]
        bar_color = pct >= 90 ? 'bg-red-500' : pct >= 70 ? 'bg-yellow-500' : 'bg-green-500'
      %>
      <div class="flex items-center gap-3">
        <span class="w-28 flex-shrink-0 text-gray-500 dark:text-gray-400">monthly cost</span>
        <span class="w-44 flex-shrink-0 text-gray-800 dark:text-gray-200">$<%= number_with_precision(@usage_stats[:monthly_spend], precision: 2) %> <span class="text-gray-400 dark:text-gray-600">/ $<%= number_with_precision(@tenant.effective_monthly_limit, precision: 2) %></span></span>
        <span class="w-12 flex-shrink-0 text-right text-gray-400 dark:text-gray-600"><%= pct %>%</span>
        <div class="flex-1 bg-gray-200 dark:bg-gray-800 rounded-full h-1">
          <div class="<%= bar_color %> h-1 rounded-full transition-all" style="width: <%= [pct, 100].min %>%"></div>
        </div>
      </div>
    <% end %>

    <% if @tenant.effective_daily_token_limit %>
      <%
        pct = @usage_stats[:daily_token_percentage]
        bar_color = pct >= 90 ? 'bg-red-500' : pct >= 70 ? 'bg-yellow-500' : 'bg-green-500'
      %>
      <div class="flex items-center gap-3">
        <span class="w-28 flex-shrink-0 text-gray-500 dark:text-gray-400">daily tokens</span>
        <span class="w-44 flex-shrink-0 text-gray-800 dark:text-gray-200"><%= number_with_delimiter(@usage_stats[:daily_tokens]) %> <span class="text-gray-400 dark:text-gray-600">/ <%= number_with_delimiter(@tenant.effective_daily_token_limit) %></span></span>
        <span class="w-12 flex-shrink-0 text-right text-gray-400 dark:text-gray-600"><%= pct %>%</span>
        <div class="flex-1 bg-gray-200 dark:bg-gray-800 rounded-full h-1">
          <div class="<%= bar_color %> h-1 rounded-full transition-all" style="width: <%= [pct, 100].min %>%"></div>
        </div>
      </div>
    <% end %>

    <% if @tenant.effective_monthly_token_limit %>
      <%
        pct = @usage_stats[:monthly_token_percentage]
        bar_color = pct >= 90 ? 'bg-red-500' : pct >= 70 ? 'bg-yellow-500' : 'bg-green-500'
      %>
      <div class="flex items-center gap-3">
        <span class="w-28 flex-shrink-0 text-gray-500 dark:text-gray-400">monthly tokens</span>
        <span class="w-44 flex-shrink-0 text-gray-800 dark:text-gray-200"><%= number_with_delimiter(@usage_stats[:monthly_tokens]) %> <span class="text-gray-400 dark:text-gray-600">/ <%= number_with_delimiter(@tenant.effective_monthly_token_limit) %></span></span>
        <span class="w-12 flex-shrink-0 text-right text-gray-400 dark:text-gray-600"><%= pct %>%</span>
        <div class="flex-1 bg-gray-200 dark:bg-gray-800 rounded-full h-1">
          <div class="<%= bar_color %> h-1 rounded-full transition-all" style="width: <%= [pct, 100].min %>%"></div>
        </div>
      </div>
    <% end %>
  </div>
<% end %>

<% if has_per_agent %>
  <!-- ── config ──────────────────────── -->
  <div class="flex items-center gap-3 mt-6 mb-3">
    <span class="text-[10px] font-medium text-gray-400 dark:text-gray-600 uppercase tracking-widest font-mono">config</span>
    <div class="flex-1 border-t border-gray-200 dark:border-gray-800"></div>
  </div>

  <div class="font-mono text-xs">
    <span class="text-gray-400 dark:text-gray-600">per-agent limits:</span>
    <div class="mt-1 space-y-0.5 pl-2">
      <% (@tenant.per_agent_daily || {}).each do |agent, limit| %>
        <div class="flex items-center gap-2">
          <span class="text-gray-900 dark:text-gray-200"><%= agent %></span>
          <span class="text-gray-400 dark:text-gray-600">daily $<%= number_with_precision(limit, precision: 2) %></span>
        </div>
      <% end %>
      <% (@tenant.per_agent_monthly || {}).each do |agent, limit| %>
        <div class="flex items-center gap-2">
          <span class="text-gray-900 dark:text-gray-200"><%= agent %></span>
          <span class="text-gray-400 dark:text-gray-600">monthly $<%= number_with_precision(limit, precision: 2) %></span>
        </div>
      <% end %>
    </div>
  </div>
<% end %>

<!-- ── recent executions ──────────────────── -->
<div class="flex items-center gap-3 mt-6 mb-3">
  <span class="text-[10px] font-medium text-gray-400 dark:text-gray-600 uppercase tracking-widest font-mono">recent executions</span>
  <div class="flex-1 border-t border-gray-200 dark:border-gray-800"></div>
</div>

<%= render "ruby_llm/agents/shared/executions_table", executions: @executions, pagination: { total_pages: 0, current_page: 1, total_count: 0, per_page: 10 } %>

<% if total_executions > 0 %>
  <div class="mt-3 font-mono text-xs">
    <%= link_to ruby_llm_agents.executions_path(tenant_id: @tenant.tenant_id),
        class: "text-gray-400 dark:text-gray-500 hover:text-gray-700 dark:hover:text-gray-300" do %>
      show all <%= number_with_delimiter(total_executions) %> executions →
    <% end %>
  </div>
<% end %>
