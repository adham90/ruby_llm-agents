<%= render "ruby_llm/agents/shared/breadcrumbs", items: [
  { label: "Dashboard", path: ruby_llm_agents.root_path },
  { label: "Workflows", path: ruby_llm_agents.agents_path(tab: "workflows") },
  { label: @workflow_type.split('::').last }
] %>

<!-- Header -->
<div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6 mb-6">
  <div class="flex items-start justify-between">
    <div>
      <div class="flex items-center space-x-3">
        <%= render "ruby_llm/agents/shared/workflow_type_badge", workflow_type: @workflow_type_kind, size: :md %>
        <h1 class="text-2xl font-bold text-gray-900 dark:text-gray-100">
          <% name_parts = @workflow_type.split('::') %>
          <% if name_parts.length > 1 %>
            <span class="text-gray-400 dark:text-gray-500 font-normal"><%= name_parts[0..-2].join('::') %>::</span>
          <% end %>
          <%= name_parts.last %>
        </h1>
        <%= render "ruby_llm/agents/shared/doc_link" %>

        <% if @workflow_active %>
          <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 dark:bg-green-900/50 text-green-800 dark:text-green-300">
            Active
          </span>
        <% else %>
          <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-400">
            Deleted
          </span>
        <% end %>

        <% if @config %>
          <span class="text-sm text-gray-500 dark:text-gray-400">
            v<%= @config[:version] %>
          </span>
        <% end %>
      </div>

      <% if @config && @config[:description].present? %>
        <p class="text-gray-600 dark:text-gray-300 mt-2 max-w-2xl">
          <%= @config[:description] %>
        </p>
      <% end %>
    </div>

    <div class="text-right">
      <p class="text-sm text-gray-500 dark:text-gray-400">
        <%= number_with_delimiter(@stats[:count]) %> total executions
      </p>

      <div class="flex items-center justify-end gap-3 mt-1">
        <% status_colors = {
            "success" => "bg-green-500",
            "error" => "bg-red-500",
            "timeout" => "bg-yellow-500",
            "running" => "bg-blue-500"
          } %>

        <% @status_distribution.each do |status, count| %>
          <div class="flex items-center gap-1">
            <span class="w-2 h-2 rounded-full <%= status_colors[status] || 'bg-gray-400' %> <%= status == 'running' ? 'animate-pulse' : '' %>"></span>
            <span class="text-xs text-gray-600 dark:text-gray-400">
              <%= number_with_delimiter(count) %>
            </span>
          </div>
        <% end %>
      </div>
    </div>
  </div>
</div>

<!-- Workflow Details Panel -->
<% if @config %>
  <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-4 mb-6">
    <div class="flex flex-wrap items-center gap-x-6 gap-y-2">
      <!-- Structure Summary -->
      <div class="flex items-center gap-4 text-sm">
        <% if @steps.present? %>
          <span class="text-gray-700 dark:text-gray-300">
            <span class="font-medium"><%= @steps.size %></span>
            <span class="text-gray-500 dark:text-gray-400">steps</span>
          </span>
        <% end %>
        <% if @parallel_groups.present? && @parallel_groups.any? %>
          <span class="text-purple-600 dark:text-purple-400">
            <span class="font-medium"><%= @parallel_groups.size %></span> parallel
          </span>
        <% end %>
        <% if @config[:has_routing] %>
          <span class="text-amber-600 dark:text-amber-400">routing</span>
        <% end %>
      </div>

      <!-- Divider -->
      <span class="hidden sm:block w-px h-5 bg-gray-200 dark:bg-gray-700"></span>

      <!-- Constraints -->
      <div class="flex items-center gap-4 text-sm text-gray-600 dark:text-gray-400">
        <% if @config[:timeout] %>
          <span class="inline-flex items-center gap-1">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
            <%= @config[:timeout] %>s timeout
          </span>
        <% end %>
        <% if @config[:max_cost] %>
          <span class="inline-flex items-center gap-1">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"/></svg>
            $<%= @config[:max_cost] %> max
          </span>
        <% end %>
      </div>

      <!-- Divider -->
      <% if @config[:has_lifecycle_hooks] || @config[:has_conditions] || @config[:has_retries] || @config[:has_fallbacks] || @config[:has_input_schema] %>
        <span class="hidden sm:block w-px h-5 bg-gray-200 dark:bg-gray-700"></span>
      <% end %>

      <!-- Features -->
      <div class="flex flex-wrap items-center gap-2">
        <% if @config[:has_input_schema] %>
          <span class="text-xs px-2 py-1 rounded-full bg-green-100 dark:bg-green-900/50 text-green-700 dark:text-green-300">
            Input Schema
          </span>
        <% end %>
        <% if @config[:has_lifecycle_hooks] %>
          <span class="text-xs px-2 py-1 rounded-full bg-emerald-100 dark:bg-emerald-900/50 text-emerald-700 dark:text-emerald-300">
            Lifecycle Hooks
          </span>
        <% end %>
        <% if @config[:has_conditions] %>
          <span class="text-xs px-2 py-1 rounded-full bg-cyan-100 dark:bg-cyan-900/50 text-cyan-700 dark:text-cyan-300">
            Conditional
          </span>
        <% end %>
        <% if @config[:has_retries] %>
          <span class="text-xs px-2 py-1 rounded-full bg-orange-100 dark:bg-orange-900/50 text-orange-700 dark:text-orange-300">
            Retries
          </span>
        <% end %>
        <% if @config[:has_fallbacks] %>
          <span class="text-xs px-2 py-1 rounded-full bg-yellow-100 dark:bg-yellow-900/50 text-yellow-700 dark:text-yellow-300">
            Fallbacks
          </span>
        <% end %>
      </div>
    </div>
  </div>
<% end %>

<!-- Workflow Structure -->
<div id="structure" class="bg-white dark:bg-gray-800 rounded-lg shadow p-6 mb-6 scroll-mt-16" x-data="{ expanded: false }">
  <div class="flex items-center justify-between mb-4">
    <h3 class="text-lg font-semibold text-gray-900 dark:text-gray-100">
      Workflow Structure
    </h3>

    <button @click="expanded = !expanded" class="inline-flex items-center gap-2 px-3 py-1.5 text-sm font-medium text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-colors cursor-pointer">
      <span x-text="expanded ? 'Collapse' : 'Expand'">Collapse</span>
      <svg class="w-4 h-4 transition-transform duration-200" :class="expanded ? 'rotate-180' : ''" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
      </svg>
    </button>
  </div>

  <!-- Collapsed: Compact Flow Summary -->
  <div x-show="!expanded" x-collapse class="py-4">
    <div class="flex items-center justify-center gap-2 flex-wrap">
      <!-- Start -->
      <span class="px-3 py-1 rounded-full bg-green-100 dark:bg-green-900/50 text-green-700 dark:text-green-300 text-sm font-medium">
        Start
      </span>

      <% (@steps || []).each_with_index do |step, idx| %>
        <svg class="w-4 h-4 text-gray-400 dark:text-gray-500 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
        </svg>

        <%
          step_bg = if step[:workflow]
            "bg-emerald-100 dark:bg-emerald-900/50 text-emerald-700 dark:text-emerald-300"
          elsif step[:iteration]
            "bg-blue-100 dark:bg-blue-900/50 text-blue-700 dark:text-blue-300"
          elsif step[:routing]
            "bg-amber-100 dark:bg-amber-900/50 text-amber-700 dark:text-amber-300"
          elsif step[:parallel_group]
            "bg-purple-100 dark:bg-purple-900/50 text-purple-700 dark:text-purple-300"
          else
            "bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300"
          end
        %>
        <span class="px-3 py-1 rounded-full <%= step_bg %> text-sm font-medium">
          <%= step[:name].to_s.titleize.truncate(20) %>
        </span>
      <% end %>

      <svg class="w-4 h-4 text-gray-400 dark:text-gray-500 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
      </svg>

      <!-- End -->
      <span class="px-3 py-1 rounded-full bg-red-100 dark:bg-red-900/50 text-red-700 dark:text-red-300 text-sm font-medium">
        End
      </span>
    </div>

    <p class="text-center text-xs text-gray-500 dark:text-gray-400 mt-3">
      Click "Expand" to see full diagram with details
    </p>
  </div>

  <!-- Expanded: Full Diagram -->
  <div x-show="expanded" x-collapse>
    <%= render "ruby_llm/agents/workflows/workflow_diagram",
        steps: @steps || [],
        parallel_groups: @parallel_groups || [],
        input_schema_fields: @input_schema_fields || {},
        lifecycle_hooks: @lifecycle_hooks || {} %>
  </div>
</div>

<!-- Stats Grid -->
<% success_rate = @stats[:success_rate] || 0 %>
<% success_rate_color = success_rate >= 95 ? 'text-green-600' : success_rate >= 80 ? 'text-yellow-600' : 'text-red-600' %>

<div id="stats" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4 mb-6 scroll-mt-16">
  <%= render "ruby_llm/agents/shared/stat_card",
      title: "Executions",
      value: number_with_delimiter(@stats[:count]),
      subtitle: "Today: #{@stats_today[:count]}",
      icon: "M13 10V3L4 14h7v7l9-11h-7z",
      icon_color: "text-blue-500" %>

  <%= render "ruby_llm/agents/shared/stat_card",
      title: "Success Rate",
      value: "#{success_rate}%",
      subtitle: "Error rate: #{@stats[:error_rate] || 0}%",
      icon: "M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z",
      icon_color: "text-green-500",
      value_color: success_rate_color %>

  <%= render "ruby_llm/agents/shared/stat_card",
      title: "Total Cost",
      value: "$#{number_with_precision(@stats[:total_cost] || 0, precision: 4)}",
      subtitle: "Avg: $#{number_with_precision(@stats[:avg_cost] || 0, precision: 6)}",
      icon: "M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z",
      icon_color: "text-amber-500" %>

  <%= render "ruby_llm/agents/shared/stat_card",
      title: "Total Tokens",
      value: number_with_delimiter(@stats[:total_tokens] || 0),
      subtitle: "Avg: #{number_with_delimiter(@stats[:avg_tokens] || 0)}",
      icon: "M7 20l4-16m2 16l4-16M6 9h14M4 15h14",
      icon_color: "text-indigo-500" %>

  <%= render "ruby_llm/agents/shared/stat_card",
      title: "Avg Duration",
      value: "#{number_with_delimiter(@stats[:avg_duration_ms] || 0)} ms",
      icon: "M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z",
      icon_color: "text-purple-500" %>
</div>

<!-- Step Performance -->
<% if @step_stats.present? %>
  <div id="performance" class="scroll-mt-16">
    <%= render "ruby_llm/agents/workflows/step_performance",
        workflow_type: @workflow_type_kind,
        step_stats: @step_stats %>
  </div>
<% end %>

<!-- Charts Section -->
<div id="trends" class="bg-white dark:bg-gray-800 rounded-lg shadow mb-6 scroll-mt-16"
     x-data="{ expanded: false, chartsInitialized: false }"
     x-effect="if (expanded && !chartsInitialized) { $nextTick(() => { window.initWorkflowCharts && window.initWorkflowCharts(); chartsInitialized = true; }); }">
  <div class="flex items-center justify-between p-4 border-b border-gray-100 dark:border-gray-700">
    <h3 class="text-lg font-semibold text-gray-900 dark:text-gray-100">
      Trends (30 days)
    </h3>

    <button @click="expanded = !expanded" class="inline-flex items-center gap-2 px-3 py-1.5 text-sm font-medium text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-colors cursor-pointer">
      <span x-text="expanded ? 'Hide Charts' : 'Show Charts'">Show Charts</span>
      <svg class="w-4 h-4 transition-transform duration-200" :class="expanded ? 'rotate-180' : ''" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
      </svg>
    </button>
  </div>

  <div x-show="expanded" x-collapse>
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 p-6">
      <!-- Executions Over Time -->
      <div>
        <h4 class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-3">Executions</h4>
        <div id="executions-chart" style="height: 200px;"></div>
      </div>

      <!-- Cost Over Time -->
      <div>
        <h4 class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-3">Cost</h4>
        <div id="cost-chart" style="height: 200px;"></div>
      </div>
    </div>
  </div>
</div>

<script>
window.initWorkflowCharts = function() {
  const trendData = <%= raw @trend_data.to_json %>;
  const categories = trendData.map(d => d.date.split('-').slice(1).join('/'));

  // Executions chart
  Highcharts.chart('executions-chart', {
    chart: { type: 'areaspline', backgroundColor: 'transparent' },
    xAxis: { categories: categories, labels: { style: { color: '#9CA3AF' } } },
    yAxis: { min: 0, title: { text: null }, labels: { style: { color: '#9CA3AF' } } },
    legend: { enabled: false },
    plotOptions: { areaspline: { fillOpacity: 0.2, marker: { enabled: false } } },
    series: [
      { name: 'Success', color: '#10B981', data: trendData.map(d => d.count - (d.error_count || 0)) },
      { name: 'Failed', color: '#EF4444', data: trendData.map(d => d.error_count || 0) }
    ]
  });

  // Cost chart
  Highcharts.chart('cost-chart', {
    chart: { type: 'spline', backgroundColor: 'transparent' },
    xAxis: { categories: categories, labels: { style: { color: '#9CA3AF' } } },
    yAxis: { min: 0, title: { text: null }, labels: { style: { color: '#9CA3AF' }, format: '${value}' } },
    legend: { enabled: false },
    plotOptions: { spline: { marker: { enabled: false } } },
    tooltip: { valuePrefix: '$' },
    series: [{ name: 'Cost', color: '#10B981', data: trendData.map(d => parseFloat(d.total_cost) || 0) }]
  });
};
</script>

<!-- Finish Reason Distribution -->
<% if @finish_reason_distribution.present? && @finish_reason_distribution.any? %>
  <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-4 mb-6">
    <div class="flex items-center justify-between">
      <p class="text-sm text-gray-500 dark:text-gray-400 uppercase">
        Finish Reasons
      </p>

      <div class="flex flex-wrap gap-4">
        <% finish_colors = {
            'stop' => '#10B981',
            'length' => '#F59E0B',
            'content_filter' => '#EF4444',
            'tool_calls' => '#3B82F6',
            nil => '#6B7280'
          } %>

        <% @finish_reason_distribution.each do |reason, count| %>
          <div class="flex items-center">
            <span class="w-2 h-2 rounded-full mr-1.5" style="background-color: <%= finish_colors[reason] || '#6B7280' %>"></span>
            <span class="text-sm text-gray-700 dark:text-gray-300">
              <%= reason || 'unknown' %>
            </span>
            <span class="text-sm font-medium text-gray-900 dark:text-gray-100 ml-1">
              (<%= number_with_delimiter(count) %>)
            </span>
          </div>
        <% end %>
      </div>
    </div>
  </div>
<% end %>


<!-- Executions -->
<div id="executions" class="bg-white dark:bg-gray-800 rounded-lg shadow p-6 scroll-mt-16">
  <h3 class="text-lg font-semibold text-gray-900 dark:text-gray-100 mb-4">
    Executions
  </h3>

  <div id="executions_table">
    <%
      has_filters = params[:statuses].present? || params[:versions].present? || params[:models].present? || params[:temperatures].present? || params[:days].present?
      selected_statuses = params[:statuses].present? ? (params[:statuses].is_a?(Array) ? params[:statuses] : params[:statuses].split(",")) : []
      selected_versions = params[:versions].present? ? (params[:versions].is_a?(Array) ? params[:versions] : params[:versions].split(",")) : []
      selected_models = params[:models].present? ? (params[:models].is_a?(Array) ? params[:models] : params[:models].split(",")) : []
      selected_temperatures = params[:temperatures].present? ? (params[:temperatures].is_a?(Array) ? params[:temperatures] : params[:temperatures].split(",")).map(&:to_s) : []

      status_options = [
        { value: "success", label: "Success", color: "bg-green-500" },
        { value: "error", label: "Error", color: "bg-red-500" },
        { value: "running", label: "Running", color: "bg-blue-500" },
        { value: "timeout", label: "Timeout", color: "bg-yellow-500" }
      ]
      version_options = @versions.map { |v| { value: v.to_s, label: "v#{v}" } }
      model_options = @models.map { |m| { value: m, label: m } }
      temperature_options = @temperatures.map { |t| { value: t.to_s, label: t.to_s } }
      days_options = [
        { value: "", label: "All Time" },
        { value: "1", label: "Today" },
        { value: "7", label: "Last 7 Days" },
        { value: "30", label: "Last 30 Days" }
      ]
    %>

    <%= form_with url: ruby_llm_agents.workflow_path(@workflow_type), method: :get, local: true do |f| %>
      <div class="flex flex-wrap items-center gap-3 mb-4 pb-4 border-b border-gray-100 dark:border-gray-700">
        <%# Status Filter (Multi-select) %>
        <%= render "ruby_llm/agents/shared/filter_dropdown",
            name: "statuses[]",
            filter_id: "statuses",
            label: "Status",
            all_label: "All Statuses",
            options: status_options,
            selected: selected_statuses %>

        <%# Version Filter (Multi-select) %>
        <% if @versions.any? %>
          <%= render "ruby_llm/agents/shared/filter_dropdown",
              name: "versions[]",
              filter_id: "versions",
              label: "Version",
              all_label: "All Versions",
              options: version_options,
              selected: selected_versions,
              icon: "M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z" %>
        <% end %>

        <%# Model Filter (Multi-select) %>
        <% if @models.length > 1 %>
          <%= render "ruby_llm/agents/shared/filter_dropdown",
              name: "models[]",
              filter_id: "models",
              label: "Model",
              all_label: "All Models",
              options: model_options,
              selected: selected_models,
              icon: "M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" %>
        <% end %>

        <%# Temperature Filter (Multi-select) %>
        <% if @temperatures.length > 1 %>
          <%= render "ruby_llm/agents/shared/filter_dropdown",
              name: "temperatures[]",
              filter_id: "temperatures",
              label: "Temp",
              all_label: "All Temps",
              options: temperature_options,
              selected: selected_temperatures,
              icon: "M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" %>
        <% end %>

        <%# Time Range Filter (Single-select) %>
        <%= render "ruby_llm/agents/shared/select_dropdown",
            name: "days",
            filter_id: "days",
            options: days_options,
            selected: params[:days].to_s,
            icon: "M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" %>

        <%# Clear Filters %>
        <% if has_filters %>
          <%= link_to ruby_llm_agents.workflow_path(@workflow_type),
              class: "flex items-center gap-1 px-3 py-2 text-sm text-red-500 dark:text-red-400 hover:text-red-600 dark:hover:text-red-300 hover:bg-red-50 dark:hover:bg-red-900/30 rounded-lg transition-colors" do %>
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>
            Clear
          <% end %>
        <% end %>

        <%# Stats Summary (right aligned) %>
        <div class="ml-auto flex items-center gap-4 text-sm text-gray-500 dark:text-gray-400">
          <span><%= number_with_delimiter(@filter_stats[:total_count]) %> executions</span>
          <span class="text-gray-300 dark:text-gray-600">|</span>
          <span>$<%= number_with_precision(@filter_stats[:total_cost] || 0, precision: 4) %></span>
          <span class="text-gray-300 dark:text-gray-600">|</span>
          <span><%= number_with_delimiter(@filter_stats[:total_tokens] || 0) %> tokens</span>
        </div>
      </div>
    <% end %>

    <%= render "ruby_llm/agents/shared/executions_table", executions: @executions, pagination: @pagination %>
  </div>
</div>
