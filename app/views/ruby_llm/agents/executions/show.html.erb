<div id="execution-detail" data-execution-id="<%= @execution.id %>" data-status="<%= @execution.status %>">
<%= render "ruby_llm/agents/shared/breadcrumbs", items: [
  { label: "Dashboard", path: ruby_llm_agents.root_path },
  { label: "Executions", path: ruby_llm_agents.executions_path },
  { label: "##{@execution.id}" }
] %>

<!-- Header -->
<%
  # Collect secondary badges
  secondary_badges = []
  secondary_badges << { label: "Stream", color: "cyan" } if @execution.streaming?
  secondary_badges << { label: "Cached", color: "purple" } if @execution.cache_hit
  if @execution.finish_reason.present?
    finish_color = case @execution.finish_reason
      when 'stop' then 'green'
      when 'length' then 'yellow'
      when 'content_filter' then 'red'
      when 'tool_calls' then 'blue'
      else 'gray'
    end
    secondary_badges << { label: @execution.finish_reason, color: finish_color }
  end
  secondary_badges << { label: "Rate Limited", color: "orange" } if @execution.respond_to?(:rate_limited?) && @execution.rate_limited?
%>
<div class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl p-4 sm:p-5 mb-6">
  <!-- Desktop: Row 1 - Agent name + badges + buttons + date -->
  <div class="hidden sm:flex sm:items-center sm:justify-between gap-4">
    <div class="flex items-center gap-3 min-w-0">
      <h2 class="text-lg font-bold text-gray-900 dark:text-gray-100 truncate">
        <%= @execution.agent_type.gsub(/Agent$/, '') %>
      </h2>
      <%= render "ruby_llm/agents/shared/status_badge", status: @execution.status, size: :md %>
      <% if secondary_badges.any? %>
        <div class="relative" x-data="{ showDetails: false }">
          <button
            type="button"
            @mouseenter="showDetails = true"
            @mouseleave="showDetails = false"
            class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-medium bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors"
          >
            +<%= secondary_badges.size %>
            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
          </button>
          <div
            x-show="showDetails"
            x-cloak
            x-transition:enter="transition ease-out duration-100"
            x-transition:enter-start="opacity-0 scale-95"
            x-transition:enter-end="opacity-100 scale-100"
            class="absolute left-0 mt-1 z-10 bg-white dark:bg-gray-800 rounded-lg shadow-lg border border-gray-200 dark:border-gray-700 p-2 min-w-max"
          >
            <div class="flex flex-wrap gap-1.5">
              <% secondary_badges.each do |badge| %>
                <% badge_classes = case badge[:color]
                  when 'cyan' then 'bg-cyan-100 dark:bg-cyan-900/50 text-cyan-800 dark:text-cyan-300'
                  when 'purple' then 'bg-purple-100 dark:bg-purple-900/50 text-purple-800 dark:text-purple-300'
                  when 'green' then 'bg-green-100 dark:bg-green-900/50 text-green-800 dark:text-green-300'
                  when 'yellow' then 'bg-yellow-100 dark:bg-yellow-900/50 text-yellow-800 dark:text-yellow-300'
                  when 'red' then 'bg-red-100 dark:bg-red-900/50 text-red-800 dark:text-red-300'
                  when 'blue' then 'bg-blue-100 dark:bg-blue-900/50 text-blue-800 dark:text-blue-300'
                  when 'orange' then 'bg-orange-100 dark:bg-orange-900/50 text-orange-800 dark:text-orange-300'
                  else 'bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-gray-300'
                end %>
                <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium <%= badge_classes %>"><%= badge[:label] %></span>
              <% end %>
            </div>
          </div>
        </div>
      <% end %>
    </div>
    <div class="flex items-center gap-3 flex-shrink-0">
      <%= button_to rerun_execution_path(@execution, dry_run: true),
          method: :post,
          class: "inline-flex items-center gap-1.5 px-2.5 py-1 text-xs font-medium text-gray-700 dark:text-gray-200 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md hover:bg-gray-50 dark:hover:bg-gray-600 transition-colors",
          title: "Preview what would be sent without making an API call" do %>
        <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
        </svg>
        Dry Run
      <% end %>
      <button
        type="button"
        onclick="confirmRerun()"
        class="inline-flex items-center gap-1.5 px-2.5 py-1 text-xs font-medium text-white bg-blue-600 hover:bg-blue-700 rounded-md transition-colors"
        title="Re-execute this agent with the same parameters"
      >
        <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
        </svg>
        Rerun
      </button>
      <span class="text-xs text-gray-500 dark:text-gray-400 whitespace-nowrap"><%= @execution.created_at.strftime("%b %d, %H:%M") %></span>
    </div>
  </div>

  <!-- Desktop: Row 2 - Info line + relative time -->
  <div class="hidden sm:flex sm:items-center sm:justify-between mt-1.5">
    <p class="text-xs text-gray-500 dark:text-gray-400">
      #<%= @execution.id %> · v<%= @execution.agent_version %>
      <% if @execution.model_provider.present? %>
        · <%= @execution.model_provider %>
      <% end %>
    </p>
    <span class="text-xs text-gray-400 dark:text-gray-500"><%= time_ago_in_words(@execution.created_at) %> ago</span>
  </div>

  <!-- Mobile: Stacked layout -->
  <div class="sm:hidden">
    <h2 class="text-lg font-bold text-gray-900 dark:text-gray-100 truncate">
      <%= @execution.agent_type.gsub(/Agent$/, '') %>
    </h2>
    <div class="flex flex-wrap items-center gap-2 mt-2">
      <%= render "ruby_llm/agents/shared/status_badge", status: @execution.status, size: :md %>
      <% secondary_badges.each do |badge| %>
        <% badge_classes = case badge[:color]
          when 'cyan' then 'bg-cyan-100 dark:bg-cyan-900/50 text-cyan-800 dark:text-cyan-300'
          when 'purple' then 'bg-purple-100 dark:bg-purple-900/50 text-purple-800 dark:text-purple-300'
          when 'green' then 'bg-green-100 dark:bg-green-900/50 text-green-800 dark:text-green-300'
          when 'yellow' then 'bg-yellow-100 dark:bg-yellow-900/50 text-yellow-800 dark:text-yellow-300'
          when 'red' then 'bg-red-100 dark:bg-red-900/50 text-red-800 dark:text-red-300'
          when 'blue' then 'bg-blue-100 dark:bg-blue-900/50 text-blue-800 dark:text-blue-300'
          when 'orange' then 'bg-orange-100 dark:bg-orange-900/50 text-orange-800 dark:text-orange-300'
          else 'bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-gray-300'
        end %>
        <span class="inline-flex items-center px-2 py-0.5 rounded-full text-[10px] font-medium <%= badge_classes %>"><%= badge[:label] %></span>
      <% end %>
    </div>
    <p class="text-xs text-gray-500 dark:text-gray-400 mt-2">
      #<%= @execution.id %> · v<%= @execution.agent_version %>
      <% if @execution.model_provider.present? %>
        · <%= @execution.model_provider %>
      <% end %>
    </p>

    <!-- Mobile: Date + Buttons -->
    <div class="mt-4 pt-4 border-t border-gray-100 dark:border-gray-700">
      <p class="text-xs text-gray-500 dark:text-gray-400 mb-3">
        <%= @execution.created_at.strftime("%b %d, %Y at %H:%M") %>
        <span class="text-gray-400 dark:text-gray-500">· <%= time_ago_in_words(@execution.created_at) %> ago</span>
      </p>
      <div class="flex items-center gap-2">
        <%= button_to rerun_execution_path(@execution, dry_run: true),
            method: :post,
            class: "flex-1 inline-flex items-center justify-center gap-1.5 px-3 py-2 text-sm font-medium text-gray-700 dark:text-gray-200 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-600 transition-colors",
            title: "Preview what would be sent without making an API call" do %>
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
          </svg>
          Dry Run
        <% end %>
        <button
          type="button"
          onclick="confirmRerun()"
          class="flex-1 inline-flex items-center justify-center gap-1.5 px-3 py-2 text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 rounded-lg transition-colors"
          title="Re-execute this agent with the same parameters"
        >
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
          </svg>
          Rerun
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Rerun Confirmation Modal -->
<div id="rerun-modal" class="hidden fixed inset-0 z-50 overflow-y-auto">
  <div class="flex items-center justify-center min-h-screen px-4 pt-4 pb-20 text-center sm:p-0">
    <div class="fixed inset-0 transition-opacity bg-gray-500 bg-opacity-75 dark:bg-gray-900 dark:bg-opacity-75" onclick="closeRerunModal()"></div>

    <div class="relative inline-block px-4 pt-5 pb-4 overflow-hidden text-left align-bottom transition-all transform bg-white dark:bg-gray-800 rounded-lg shadow-xl sm:my-8 sm:align-middle sm:max-w-lg sm:w-full sm:p-6">
      <div class="sm:flex sm:items-start">
        <div class="flex items-center justify-center flex-shrink-0 w-12 h-12 mx-auto bg-blue-100 dark:bg-blue-900/30 rounded-full sm:mx-0 sm:h-10 sm:w-10">
          <svg class="w-6 h-6 text-blue-600 dark:text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
          </svg>
        </div>
        <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left">
          <h3 class="text-lg font-medium leading-6 text-gray-900 dark:text-gray-100">Confirm Rerun</h3>
          <div class="mt-2">
            <p class="text-sm text-gray-500 dark:text-gray-400">
              This will re-execute the agent with the original parameters. A new execution record will be created and the agent will make a real API call.
            </p>
            <p class="mt-2 text-sm text-amber-600 dark:text-amber-400">
              This action may incur API costs.
            </p>
          </div>
        </div>
      </div>
      <div class="mt-5 sm:mt-4 sm:flex sm:flex-row-reverse gap-3">
        <%= button_to rerun_execution_path(@execution),
            method: :post,
            class: "inline-flex justify-center w-full px-4 py-2 text-sm font-medium text-white bg-blue-600 border border-transparent rounded-md shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:w-auto" do %>
          Confirm Rerun
        <% end %>
        <button type="button" onclick="closeRerunModal()" class="inline-flex justify-center w-full px-4 py-2 mt-3 text-sm font-medium text-gray-700 dark:text-gray-200 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm hover:bg-gray-50 dark:hover:bg-gray-600 focus:outline-none sm:mt-0 sm:w-auto">
          Cancel
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Workflow Summary Panel (for root workflow executions) -->
<% if @execution.respond_to?(:root_workflow?) && @execution.root_workflow? %>
  <%= render "ruby_llm/agents/executions/workflow_summary", execution: @execution %>
<% end %>

<!-- Workflow Info (if applicable - for child workflow steps) -->
<% if (@execution.workflow_type.present? || @execution.workflow_step.present? || @execution.routed_to.present?) && !(@execution.respond_to?(:root_workflow?) && @execution.root_workflow?) %>
  <div class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl p-4 sm:p-5 mb-6">
    <div class="flex items-center gap-2 mb-4">
      <% case @execution.workflow_type
         when "pipeline" %>
        <span class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-md text-sm font-medium bg-indigo-100 dark:bg-indigo-900/50 text-indigo-700 dark:text-indigo-300">
          <span class="text-base">→</span> Pipeline Workflow
        </span>
      <% when "parallel" %>
        <span class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-md text-sm font-medium bg-cyan-100 dark:bg-cyan-900/50 text-cyan-700 dark:text-cyan-300">
          <span class="text-base">⫴</span> Parallel Workflow
        </span>
      <% when "router" %>
        <span class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-md text-sm font-medium bg-amber-100 dark:bg-amber-900/50 text-amber-700 dark:text-amber-300">
          <span class="text-base">⑂</span> Router Workflow
        </span>
      <% else %>
        <% if @execution.workflow_step.present? %>
          <span class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-md text-sm font-medium bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 5l7 7-7 7M5 5l7 7-7 7"/>
            </svg>
            Workflow Step
          </span>
        <% end %>
      <% end %>
      <% if @execution.workflow_id.present? %>
        <span class="text-xs text-gray-400 dark:text-gray-500 font-mono" title="Workflow ID: <%= @execution.workflow_id %>">
          <%= @execution.workflow_id.to_s.truncate(12) %>
        </span>
      <% end %>
    </div>

    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
      <% if @execution.workflow_step.present? %>
        <div>
          <p class="text-xs text-gray-500 dark:text-gray-400 uppercase tracking-wide">Step Name</p>
          <p class="text-sm font-medium text-gray-900 dark:text-gray-100"><%= @execution.workflow_step %></p>
        </div>
      <% end %>

      <% if @execution.routed_to.present? %>
        <div>
          <p class="text-xs text-gray-500 dark:text-gray-400 uppercase tracking-wide">Routed To</p>
          <p class="text-sm font-medium text-amber-600 dark:text-amber-400"><%= @execution.routed_to %></p>
        </div>
      <% end %>

      <% if @execution.classification_result.present? %>
        <%
          classification = if @execution.classification_result.is_a?(String)
            begin
              JSON.parse(@execution.classification_result)
            rescue
              {}
            end
          else
            @execution.classification_result || {}
          end
        %>
        <% if classification["method"].present? %>
          <div>
            <p class="text-xs text-gray-500 dark:text-gray-400 uppercase tracking-wide">Classification</p>
            <p class="text-sm font-medium text-gray-900 dark:text-gray-100">
              <%= classification["method"] == "llm" ? "LLM" : "Rule-based" %>
              <% if classification["classification_time_ms"].present? %>
                <span class="text-xs text-gray-400 dark:text-gray-500">(<%= classification["classification_time_ms"] %>ms)</span>
              <% end %>
            </p>
          </div>
        <% end %>
        <% if classification["classifier_model"].present? %>
          <div>
            <p class="text-xs text-gray-500 dark:text-gray-400 uppercase tracking-wide">Classifier Model</p>
            <p class="text-sm font-medium text-gray-900 dark:text-gray-100 font-mono"><%= classification["classifier_model"] %></p>
          </div>
        <% end %>
      <% end %>
    </div>

    <% if @execution.parent_execution_id.present? %>
      <div class="mt-4 pt-4 border-t border-gray-100 dark:border-gray-700">
        <span class="text-xs text-gray-500 dark:text-gray-400">Part of workflow:</span>
        <%= link_to "##{@execution.parent_execution_id}",
            ruby_llm_agents.execution_path(@execution.parent_execution_id),
            class: "ml-2 text-blue-600 dark:text-blue-400 hover:underline font-mono text-sm" %>
      </div>
    <% end %>
  </div>
<% end %>

<!-- Stats Grid -->
<div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
  <%= render "ruby_llm/agents/shared/stat_card",
      title: "Model",
      value: @execution.model_id,
      icon: "M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z",
      icon_color: "text-blue-500" %>

  <%= render "ruby_llm/agents/shared/stat_card",
      title: "Duration",
      value: "#{number_to_human_short(@execution.duration_ms || 0)} ms",
      icon: "M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z",
      icon_color: "text-purple-500" %>

  <%= render "ruby_llm/agents/shared/stat_card",
      title: "Total Tokens",
      value: number_to_human_short(@execution.total_tokens || 0),
      icon: "M7 20l4-16m2 16l4-16M6 9h14M4 15h14",
      icon_color: "text-indigo-500" %>

  <%= render "ruby_llm/agents/shared/stat_card",
      title: "Total Cost",
      value: number_to_human_short(@execution.total_cost || 0, prefix: "$", precision: 2),
      icon: "M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z",
      icon_color: "text-amber-500" %>
</div>

<!-- Token Breakdown -->
<div class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl p-6 mb-6">
  <h3 class="text-sm font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wide mb-4">Token Usage</h3>

  <!-- Token Distribution Bar -->
  <%
    input_tokens = @execution.input_tokens || 0
    output_tokens = @execution.output_tokens || 0
    total = input_tokens + output_tokens
    input_pct = total > 0 ? (input_tokens.to_f / total * 100).round(1) : 0
    output_pct = total > 0 ? (output_tokens.to_f / total * 100).round(1) : 0
  %>
  <div class="mb-6">
    <div class="flex justify-between text-xs mb-1.5">
      <span class="text-blue-600 dark:text-blue-400 font-medium">Input: <%= number_to_human_short(input_tokens) %> (<%= input_pct %>%)</span>
      <span class="text-green-600 dark:text-green-400 font-medium">Output: <%= number_to_human_short(output_tokens) %> (<%= output_pct %>%)</span>
    </div>
    <div class="h-2.5 bg-gray-100 dark:bg-gray-700 rounded-full overflow-hidden flex">
      <div class="bg-blue-500 transition-all" style="width: <%= input_pct %>%"></div>
      <div class="bg-green-500 transition-all" style="width: <%= output_pct %>%"></div>
    </div>
  </div>

  <!-- Detailed Metrics -->
  <div class="grid grid-cols-2 md:grid-cols-5 gap-6 pt-4 border-t border-gray-100 dark:border-gray-700">
    <div>
      <p class="text-xs text-gray-500 dark:text-gray-400 uppercase tracking-wide">Input</p>
      <p class="text-lg font-semibold text-gray-900 dark:text-gray-100"><%= number_to_human_short(@execution.input_tokens || 0) %></p>
      <p class="text-xs text-gray-400 dark:text-gray-500"><%= number_to_human_short(@execution.input_cost || 0, prefix: "$", precision: 4) %></p>
    </div>

    <div>
      <p class="text-xs text-gray-500 dark:text-gray-400 uppercase tracking-wide">Output</p>
      <p class="text-lg font-semibold text-gray-900 dark:text-gray-100"><%= number_to_human_short(@execution.output_tokens || 0) %></p>
      <p class="text-xs text-gray-400 dark:text-gray-500"><%= number_to_human_short(@execution.output_cost || 0, prefix: "$", precision: 4) %></p>
    </div>

    <div>
      <p class="text-xs text-gray-500 dark:text-gray-400 uppercase tracking-wide">Cached</p>
      <p class="text-lg font-semibold text-gray-900 dark:text-gray-100"><%= number_to_human_short(@execution.cached_tokens || 0) %></p>
    </div>

    <div>
      <p class="text-xs text-gray-500 dark:text-gray-400 uppercase tracking-wide">Cache Creation</p>
      <p class="text-lg font-semibold text-gray-900 dark:text-gray-100"><%= number_to_human_short(@execution.cache_creation_tokens || 0) %></p>
    </div>

    <div>
      <p class="text-xs text-gray-500 dark:text-gray-400 uppercase tracking-wide">Tokens/Sec</p>
      <p class="text-lg font-semibold text-gray-900 dark:text-gray-100"><%= @execution.tokens_per_second || 'N/A' %></p>
    </div>
  </div>
</div>

<!-- Attempts Table (for reliability-enabled executions) -->
<% if @execution.respond_to?(:attempts) && @execution.attempts.present? %>
  <div class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl p-6 mb-6">
    <div class="flex items-center justify-between mb-4">
      <div>
        <h3 class="text-sm font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wide">Attempts</h3>
        <p class="text-xs text-gray-400 dark:text-gray-500 mt-1">
          <%= @execution.respond_to?(:attempts_count) && @execution.attempts_count ? @execution.attempts_count : @execution.attempts.size %> attempt(s)
          <% if @execution.used_fallback? %>
            · <span class="text-amber-500">Used fallback model</span>
          <% end %>
          <% if @execution.has_retries? %>
            · <span class="text-blue-500">Retried</span>
          <% end %>
        </p>
      </div>
      <% if @execution.used_fallback? %>
        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-amber-100 dark:bg-amber-900/30 text-amber-800 dark:text-amber-300">
          Fallback: <%= @execution.chosen_model_id %>
        </span>
      <% end %>
    </div>

    <div class="overflow-x-auto">
      <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
        <thead>
          <tr>
            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">#</th>
            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Model</th>
            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Status</th>
            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Duration</th>
            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Tokens</th>
            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Error</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-gray-100 dark:divide-gray-700">
          <% @execution.attempts.each_with_index do |attempt, index| %>
            <tr class="<%= attempt['short_circuited'] ? 'bg-gray-50 dark:bg-gray-900/50' : '' %>">
              <td class="px-3 py-2 text-sm text-gray-500 dark:text-gray-400">
                <%= index + 1 %>
              </td>
              <td class="px-3 py-2 text-sm font-mono text-gray-900 dark:text-gray-100">
                <%= attempt['model_id'] %>
              </td>
              <td class="px-3 py-2">
                <% if attempt['short_circuited'] %>
                  <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300">
                    <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20">
                      <path fill-rule="evenodd" d="M13.477 14.89A6 6 0 015.11 6.524l8.367 8.368zm1.414-1.414L6.524 5.11a6 6 0 018.367 8.367zM18 10a8 8 0 11-16 0 8 8 0 0116 0z" clip-rule="evenodd"/>
                    </svg>
                    Blocked
                  </span>
                <% elsif attempt['error_class'].present? %>
                  <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-300">
                    <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20">
                      <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
                    </svg>
                    Failed
                  </span>
                <% else %>
                  <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-300">
                    <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20">
                      <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                    </svg>
                    Success
                  </span>
                <% end %>
              </td>
              <td class="px-3 py-2 text-sm text-gray-500 dark:text-gray-400">
                <%= attempt['duration_ms'] ? "#{attempt['duration_ms']}ms" : '-' %>
              </td>
              <td class="px-3 py-2 text-sm text-gray-500 dark:text-gray-400">
                <% if attempt['input_tokens'] || attempt['output_tokens'] %>
                  <span class="text-blue-600 dark:text-blue-400"><%= attempt['input_tokens'] || 0 %></span>
                  /
                  <span class="text-green-600 dark:text-green-400"><%= attempt['output_tokens'] || 0 %></span>
                <% else %>
                  -
                <% end %>
              </td>
              <td class="px-3 py-2 text-sm">
                <% if attempt['error_class'].present? %>
                  <span class="text-red-600 dark:text-red-400 font-mono text-xs" title="<%= attempt['error_message'] %>">
                    <%= attempt['error_class'].split('::').last.truncate(30) %>
                  </span>
                <% else %>
                  <span class="text-gray-400">-</span>
                <% end %>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>

    <% if @execution.fallback_chain.present? && @execution.fallback_chain.any? %>
      <div class="mt-4 pt-4 border-t border-gray-100 dark:border-gray-700">
        <p class="text-xs text-gray-500 dark:text-gray-400">
          <span class="font-medium">Fallback chain:</span>
          <%= @execution.fallback_chain.join(' → ') %>
        </p>
        <% if @execution.fallback_reason.present? %>
          <p class="text-xs text-amber-600 dark:text-amber-400 mt-1">
            Fallback reason: <%= @execution.fallback_reason %>
          </p>
        <% end %>
      </div>
    <% end %>
  </div>
<% end %>

<% if @execution.status_error? %>
  <!-- Error Details -->
  <div class="bg-red-50 dark:bg-red-900/30 border border-red-200 dark:border-red-800 rounded-lg p-6 mb-6">
    <div class="flex items-center justify-between mb-2">
      <h3 class="text-lg font-semibold text-red-800 dark:text-red-300">Error Details</h3>
      <div class="flex items-center gap-2">
        <% if @execution.rate_limited? %>
          <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-orange-100 text-orange-700 dark:bg-orange-900/30 dark:text-orange-300">
            Rate Limited
          </span>
        <% end %>
        <% if @execution.retryable %>
          <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-300">
            Retryable
          </span>
        <% end %>
      </div>
    </div>

    <p class="font-mono text-sm text-red-700 dark:text-red-400 mb-2">
      <%= @execution.error_class %>
    </p>

    <pre class="bg-red-100 dark:bg-red-900/50 rounded p-4 text-sm text-red-900 dark:text-red-200 overflow-x-auto"><%= @execution.error_message %></pre>
  </div>
<% end %>

<!-- Masking Toggle -->
<div class="bg-amber-50 dark:bg-amber-900/20 border border-amber-200 dark:border-amber-800 rounded-xl p-4 mb-6">
  <div class="flex items-center justify-between">
    <div class="flex items-center gap-2">
      <svg class="w-5 h-5 text-amber-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/>
      </svg>
      <span class="text-sm font-medium text-amber-800 dark:text-amber-200">Data Masking</span>
    </div>
    <div class="flex items-center gap-3">
      <span id="masking-status" class="text-xs text-amber-600 dark:text-amber-400">
        Sensitive data is hidden
      </span>
      <button
        type="button"
        id="toggle-masking-btn"
        onclick="toggleMasking()"
        class="inline-flex items-center gap-1.5 px-3 py-1.5 text-xs font-medium rounded-md transition-colors bg-amber-100 dark:bg-amber-900/50 text-amber-700 dark:text-amber-300 hover:bg-amber-200 dark:hover:bg-amber-800/50"
      >
        <svg id="eye-icon" class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
        </svg>
        <svg id="eye-off-icon" class="w-4 h-4 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21"/>
        </svg>
        <span id="toggle-btn-text">Show Original</span>
      </button>
    </div>
  </div>
</div>

<!-- Parameters -->
<div class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl p-6 mb-6">
  <div class="flex items-center justify-between mb-4">
    <h3 class="text-sm font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wide">Parameters</h3>
    <button
      type="button"
      data-copy-json="<%= Base64.strict_encode64(JSON.pretty_generate(redact_for_display(@execution.parameters || {}))) %>"
      data-copy-json-original="<%= Base64.strict_encode64(JSON.pretty_generate(@execution.parameters || {})) %>"
      class="copy-json-btn inline-flex items-center gap-1.5 px-2.5 py-1.5 text-xs font-medium text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-md transition-colors"
    >
      <svg class="w-4 h-4 copy-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/>
      </svg>
      <svg class="w-4 h-4 check-icon hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
      </svg>
      <span>Copy</span>
    </button>
  </div>
  <pre id="parameters-masked" class="maskable-content bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-gray-100 rounded-lg p-4 text-sm overflow-x-auto font-mono"><%= highlight_json_redacted(@execution.parameters || {}) %></pre>
  <pre id="parameters-original" class="maskable-content hidden bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-gray-100 rounded-lg p-4 text-sm overflow-x-auto font-mono"><%= highlight_json(@execution.parameters || {}) %></pre>
</div>

<!-- Response -->
<% if @execution.response.present? %>
  <div class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl p-6 mb-6">
    <div class="flex items-center justify-between mb-4">
      <h3 class="text-sm font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wide">Response</h3>
      <button
        type="button"
        data-copy-json="<%= Base64.strict_encode64(JSON.pretty_generate(redact_for_display(@execution.response))) %>"
        data-copy-json-original="<%= Base64.strict_encode64(JSON.pretty_generate(@execution.response)) %>"
        class="copy-json-btn inline-flex items-center gap-1.5 px-2.5 py-1.5 text-xs font-medium text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-md transition-colors"
      >
        <svg class="w-4 h-4 copy-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/>
        </svg>
        <svg class="w-4 h-4 check-icon hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
        </svg>
        <span>Copy</span>
      </button>
    </div>
    <pre id="response-masked" class="maskable-content bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-gray-100 rounded-lg p-4 text-sm overflow-x-auto max-h-96 font-mono"><%= highlight_json_redacted(@execution.response) %></pre>
    <pre id="response-original" class="maskable-content hidden bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-gray-100 rounded-lg p-4 text-sm overflow-x-auto max-h-96 font-mono"><%= highlight_json(@execution.response) %></pre>
  </div>
<% end %>

<!-- Tool Calls -->
<% if @execution.tool_calls.present? && @execution.tool_calls.any? %>
  <% tool_call_count = @execution.tool_calls.size %>
  <div class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl p-6 mb-6" x-data="{ expanded: <%= tool_call_count <= 3 %> }">
    <div class="flex items-center justify-between mb-4">
      <div class="flex items-center gap-2">
        <svg class="w-5 h-5 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
        </svg>
        <h3 class="text-sm font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wide">Tool Calls</h3>
        <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-blue-100 dark:bg-blue-900/50 text-blue-800 dark:text-blue-300">
          <%= tool_call_count %>
        </span>
      </div>
      <div class="flex items-center gap-2">
        <button
          type="button"
          data-copy-json="<%= Base64.strict_encode64(JSON.pretty_generate(@execution.tool_calls)) %>"
          class="copy-json-btn inline-flex items-center gap-1.5 px-2.5 py-1.5 text-xs font-medium text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-md transition-colors"
        >
          <svg class="w-4 h-4 copy-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/>
          </svg>
          <svg class="w-4 h-4 check-icon hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
          </svg>
          <span>Copy</span>
        </button>
        <% if tool_call_count > 3 %>
          <button type="button" @click="expanded = !expanded" class="text-xs text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
            <span x-text="expanded ? 'Collapse' : 'Expand'">Expand</span>
          </button>
        <% end %>
      </div>
    </div>

    <div class="space-y-4" x-show="expanded" <%= tool_call_count > 3 ? 'x-cloak' : '' %>>
      <% @execution.tool_calls.each_with_index do |tool_call, index| %>
        <%
          # Handle both symbol and string keys
          tool_id = tool_call['id'] || tool_call[:id]
          tool_name = tool_call['name'] || tool_call[:name]
          tool_args = tool_call['arguments'] || tool_call[:arguments] || {}
        %>
        <div class="border border-gray-100 dark:border-gray-700 rounded-lg overflow-hidden">
          <!-- Tool Call Header -->
          <div class="bg-gray-50 dark:bg-gray-900/50 px-4 py-3 flex items-center justify-between">
            <div class="flex items-center gap-3">
              <span class="inline-flex items-center justify-center w-6 h-6 rounded-full bg-blue-100 dark:bg-blue-900/50 text-blue-700 dark:text-blue-300 text-xs font-medium">
                <%= index + 1 %>
              </span>
              <code class="text-sm font-semibold text-gray-900 dark:text-gray-100"><%= tool_name %></code>
            </div>
            <% if tool_id.present? %>
              <span class="text-xs text-gray-400 dark:text-gray-500 font-mono truncate max-w-xs" title="<%= tool_id %>">
                <%= tool_id.to_s.truncate(24) %>
              </span>
            <% end %>
          </div>

          <!-- Tool Call Arguments -->
          <% if tool_args.present? && tool_args.any? %>
            <div class="px-4 py-3">
              <p class="text-xs text-gray-500 dark:text-gray-400 uppercase tracking-wide mb-2">Arguments</p>
              <pre class="bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-gray-100 rounded-lg p-3 text-sm overflow-x-auto font-mono"><%= highlight_json(tool_args) %></pre>
            </div>
          <% else %>
            <div class="px-4 py-3">
              <p class="text-xs text-gray-400 dark:text-gray-500 italic">No arguments</p>
            </div>
          <% end %>
        </div>
      <% end %>
    </div>
  </div>
<% end %>

<!-- Metadata -->
<% if @execution.metadata.present? && @execution.metadata.any? %>
  <div class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl p-6 mb-6" x-data="{ expanded: false }">
    <div class="flex items-center justify-between">
      <div class="flex items-center gap-2">
        <h3 class="text-sm font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wide">Metadata</h3>
        <span class="text-xs text-gray-400 dark:text-gray-500">(<%= @execution.metadata.keys.count %> keys)</span>
      </div>
      <div class="flex items-center gap-2">
        <button
          type="button"
          data-copy-json="<%= Base64.strict_encode64(JSON.pretty_generate(redact_for_display(@execution.metadata))) %>"
          data-copy-json-original="<%= Base64.strict_encode64(JSON.pretty_generate(@execution.metadata)) %>"
          class="copy-json-btn inline-flex items-center gap-1.5 px-2.5 py-1.5 text-xs font-medium text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-md transition-colors"
        >
          <svg class="w-4 h-4 copy-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/>
          </svg>
          <svg class="w-4 h-4 check-icon hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
          </svg>
          <span>Copy</span>
        </button>
        <button type="button" @click="expanded = !expanded" class="text-xs text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
          <span x-text="expanded ? 'Collapse' : 'Expand'">Expand</span>
        </button>
      </div>
    </div>
    <div x-show="expanded" x-cloak class="mt-4">
      <pre id="metadata-masked" class="maskable-content bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-gray-100 rounded-lg p-4 text-sm overflow-x-auto font-mono"><%= highlight_json_redacted(@execution.metadata) %></pre>
      <pre id="metadata-original" class="maskable-content hidden bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-gray-100 rounded-lg p-4 text-sm overflow-x-auto font-mono"><%= highlight_json(@execution.metadata) %></pre>
    </div>
  </div>
<% end %>

<!-- Execution Hierarchy -->
<% if @execution.parent_execution_id.present? || (@execution.respond_to?(:child_executions) && @execution.child_executions.any?) %>
  <div class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl p-6 mb-6">
    <h3 class="text-sm font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wide mb-4">Execution Hierarchy</h3>

    <% if @execution.parent_execution_id.present? %>
      <div class="mb-4">
        <span class="text-xs text-gray-500 dark:text-gray-400">Parent Execution:</span>
        <%= link_to "##{@execution.parent_execution_id}",
            ruby_llm_agents.execution_path(@execution.parent_execution_id),
            class: "ml-2 text-blue-600 dark:text-blue-400 hover:underline font-mono text-sm" %>
      </div>
    <% end %>

    <% if @execution.respond_to?(:child_executions) && @execution.child_executions.any? %>
      <div>
        <span class="text-xs text-gray-500 dark:text-gray-400">Child Executions (<%= @execution.child_executions.count %>):</span>
        <div class="mt-2 flex flex-wrap gap-2">
          <% @execution.child_executions.limit(10).each do |child| %>
            <%= link_to "##{child.id}",
                ruby_llm_agents.execution_path(child),
                class: "inline-flex items-center px-2 py-1 rounded text-xs font-mono bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-600" %>
          <% end %>
          <% if @execution.child_executions.count > 10 %>
            <span class="text-xs text-gray-400">+<%= @execution.child_executions.count - 10 %> more</span>
          <% end %>
        </div>
      </div>
    <% end %>
  </div>
<% end %>

<!-- System Prompt -->
<% if @execution.system_prompt.present? %>
  <div class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl p-6 mb-6">
    <div class="flex items-center justify-between mb-4">
      <h3 class="text-sm font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wide">System Prompt</h3>
      <button type="button" onclick="togglePrompt('system')" class="text-xs text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
        <span id="system-prompt-toggle">Expand</span>
      </button>
    </div>
    <p id="system-prompt-preview" class="text-sm text-gray-600 dark:text-gray-300 font-mono bg-gray-50 dark:bg-gray-900 rounded-lg p-3 truncate"><%= @execution.system_prompt.truncate(150) %></p>
    <pre id="system-prompt-content" class="hidden bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-gray-100 rounded-lg p-4 text-sm overflow-x-auto max-h-96 font-mono whitespace-pre-wrap"><%= @execution.system_prompt %></pre>
  </div>
<% end %>

<!-- User Prompt -->
<% if @execution.user_prompt.present? %>
  <div class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl p-6 mb-6">
    <div class="flex items-center justify-between mb-4">
      <h3 class="text-sm font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wide">User Prompt</h3>
      <button type="button" onclick="togglePrompt('user')" class="text-xs text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
        <span id="user-prompt-toggle">Expand</span>
      </button>
    </div>
    <p id="user-prompt-preview" class="text-sm text-gray-600 dark:text-gray-300 font-mono bg-gray-50 dark:bg-gray-900 rounded-lg p-3 truncate"><%= @execution.user_prompt.truncate(150) %></p>
    <pre id="user-prompt-content" class="hidden bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-gray-100 rounded-lg p-4 text-sm overflow-x-auto max-h-96 font-mono whitespace-pre-wrap"><%= @execution.user_prompt %></pre>
  </div>
<% end %>

<!-- Diagnostics Panel -->
<div class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl p-6 mb-6">
  <div class="flex items-center justify-between mb-4">
    <div class="flex items-center gap-2">
      <svg class="w-5 h-5 text-gray-500 dark:text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z"/>
      </svg>
      <h3 class="text-sm font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wide">Diagnostics</h3>
    </div>
    <button
      type="button"
      id="toggle-diagnostics-btn"
      onclick="toggleDiagnostics()"
      class="inline-flex items-center gap-1 px-2 py-1 text-xs font-medium text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700 rounded transition-colors"
    >
      <svg id="diagnostics-expand-icon" class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
      </svg>
      <span id="diagnostics-toggle-text">Expand</span>
    </button>
  </div>

  <!-- Quick Info (always visible) -->
  <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
    <div>
      <span class="text-gray-500 dark:text-gray-400 text-xs uppercase tracking-wide">Model</span>
      <p class="font-mono text-gray-900 dark:text-gray-100"><%= @execution.model_id %></p>
    </div>
    <div>
      <span class="text-gray-500 dark:text-gray-400 text-xs uppercase tracking-wide">Temperature</span>
      <p class="font-mono text-gray-900 dark:text-gray-100"><%= @execution.temperature || 'N/A' %></p>
    </div>
    <div>
      <span class="text-gray-500 dark:text-gray-400 text-xs uppercase tracking-wide">Version</span>
      <p class="font-mono text-gray-900 dark:text-gray-100"><%= @execution.agent_version || '1.0' %></p>
    </div>
    <div>
      <span class="text-gray-500 dark:text-gray-400 text-xs uppercase tracking-wide">Status</span>
      <p class="font-mono text-gray-900 dark:text-gray-100"><%= @execution.status %></p>
    </div>
  </div>

  <!-- Expanded Details (hidden by default) -->
  <div id="diagnostics-details" class="hidden mt-6 pt-6 border-t border-gray-100 dark:border-gray-700">
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <!-- Timing Information -->
      <div class="bg-gray-50 dark:bg-gray-900/50 rounded-lg p-4">
        <h4 class="text-xs font-semibold text-gray-700 dark:text-gray-300 uppercase tracking-wide mb-3">Timing</h4>
        <dl class="space-y-2 text-sm">
          <div class="flex justify-between">
            <dt class="text-gray-500 dark:text-gray-400">Started</dt>
            <dd class="font-mono text-gray-900 dark:text-gray-100"><%= @execution.started_at&.strftime("%Y-%m-%d %H:%M:%S.%L") || 'N/A' %></dd>
          </div>
          <div class="flex justify-between">
            <dt class="text-gray-500 dark:text-gray-400">Completed</dt>
            <dd class="font-mono text-gray-900 dark:text-gray-100"><%= @execution.completed_at&.strftime("%Y-%m-%d %H:%M:%S.%L") || 'N/A' %></dd>
          </div>
          <div class="flex justify-between">
            <dt class="text-gray-500 dark:text-gray-400">Duration</dt>
            <dd class="font-mono text-gray-900 dark:text-gray-100"><%= @execution.duration_ms ? "#{@execution.duration_ms}ms" : 'N/A' %></dd>
          </div>
          <% if @execution.streaming? && @execution.time_to_first_token_ms %>
            <div class="flex justify-between">
              <dt class="text-gray-500 dark:text-gray-400">Time to First Token</dt>
              <dd class="font-mono text-gray-900 dark:text-gray-100"><%= @execution.time_to_first_token_ms %>ms</dd>
            </div>
          <% end %>
          <div class="flex justify-between">
            <dt class="text-gray-500 dark:text-gray-400">Created At</dt>
            <dd class="font-mono text-gray-900 dark:text-gray-100"><%= @execution.created_at.strftime("%Y-%m-%d %H:%M:%S") %></dd>
          </div>
        </dl>
      </div>

      <!-- Performance Metrics -->
      <div class="bg-gray-50 dark:bg-gray-900/50 rounded-lg p-4">
        <h4 class="text-xs font-semibold text-gray-700 dark:text-gray-300 uppercase tracking-wide mb-3">Performance</h4>
        <dl class="space-y-2 text-sm">
          <div class="flex justify-between">
            <dt class="text-gray-500 dark:text-gray-400">Tokens/Second</dt>
            <dd class="font-mono text-gray-900 dark:text-gray-100"><%= @execution.tokens_per_second&.round(1) || 'N/A' %></dd>
          </div>
          <div class="flex justify-between">
            <dt class="text-gray-500 dark:text-gray-400">Input Tokens</dt>
            <dd class="font-mono text-gray-900 dark:text-gray-100"><%= @execution.input_tokens || 0 %></dd>
          </div>
          <div class="flex justify-between">
            <dt class="text-gray-500 dark:text-gray-400">Output Tokens</dt>
            <dd class="font-mono text-gray-900 dark:text-gray-100"><%= @execution.output_tokens || 0 %></dd>
          </div>
          <div class="flex justify-between">
            <dt class="text-gray-500 dark:text-gray-400">Cached Tokens</dt>
            <dd class="font-mono text-gray-900 dark:text-gray-100"><%= @execution.cached_tokens || 0 %></dd>
          </div>
        </dl>
      </div>

      <!-- Cost Breakdown -->
      <div class="bg-gray-50 dark:bg-gray-900/50 rounded-lg p-4">
        <h4 class="text-xs font-semibold text-gray-700 dark:text-gray-300 uppercase tracking-wide mb-3">Cost</h4>
        <dl class="space-y-2 text-sm">
          <div class="flex justify-between">
            <dt class="text-gray-500 dark:text-gray-400">Input Cost</dt>
            <dd class="font-mono text-gray-900 dark:text-gray-100">$<%= number_with_precision(@execution.input_cost || 0, precision: 6) %></dd>
          </div>
          <div class="flex justify-between">
            <dt class="text-gray-500 dark:text-gray-400">Output Cost</dt>
            <dd class="font-mono text-gray-900 dark:text-gray-100">$<%= number_with_precision(@execution.output_cost || 0, precision: 6) %></dd>
          </div>
          <div class="flex justify-between font-semibold">
            <dt class="text-gray-600 dark:text-gray-300">Total Cost</dt>
            <dd class="font-mono text-gray-900 dark:text-gray-100">$<%= number_with_precision(@execution.total_cost || 0, precision: 6) %></dd>
          </div>
        </dl>
      </div>

      <!-- Configuration -->
      <div class="bg-gray-50 dark:bg-gray-900/50 rounded-lg p-4">
        <h4 class="text-xs font-semibold text-gray-700 dark:text-gray-300 uppercase tracking-wide mb-3">Configuration</h4>
        <dl class="space-y-2 text-sm">
          <div class="flex justify-between">
            <dt class="text-gray-500 dark:text-gray-400">Agent Type</dt>
            <dd class="font-mono text-gray-900 dark:text-gray-100"><%= @execution.agent_type %></dd>
          </div>
          <div class="flex justify-between">
            <dt class="text-gray-500 dark:text-gray-400">Temperature</dt>
            <dd class="font-mono text-gray-900 dark:text-gray-100"><%= @execution.temperature || 'default' %></dd>
          </div>
          <% if @execution.respond_to?(:chosen_model_id) && @execution.chosen_model_id.present? && @execution.chosen_model_id != @execution.model_id %>
            <div class="flex justify-between">
              <dt class="text-gray-500 dark:text-gray-400">Chosen Model</dt>
              <dd class="font-mono text-amber-600 dark:text-amber-400"><%= @execution.chosen_model_id %></dd>
            </div>
          <% end %>
          <% if @execution.respond_to?(:attempts_count) && @execution.attempts_count && @execution.attempts_count > 1 %>
            <div class="flex justify-between">
              <dt class="text-gray-500 dark:text-gray-400">Retry Count</dt>
              <dd class="font-mono text-blue-600 dark:text-blue-400"><%= @execution.attempts_count - 1 %></dd>
            </div>
          <% end %>
        </dl>
      </div>
    </div>

    <!-- Second Row: Tracing and Caching -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6">
      <!-- Tracing Information -->
      <% if @execution.trace_id.present? || @execution.request_id.present? %>
        <div class="bg-gray-50 dark:bg-gray-900/50 rounded-lg p-4">
          <h4 class="text-xs font-semibold text-gray-700 dark:text-gray-300 uppercase tracking-wide mb-3">Tracing</h4>
          <dl class="space-y-2 text-sm">
            <% if @execution.request_id.present? %>
              <div class="flex justify-between">
                <dt class="text-gray-500 dark:text-gray-400">Request ID</dt>
                <dd class="font-mono text-gray-900 dark:text-gray-100 text-xs"><%= @execution.request_id %></dd>
              </div>
            <% end %>
            <% if @execution.trace_id.present? %>
              <div class="flex justify-between">
                <dt class="text-gray-500 dark:text-gray-400">Trace ID</dt>
                <dd class="font-mono text-gray-900 dark:text-gray-100 text-xs"><%= @execution.trace_id %></dd>
              </div>
            <% end %>
            <% if @execution.span_id.present? %>
              <div class="flex justify-between">
                <dt class="text-gray-500 dark:text-gray-400">Span ID</dt>
                <dd class="font-mono text-gray-900 dark:text-gray-100 text-xs"><%= @execution.span_id %></dd>
              </div>
            <% end %>
          </dl>
        </div>
      <% end %>

      <!-- Caching Information -->
      <% if @execution.cache_hit || @execution.response_cache_key.present? %>
        <div class="bg-gray-50 dark:bg-gray-900/50 rounded-lg p-4">
          <h4 class="text-xs font-semibold text-gray-700 dark:text-gray-300 uppercase tracking-wide mb-3">Caching</h4>
          <dl class="space-y-2 text-sm">
            <div class="flex justify-between">
              <dt class="text-gray-500 dark:text-gray-400">Cache Hit</dt>
              <dd class="font-mono text-gray-900 dark:text-gray-100">
                <% if @execution.cache_hit %>
                  <span class="text-green-600 dark:text-green-400">Yes</span>
                <% else %>
                  <span class="text-gray-400">No</span>
                <% end %>
              </dd>
            </div>
            <% if @execution.response_cache_key.present? %>
              <div class="flex justify-between">
                <dt class="text-gray-500 dark:text-gray-400">Cache Key</dt>
                <dd class="font-mono text-gray-900 dark:text-gray-100 text-xs truncate max-w-xs" title="<%= @execution.response_cache_key %>">
                  <%= @execution.response_cache_key.truncate(30) %>
                </dd>
              </div>
            <% end %>
            <% if @execution.cached_at.present? %>
              <div class="flex justify-between">
                <dt class="text-gray-500 dark:text-gray-400">Cached At</dt>
                <dd class="font-mono text-gray-900 dark:text-gray-100"><%= @execution.cached_at.strftime("%Y-%m-%d %H:%M:%S") %></dd>
              </div>
            <% end %>
          </dl>
        </div>
      <% end %>
    </div>

    <!-- Execution ID -->
    <div class="mt-4 pt-4 border-t border-gray-100 dark:border-gray-700">
      <div class="flex items-center justify-between">
        <span class="text-xs text-gray-500 dark:text-gray-400">
          Execution ID: <code class="bg-gray-100 dark:bg-gray-700 px-1.5 py-0.5 rounded font-mono"><%= @execution.id %></code>
        </span>
        <button
          type="button"
          onclick="copyDiagnostics()"
          class="inline-flex items-center gap-1 px-2 py-1 text-xs font-medium text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700 rounded transition-colors"
        >
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/>
          </svg>
          Copy All
        </button>
      </div>
    </div>
  </div>
</div>

<script>
  // Prompt toggle function
  function togglePrompt(type) {
    const content = document.getElementById(type + '-prompt-content');
    const preview = document.getElementById(type + '-prompt-preview');
    const toggle = document.getElementById(type + '-prompt-toggle');
    const isHidden = content.classList.contains('hidden');
    content.classList.toggle('hidden', !isHidden);
    if (preview) preview.classList.toggle('hidden', isHidden);
    toggle.textContent = isHidden ? 'Collapse' : 'Expand';
  }

  // Masking state (persisted in localStorage)
  let isMasked = localStorage.getItem('ruby_llm_agents_masking') !== 'false';

  function toggleMasking() {
    isMasked = !isMasked;
    localStorage.setItem('ruby_llm_agents_masking', isMasked);
    updateMaskingUI();
  }

  function updateMaskingUI() {
    const status = document.getElementById('masking-status');
    const btnText = document.getElementById('toggle-btn-text');
    const eyeIcon = document.getElementById('eye-icon');
    const eyeOffIcon = document.getElementById('eye-off-icon');

    // Update all maskable content sections
    document.querySelectorAll('[id$="-masked"]').forEach(function(el) {
      el.classList.toggle('hidden', !isMasked);
    });
    document.querySelectorAll('[id$="-original"]').forEach(function(el) {
      el.classList.toggle('hidden', isMasked);
    });

    // Update status and button
    if (isMasked) {
      status.textContent = 'Sensitive data is hidden';
      btnText.textContent = 'Show Original';
      eyeIcon.classList.remove('hidden');
      eyeOffIcon.classList.add('hidden');
    } else {
      status.textContent = 'Showing original data';
      btnText.textContent = 'Hide Sensitive';
      eyeIcon.classList.add('hidden');
      eyeOffIcon.classList.remove('hidden');
    }

    // Update copy buttons to use appropriate data
    document.querySelectorAll('.copy-json-btn').forEach(function(button) {
      const maskedData = button.getAttribute('data-copy-json');
      const originalData = button.getAttribute('data-copy-json-original');
      if (originalData) {
        button.setAttribute('data-active-json', isMasked ? maskedData : originalData);
      }
    });
  }

  document.addEventListener('DOMContentLoaded', function() {
    // Initialize masking UI on page load
    updateMaskingUI();

    document.querySelectorAll('.copy-json-btn').forEach(function(button) {
      button.addEventListener('click', function() {
        // Use active JSON (considers masking state) or fall back to default
        const activeData = this.getAttribute('data-active-json') || this.getAttribute('data-copy-json');
        const jsonText = atob(activeData);
        const span = this.querySelector('span');
        const copyIcon = this.querySelector('.copy-icon');
        const checkIcon = this.querySelector('.check-icon');

        navigator.clipboard.writeText(jsonText).then(function() {
          span.textContent = 'Copied!';
          copyIcon.classList.add('hidden');
          checkIcon.classList.remove('hidden');
          button.classList.add('text-green-600');

          setTimeout(function() {
            span.textContent = 'Copy';
            copyIcon.classList.remove('hidden');
            checkIcon.classList.add('hidden');
            button.classList.remove('text-green-600');
          }, 2000);
        }).catch(function(err) {
          console.error('Failed to copy:', err);
          span.textContent = 'Failed';
          setTimeout(function() {
            span.textContent = 'Copy';
          }, 2000);
        });
      });
    });
  });

  // Rerun modal functions
  function confirmRerun() {
    document.getElementById('rerun-modal').classList.remove('hidden');
    document.body.classList.add('overflow-hidden');
  }

  function closeRerunModal() {
    document.getElementById('rerun-modal').classList.add('hidden');
    document.body.classList.remove('overflow-hidden');
  }

  // Close modal on Escape key
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
      closeRerunModal();
    }
  });

  // Diagnostics panel toggle (default to expanded)
  let diagnosticsExpanded = localStorage.getItem('ruby_llm_agents_diagnostics_expanded') !== 'false';

  function toggleDiagnostics() {
    diagnosticsExpanded = !diagnosticsExpanded;
    localStorage.setItem('ruby_llm_agents_diagnostics_expanded', diagnosticsExpanded);
    updateDiagnosticsUI();
  }

  function updateDiagnosticsUI() {
    const details = document.getElementById('diagnostics-details');
    const toggleText = document.getElementById('diagnostics-toggle-text');
    const expandIcon = document.getElementById('diagnostics-expand-icon');

    if (diagnosticsExpanded) {
      details.classList.remove('hidden');
      toggleText.textContent = 'Collapse';
      expandIcon.style.transform = 'rotate(180deg)';
    } else {
      details.classList.add('hidden');
      toggleText.textContent = 'Expand';
      expandIcon.style.transform = 'rotate(0deg)';
    }
  }

  function copyDiagnostics() {
    const diagnostics = {
      execution_id: <%= @execution.id %>,
      agent_type: "<%= @execution.agent_type %>",
      agent_version: "<%= @execution.agent_version || '1.0' %>",
      model_id: "<%= @execution.model_id %>",
      status: "<%= @execution.status %>",
      temperature: <%= @execution.temperature || 'null' %>,
      duration_ms: <%= @execution.duration_ms || 'null' %>,
      input_tokens: <%= @execution.input_tokens || 0 %>,
      output_tokens: <%= @execution.output_tokens || 0 %>,
      cached_tokens: <%= @execution.cached_tokens || 0 %>,
      total_tokens: <%= @execution.total_tokens || 0 %>,
      input_cost: <%= @execution.input_cost || 0 %>,
      output_cost: <%= @execution.output_cost || 0 %>,
      total_cost: <%= @execution.total_cost || 0 %>,
      started_at: "<%= @execution.started_at&.iso8601 || '' %>",
      completed_at: "<%= @execution.completed_at&.iso8601 || '' %>",
      created_at: "<%= @execution.created_at.iso8601 %>"
    };

    navigator.clipboard.writeText(JSON.stringify(diagnostics, null, 2)).then(function() {
      alert('Diagnostics copied to clipboard!');
    }).catch(function(err) {
      console.error('Failed to copy diagnostics:', err);
    });
  }

  // Initialize diagnostics panel on page load
  document.addEventListener('DOMContentLoaded', function() {
    updateDiagnosticsUI();
  });
</script>
</div>
