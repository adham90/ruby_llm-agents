<div id="execution-detail" data-execution-id="<%= @execution.id %>" data-status="<%= @execution.status %>">

<!-- Back link -->
<nav class="font-mono text-xs mb-6">
  <%= link_to "← executions", ruby_llm_agents.executions_path, class: "text-gray-400 dark:text-gray-500 hover:text-gray-700 dark:hover:text-gray-300" %>
</nav>

<!-- ── header ──────────────────────── -->
<%
  secondary_badges = []
  secondary_badges << { label: "stream", css: "badge-cyan" } if @execution.streaming?
  secondary_badges << { label: "cached", css: "badge-purple" } if @execution.cache_hit
  if @execution.finish_reason.present?
    finish_css = case @execution.finish_reason
      when 'stop' then 'badge-success'
      when 'length' then 'badge-orange'
      when 'content_filter' then 'badge-error'
      when 'tool_calls' then 'badge-cyan'
      else 'badge-timeout'
    end
    secondary_badges << { label: @execution.finish_reason, css: finish_css }
  end
  secondary_badges << { label: "rate limited", css: "badge-orange" } if @execution.respond_to?(:rate_limited?) && @execution.rate_limited?
%>
<div class="flex flex-wrap items-center gap-3 mb-1.5">
  <span class="text-[10px] font-medium text-gray-400 dark:text-gray-600 uppercase tracking-widest font-mono"><%= @execution.agent_type.gsub(/Agent$/, '') %></span>
  <div class="font-mono text-xs text-gray-400 dark:text-gray-500 flex flex-wrap items-center gap-1.5">
    <%= render "ruby_llm/agents/shared/status_badge", status: @execution.status %>
    <% secondary_badges.each do |badge| %>
      <span class="badge badge-sm <%= badge[:css] %>"><%= badge[:label] %></span>
    <% end %>
    <span class="text-gray-800 dark:text-gray-200"><%= @execution.model_id %></span>
    <% if @execution.model_provider.present? %>
      <span class="text-gray-300 dark:text-gray-700">&middot;</span>
      <span><%= @execution.model_provider %></span>
    <% end %>
  </div>
  <%= render "ruby_llm/agents/shared/doc_link" %>
  <div class="flex-1 border-t border-gray-200 dark:border-gray-800"></div>
</div>

<div class="font-mono text-xs text-gray-400 dark:text-gray-500 mb-1">
  #<%= @execution.id %>
  <span class="text-gray-300 dark:text-gray-700">&middot;</span>
  <%= @execution.created_at.strftime("%b %d, %H:%M") %>
  <span class="text-gray-300 dark:text-gray-700">&middot;</span>
  <%= time_ago_in_words(@execution.created_at) %> ago
</div>

<!-- Stats inline row -->
<div class="flex flex-wrap items-center gap-x-4 gap-y-1 font-mono text-xs text-gray-400 dark:text-gray-500 mb-2">
  <span><span class="text-gray-800 dark:text-gray-200"><%= number_to_human_short(@execution.duration_ms || 0) %>ms</span> duration</span>
  <span><span class="text-gray-800 dark:text-gray-200"><%= number_to_human_short(@execution.total_tokens || 0) %></span> tokens</span>
  <span><span class="text-gray-800 dark:text-gray-200"><%= number_to_human_short(@execution.total_cost || 0, prefix: "$", precision: 2) %></span> cost</span>
  <% if @execution.tokens_per_second %>
    <span><span class="text-gray-800 dark:text-gray-200"><%= @execution.tokens_per_second.round(1) %></span> tok/s</span>
  <% end %>
</div>

<!-- ── tokens ──────────────────────── -->
<%
  input_tokens = @execution.input_tokens || 0
  output_tokens = @execution.output_tokens || 0
  total = input_tokens + output_tokens
  input_pct = total > 0 ? (input_tokens.to_f / total * 100).round(1) : 0
  output_pct = total > 0 ? (output_tokens.to_f / total * 100).round(1) : 0
%>
<div class="flex items-center gap-3 mt-6 mb-3">
  <span class="text-[10px] font-medium text-gray-400 dark:text-gray-600 uppercase tracking-widest font-mono">tokens</span>
  <div class="flex-1 border-t border-gray-200 dark:border-gray-800"></div>
</div>

<div class="mb-2">
  <div class="flex justify-between text-xs font-mono mb-1">
    <span class="text-blue-600 dark:text-blue-400">input: <%= number_to_human_short(input_tokens) %> (<%= input_pct %>%)</span>
    <span class="text-green-600 dark:text-green-400">output: <%= number_to_human_short(output_tokens) %> (<%= output_pct %>%)</span>
  </div>
  <div class="h-1.5 bg-gray-100 dark:bg-gray-800 rounded-full overflow-hidden flex">
    <div class="bg-blue-500 transition-all" style="width: <%= input_pct %>%"></div>
    <div class="bg-green-500 transition-all" style="width: <%= output_pct %>%"></div>
  </div>
</div>

<div class="flex flex-wrap items-center gap-x-4 gap-y-1 font-mono text-xs text-gray-400 dark:text-gray-500">
  <span><span class="text-gray-800 dark:text-gray-200"><%= number_to_human_short(input_tokens) %></span> input <span class="text-gray-300 dark:text-gray-700">(<%= number_to_human_short(@execution.input_cost || 0, prefix: "$", precision: 4) %>)</span></span>
  <span><span class="text-gray-800 dark:text-gray-200"><%= number_to_human_short(output_tokens) %></span> output <span class="text-gray-300 dark:text-gray-700">(<%= number_to_human_short(@execution.output_cost || 0, prefix: "$", precision: 4) %>)</span></span>
  <span><span class="text-gray-800 dark:text-gray-200"><%= number_to_human_short(@execution.cached_tokens || 0) %></span> cached</span>
  <span><span class="text-gray-800 dark:text-gray-200"><%= number_to_human_short(@execution.cache_creation_tokens || 0) %></span> cache creation</span>
</div>

<!-- ── attempts ──────────────────────── -->
<% if @execution.respond_to?(:attempts) && @execution.attempts.present? %>
  <div class="flex items-center gap-3 mt-6 mb-3">
    <span class="text-[10px] font-medium text-gray-400 dark:text-gray-600 uppercase tracking-widest font-mono">attempts (<%= @execution.respond_to?(:attempts_count) && @execution.attempts_count ? @execution.attempts_count : @execution.attempts.size %>)</span>
    <div class="font-mono text-xs text-gray-400 dark:text-gray-500 flex items-center gap-1.5">
      <% if @execution.used_fallback? %>
        <span class="badge badge-sm badge-orange">fallback: <%= @execution.chosen_model_id %></span>
      <% end %>
      <% if @execution.has_retries? %>
        <span class="badge badge-sm badge-cyan">retried</span>
      <% end %>
    </div>
    <div class="flex-1 border-t border-gray-200 dark:border-gray-800"></div>
  </div>

  <% error_attempts = @execution.attempts.select { |a| a['error_class'].present? } %>
  <% if error_attempts.any? %>
    <script type="application/json" id="all-errors-data">
      <%= raw error_attempts.map { |a|
        lines = ["#{a['error_class']}: #{a['error_message']}"]
        lines += (a['error_backtrace'] || [])
        "Model: #{a['model_id']}\n#{lines.join("\n")}"
      }.join("\n\n---\n\n").to_json %>
    </script>
    <div class="flex justify-end mb-2">
      <button onclick="var text = JSON.parse(document.getElementById('all-errors-data').textContent); navigator.clipboard.writeText(text).then(function() { var btn = event.currentTarget; btn.textContent = 'copied!'; setTimeout(function() { btn.textContent = 'copy all errors'; }, 2000); });"
              class="font-mono text-xs text-gray-400 dark:text-gray-500 hover:text-gray-700 dark:hover:text-gray-300">
        copy all errors
      </button>
    </div>
  <% end %>

  <div class="overflow-x-auto">
    <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-800">
      <thead>
        <tr>
          <th class="px-3 py-2 text-left text-[10px] font-medium text-gray-400 dark:text-gray-600 uppercase tracking-wider font-mono">#</th>
          <th class="px-3 py-2 text-left text-[10px] font-medium text-gray-400 dark:text-gray-600 uppercase tracking-wider font-mono">model</th>
          <th class="px-3 py-2 text-left text-[10px] font-medium text-gray-400 dark:text-gray-600 uppercase tracking-wider font-mono">status</th>
          <th class="px-3 py-2 text-left text-[10px] font-medium text-gray-400 dark:text-gray-600 uppercase tracking-wider font-mono">duration</th>
          <th class="px-3 py-2 text-left text-[10px] font-medium text-gray-400 dark:text-gray-600 uppercase tracking-wider font-mono">tokens</th>
          <th class="px-3 py-2 text-left text-[10px] font-medium text-gray-400 dark:text-gray-600 uppercase tracking-wider font-mono">error</th>
        </tr>
      </thead>
      <tbody class="divide-y divide-gray-100 dark:divide-gray-800">
        <% @execution.attempts.each_with_index do |attempt, index| %>
          <tr class="<%= attempt['short_circuited'] ? 'bg-gray-50 dark:bg-gray-900/50' : '' %>">
            <td class="px-3 py-2 text-xs font-mono text-gray-500 dark:text-gray-400"><%= index + 1 %></td>
            <td class="px-3 py-2 text-xs font-mono text-gray-900 dark:text-gray-100"><%= attempt['model_id'] %></td>
            <td class="px-3 py-2">
              <% if attempt['short_circuited'] %>
                <span class="badge badge-sm badge-timeout">blocked</span>
              <% elsif attempt['error_class'].present? %>
                <span class="badge badge-sm badge-error">failed</span>
              <% else %>
                <span class="badge badge-sm badge-success">success</span>
              <% end %>
            </td>
            <td class="px-3 py-2 text-xs font-mono text-gray-500 dark:text-gray-400">
              <%= attempt['duration_ms'] ? "#{attempt['duration_ms']}ms" : '-' %>
            </td>
            <td class="px-3 py-2 text-xs font-mono text-gray-500 dark:text-gray-400">
              <% if attempt['input_tokens'] || attempt['output_tokens'] %>
                <span class="text-blue-600 dark:text-blue-400"><%= attempt['input_tokens'] || 0 %></span>
                /
                <span class="text-green-600 dark:text-green-400"><%= attempt['output_tokens'] || 0 %></span>
              <% else %>
                -
              <% end %>
            </td>
            <td class="px-3 py-2 text-xs max-w-xs">
              <% if attempt['error_class'].present? %>
                <span class="text-red-600 dark:text-red-400 font-mono font-medium"><%= attempt['error_class'].split('::').last %></span>
                <p class="text-red-500 dark:text-red-400 text-xs mt-0.5 break-words"><%= attempt['error_message'].to_s.truncate(150) %></p>
                <% if attempt['error_backtrace'].present? %>
                  <button onclick="var el = document.getElementById('backtrace-<%= index %>'); el.classList.toggle('hidden');"
                          class="text-xs font-mono text-gray-400 dark:text-gray-500 hover:text-red-500 dark:hover:text-red-400 mt-1 underline">
                    stack trace
                  </button>
                <% end %>
              <% else %>
                <span class="text-gray-400">-</span>
              <% end %>
            </td>
          </tr>
          <% if attempt['error_backtrace'].present? %>
            <tr id="backtrace-<%= index %>" class="hidden">
              <td colspan="6" class="px-3 py-2">
                <div class="bg-gray-900 text-gray-100 text-xs font-mono p-3 rounded max-h-64 overflow-auto whitespace-pre-wrap relative group/bt">
                  <button onclick="var el = document.getElementById('backtrace-text-<%= index %>'); navigator.clipboard.writeText(el.textContent.trim()).then(function() { var btn = event.currentTarget; btn.textContent = 'copied!'; setTimeout(function() { btn.textContent = 'copy'; }, 2000); });"
                          class="absolute top-2 right-2 text-xs font-mono text-gray-400 hover:text-white transition-colors">
                    copy
                  </button>
                  <div id="backtrace-text-<%= index %>">
                    <div class="font-semibold text-red-400 mb-1"><%= attempt['error_class'] %>: <%= attempt['error_message'].to_s.truncate(200) %></div>
                    <% attempt['error_backtrace'].each do |line| %>
                      <div class="text-gray-300 leading-relaxed"><%= line %></div>
                    <% end %>
                  </div>
                </div>
              </td>
            </tr>
          <% end %>
        <% end %>
      </tbody>
    </table>
  </div>

  <% if @execution.fallback_chain.present? && @execution.fallback_chain.any? %>
    <div class="mt-3 font-mono text-xs text-gray-400 dark:text-gray-500">
      <span class="text-gray-800 dark:text-gray-200">fallback chain:</span>
      <%= @execution.fallback_chain.join(' → ') %>
      <% if @execution.fallback_reason.present? %>
        <span class="text-gray-300 dark:text-gray-700">&middot;</span>
        <span class="text-amber-600 dark:text-amber-400"><%= @execution.fallback_reason %></span>
      <% end %>
    </div>
  <% end %>
<% end %>

<!-- ── error ──────────────────────── -->
<% if @execution.status_error? %>
  <div class="flex items-center gap-3 mt-6 mb-3">
    <span class="text-[10px] font-medium text-gray-400 dark:text-gray-600 uppercase tracking-widest font-mono">error</span>
    <div class="font-mono text-xs text-gray-400 dark:text-gray-500 flex items-center gap-1.5">
      <% if @execution.rate_limited? %>
        <span class="badge badge-sm badge-orange">rate limited</span>
      <% end %>
      <% if @execution.retryable %>
        <span class="badge badge-sm badge-cyan">retryable</span>
      <% end %>
    </div>
    <div class="flex-1 border-t border-gray-200 dark:border-gray-800"></div>
    <button
      type="button"
      data-copy-json="<%= Base64.strict_encode64({
        error_class: @execution.error_class,
        error_message: @execution.error_message
      }.to_json) %>"
      class="copy-json-btn font-mono text-xs text-gray-400 dark:text-gray-500 hover:text-gray-700 dark:hover:text-gray-300"
    >copy</button>
  </div>

  <p class="font-mono text-xs text-red-700 dark:text-red-400 mb-2"><%= @execution.error_class %></p>
  <pre class="bg-red-50 dark:bg-red-500/10 text-red-900 dark:text-red-200 rounded p-4 text-xs overflow-x-auto font-mono"><%= @execution.error_message %></pre>
<% end %>

<!-- ── parameters ──────────────────── -->
<div class="flex items-center gap-3 mt-6 mb-3">
  <span class="text-[10px] font-medium text-gray-400 dark:text-gray-600 uppercase tracking-widest font-mono">parameters</span>
  <div class="flex-1 border-t border-gray-200 dark:border-gray-800"></div>
  <button
    type="button"
    data-copy-json="<%= Base64.strict_encode64(JSON.pretty_generate(@execution.parameters || {})) %>"
    class="copy-json-btn font-mono text-xs text-gray-400 dark:text-gray-500 hover:text-gray-700 dark:hover:text-gray-300"
  >copy</button>
</div>
<pre class="bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-gray-100 rounded p-4 text-xs overflow-x-auto font-mono"><%= highlight_json(@execution.parameters || {}) %></pre>

<!-- ── response ──────────────────────── -->
<% if @execution.response.present? %>
  <div class="flex items-center gap-3 mt-6 mb-3">
    <span class="text-[10px] font-medium text-gray-400 dark:text-gray-600 uppercase tracking-widest font-mono">response</span>
    <div class="flex-1 border-t border-gray-200 dark:border-gray-800"></div>
    <button
      type="button"
      data-copy-json="<%= Base64.strict_encode64(JSON.pretty_generate(@execution.response)) %>"
      class="copy-json-btn font-mono text-xs text-gray-400 dark:text-gray-500 hover:text-gray-700 dark:hover:text-gray-300"
    >copy</button>
  </div>
  <pre class="bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-gray-100 rounded p-4 text-xs overflow-x-auto max-h-96 font-mono"><%= highlight_json(@execution.response) %></pre>
<% end %>

<!-- ── tool calls ──────────────────── -->
<% tool_calls = @execution.tool_calls || [] %>
<% tool_call_count = tool_calls.size %>
<div x-data="{ expanded: <%= tool_call_count <= 3 && tool_call_count > 0 %> }">
  <div class="flex items-center gap-3 mt-6 mb-3">
    <span class="text-[10px] font-medium text-gray-400 dark:text-gray-600 uppercase tracking-widest font-mono">tool calls (<%= tool_call_count %>)</span>
    <div class="flex-1 border-t border-gray-200 dark:border-gray-800"></div>
    <% if tool_call_count > 0 %>
      <button
        type="button"
        data-copy-json="<%= Base64.strict_encode64(JSON.pretty_generate(tool_calls)) %>"
        class="copy-json-btn font-mono text-xs text-gray-400 dark:text-gray-500 hover:text-gray-700 dark:hover:text-gray-300"
      >copy</button>
      <% if tool_call_count > 3 %>
        <button type="button" @click="expanded = !expanded" class="font-mono text-xs text-gray-400 dark:text-gray-500 hover:text-gray-700 dark:hover:text-gray-300">
          <span x-text="expanded ? 'collapse' : 'expand'">expand</span>
        </button>
      <% end %>
    <% end %>
  </div>

  <% if tool_call_count > 0 %>
    <div class="space-y-3" x-show="expanded" x-cloak>
      <% tool_calls.each_with_index do |tool_call, index| %>
        <%
          tool_id = tool_call['id'] || tool_call[:id]
          tool_name = tool_call['name'] || tool_call[:name]
          tool_args = tool_call['arguments'] || tool_call[:arguments] || {}
          tool_result = tool_call['result'] || tool_call[:result]
          tool_status = tool_call['status'] || tool_call[:status] || 'unknown'
          tool_error = tool_call['error_message'] || tool_call[:error_message]
          tool_duration = tool_call['duration_ms'] || tool_call[:duration_ms]
          tool_called_at = tool_call['called_at'] || tool_call[:called_at]

          status_css = case tool_status
            when 'success' then 'badge-success'
            when 'error' then 'badge-error'
            else 'badge-timeout'
          end
        %>
        <div class="border border-gray-200 dark:border-gray-800 rounded overflow-hidden">
          <div class="bg-gray-50 dark:bg-gray-900/50 px-3 py-2">
            <div class="flex items-center justify-between">
              <div class="flex items-center gap-2 font-mono text-xs">
                <span class="text-gray-400 dark:text-gray-600"><%= index + 1 %></span>
                <code class="font-semibold text-gray-900 dark:text-gray-100"><%= tool_name %></code>
                <span class="badge badge-sm <%= status_css %>"><%= tool_status %></span>
                <% if tool_duration.present? %>
                  <span class="badge badge-sm badge-purple"><%= tool_duration %>ms</span>
                <% end %>
              </div>
              <div class="flex items-center gap-2 font-mono text-xs text-gray-400 dark:text-gray-600">
                <% if tool_called_at.present? %>
                  <span title="Called at"><%= Time.parse(tool_called_at).strftime("%H:%M:%S.%L") rescue tool_called_at %></span>
                <% end %>
                <% if tool_id.present? %>
                  <span class="truncate max-w-[120px]" title="<%= tool_id %>"><%= tool_id.to_s.truncate(16) %></span>
                <% end %>
              </div>
            </div>
          </div>

          <% if tool_args.present? && tool_args.any? %>
            <div class="px-3 py-2 border-t border-gray-100 dark:border-gray-800">
              <p class="text-[10px] text-gray-400 dark:text-gray-600 uppercase tracking-wider font-mono mb-1">arguments</p>
              <pre class="bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-gray-100 rounded p-2 text-xs overflow-x-auto font-mono"><%= highlight_json(tool_args) %></pre>
            </div>
          <% else %>
            <div class="px-3 py-2 border-t border-gray-100 dark:border-gray-800">
              <p class="text-xs text-gray-400 dark:text-gray-600 font-mono italic">no arguments</p>
            </div>
          <% end %>

          <% if tool_result.present? %>
            <div class="px-3 py-2 border-t border-gray-100 dark:border-gray-800">
              <p class="text-[10px] text-gray-400 dark:text-gray-600 uppercase tracking-wider font-mono mb-1">result</p>
              <div class="bg-gray-50 dark:bg-gray-900 rounded p-2 max-h-48 overflow-y-auto">
                <pre class="text-xs text-gray-900 dark:text-gray-100 font-mono whitespace-pre-wrap break-words"><%= tool_result.is_a?(String) ? tool_result : JSON.pretty_generate(tool_result) rescue tool_result.to_s %></pre>
              </div>
            </div>
          <% end %>

          <% if tool_status == 'error' && tool_error.present? %>
            <div class="px-3 py-2 border-t border-red-100 dark:border-red-500/30 bg-red-50 dark:bg-red-500/10">
              <p class="text-[10px] text-red-600 dark:text-red-400 uppercase tracking-wider font-mono mb-1">error</p>
              <pre class="text-xs text-red-700 dark:text-red-300 font-mono whitespace-pre-wrap break-words"><%= tool_error %></pre>
            </div>
          <% end %>
        </div>
      <% end %>
    </div>
  <% else %>
    <p class="text-xs text-gray-400 dark:text-gray-600 font-mono italic">no tool calls</p>
  <% end %>
</div>

<!-- ── metadata ──────────────────────── -->
<% if @execution.metadata.present? && @execution.metadata.any? %>
  <div x-data="{ expanded: false }">
    <div class="flex items-center gap-3 mt-6 mb-3">
      <span class="text-[10px] font-medium text-gray-400 dark:text-gray-600 uppercase tracking-widest font-mono">metadata (<%= @execution.metadata.keys.count %>)</span>
      <div class="flex-1 border-t border-gray-200 dark:border-gray-800"></div>
      <button
        type="button"
        data-copy-json="<%= Base64.strict_encode64(JSON.pretty_generate(@execution.metadata)) %>"
        class="copy-json-btn font-mono text-xs text-gray-400 dark:text-gray-500 hover:text-gray-700 dark:hover:text-gray-300"
      >copy</button>
      <button type="button" @click="expanded = !expanded" class="font-mono text-xs text-gray-400 dark:text-gray-500 hover:text-gray-700 dark:hover:text-gray-300">
        <span x-text="expanded ? 'collapse' : 'expand'">expand</span>
      </button>
    </div>
    <div x-show="expanded" x-cloak>
      <pre class="bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-gray-100 rounded p-4 text-xs overflow-x-auto font-mono"><%= highlight_json(@execution.metadata) %></pre>
    </div>
  </div>
<% end %>

<!-- ── hierarchy ──────────────────────── -->
<% if @execution.parent_execution_id.present? || (@execution.respond_to?(:child_executions) && @execution.child_executions.any?) %>
  <div class="flex items-center gap-3 mt-6 mb-3">
    <span class="text-[10px] font-medium text-gray-400 dark:text-gray-600 uppercase tracking-widest font-mono">hierarchy</span>
    <div class="flex-1 border-t border-gray-200 dark:border-gray-800"></div>
  </div>

  <div class="font-mono text-xs space-y-1.5">
    <% if @execution.parent_execution_id.present? %>
      <div class="text-gray-400 dark:text-gray-500">
        parent:
        <%= link_to "##{@execution.parent_execution_id}",
            ruby_llm_agents.execution_path(@execution.parent_execution_id),
            class: "text-blue-600 dark:text-blue-400 hover:underline" %>
      </div>
    <% end %>

    <% if @execution.respond_to?(:child_executions) && @execution.child_executions.any? %>
      <div class="text-gray-400 dark:text-gray-500">
        children (<%= @execution.child_executions.count %>):
        <span class="inline-flex flex-wrap gap-1.5 ml-1">
          <% @execution.child_executions.limit(10).each do |child| %>
            <%= link_to "##{child.id}",
                ruby_llm_agents.execution_path(child),
                class: "text-blue-600 dark:text-blue-400 hover:underline" %>
          <% end %>
          <% if @execution.child_executions.count > 10 %>
            <span>+<%= @execution.child_executions.count - 10 %> more</span>
          <% end %>
        </span>
      </div>
    <% end %>
  </div>
<% end %>

<!-- ── system prompt ──────────────────── -->
<% if @execution.system_prompt.present? %>
  <div class="flex items-center gap-3 mt-6 mb-3">
    <span class="text-[10px] font-medium text-gray-400 dark:text-gray-600 uppercase tracking-widest font-mono">system prompt</span>
    <div class="flex-1 border-t border-gray-200 dark:border-gray-800"></div>
    <button type="button" onclick="togglePrompt('system')" class="font-mono text-xs text-gray-400 dark:text-gray-500 hover:text-gray-700 dark:hover:text-gray-300">
      <span id="system-prompt-toggle">expand</span>
    </button>
  </div>
  <p id="system-prompt-preview" class="text-xs text-gray-600 dark:text-gray-300 font-mono bg-gray-50 dark:bg-gray-900 rounded p-3 truncate"><%= @execution.system_prompt.truncate(150) %></p>
  <pre id="system-prompt-content" class="hidden bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-gray-100 rounded p-4 text-xs overflow-x-auto max-h-96 font-mono whitespace-pre-wrap"><%= @execution.system_prompt %></pre>
<% end %>

<!-- ── user prompt ──────────────────── -->
<% if @execution.user_prompt.present? %>
  <div class="flex items-center gap-3 mt-6 mb-3">
    <span class="text-[10px] font-medium text-gray-400 dark:text-gray-600 uppercase tracking-widest font-mono">user prompt</span>
    <div class="flex-1 border-t border-gray-200 dark:border-gray-800"></div>
    <button type="button" onclick="togglePrompt('user')" class="font-mono text-xs text-gray-400 dark:text-gray-500 hover:text-gray-700 dark:hover:text-gray-300">
      <span id="user-prompt-toggle">expand</span>
    </button>
  </div>
  <p id="user-prompt-preview" class="text-xs text-gray-600 dark:text-gray-300 font-mono bg-gray-50 dark:bg-gray-900 rounded p-3 truncate"><%= @execution.user_prompt.truncate(150) %></p>
  <pre id="user-prompt-content" class="hidden bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-gray-100 rounded p-4 text-xs overflow-x-auto max-h-96 font-mono whitespace-pre-wrap"><%= @execution.user_prompt %></pre>
<% end %>

<!-- ── conversation ──────────────────── -->
<% if @execution.respond_to?(:messages_count) && @execution.messages_count.to_i > 0 %>
  <%
    messages_summary = @execution.messages_summary || {}
    first_message = messages_summary["first"] || messages_summary[:first]
    last_message = messages_summary["last"] || messages_summary[:last]
    max_len = RubyLLM::Agents.configuration.messages_summary_max_length || 500
  %>
  <div class="flex items-center gap-3 mt-6 mb-3">
    <span class="text-[10px] font-medium text-gray-400 dark:text-gray-600 uppercase tracking-widest font-mono">conversation (<%= @execution.messages_count %>)</span>
    <div class="flex-1 border-t border-gray-200 dark:border-gray-800"></div>
  </div>

  <div class="space-y-3">
    <% if first_message %>
      <%
        first_role = first_message["role"] || first_message[:role] || "unknown"
        first_content = first_message["content"] || first_message[:content] || ""
        first_truncated = first_content.length >= max_len
        role_css = case first_role.to_s
          when "user" then "badge-cyan"
          when "assistant" then "badge-success"
          when "system" then "badge-timeout"
          else "badge-timeout"
        end
      %>
      <div>
        <div class="flex items-center gap-2 mb-1 font-mono text-xs">
          <span class="text-gray-400 dark:text-gray-600">first</span>
          <span class="badge badge-sm <%= role_css %>"><%= first_role %></span>
          <% if first_truncated %>
            <span class="text-gray-400 dark:text-gray-600 italic">(truncated)</span>
          <% end %>
        </div>
        <p class="text-xs text-gray-700 dark:text-gray-300 font-mono bg-gray-50 dark:bg-gray-900 rounded p-3 whitespace-pre-wrap break-words"><%= first_content %></p>
      </div>
    <% end %>

    <% if last_message %>
      <%
        last_role = last_message["role"] || last_message[:role] || "unknown"
        last_content = last_message["content"] || last_message[:content] || ""
        last_truncated = last_content.length >= max_len
        role_css = case last_role.to_s
          when "user" then "badge-cyan"
          when "assistant" then "badge-success"
          when "system" then "badge-timeout"
          else "badge-timeout"
        end
      %>
      <div>
        <div class="flex items-center gap-2 mb-1 font-mono text-xs">
          <span class="text-gray-400 dark:text-gray-600">last</span>
          <span class="badge badge-sm <%= role_css %>"><%= last_role %></span>
          <% if last_truncated %>
            <span class="text-gray-400 dark:text-gray-600 italic">(truncated)</span>
          <% end %>
        </div>
        <p class="text-xs text-gray-700 dark:text-gray-300 font-mono bg-gray-50 dark:bg-gray-900 rounded p-3 whitespace-pre-wrap break-words"><%= last_content %></p>
      </div>
    <% end %>

    <% if @execution.messages_count > 2 %>
      <p class="text-xs text-gray-400 dark:text-gray-600 font-mono text-center">
        + <%= @execution.messages_count - 2 %> more message<%= @execution.messages_count - 2 == 1 ? '' : 's' %> in between
      </p>
    <% end %>
  </div>
<% end %>

<!-- ── diagnostics ──────────────────── -->
<div x-data="{ expanded: localStorage.getItem('ruby_llm_agents_diagnostics_expanded') !== 'false' }">
  <div class="flex items-center gap-3 mt-6 mb-3">
    <span class="text-[10px] font-medium text-gray-400 dark:text-gray-600 uppercase tracking-widest font-mono">diagnostics</span>
    <div class="flex-1 border-t border-gray-200 dark:border-gray-800"></div>
    <button type="button"
      @click="expanded = !expanded; localStorage.setItem('ruby_llm_agents_diagnostics_expanded', expanded)"
      class="font-mono text-xs text-gray-400 dark:text-gray-500 hover:text-gray-700 dark:hover:text-gray-300">
      <span x-text="expanded ? 'collapse' : 'expand'">expand</span>
    </button>
  </div>

  <!-- Quick info (always visible) -->
  <div class="flex flex-wrap items-center gap-x-4 gap-y-1 font-mono text-xs text-gray-400 dark:text-gray-500">
    <span><span class="text-gray-800 dark:text-gray-200"><%= @execution.model_id %></span></span>
    <% if @execution.temperature %>
      <span>temp <span class="text-gray-800 dark:text-gray-200"><%= @execution.temperature %></span></span>
    <% end %>
    <span><span class="text-gray-800 dark:text-gray-200"><%= @execution.status %></span></span>
  </div>

  <!-- Expanded details -->
  <div x-show="expanded" x-cloak class="mt-4 space-y-4">
    <!-- Timing -->
    <div>
      <p class="text-[10px] text-gray-400 dark:text-gray-600 uppercase tracking-wider font-mono mb-1.5">timing</p>
      <dl class="font-mono text-xs space-y-1">
        <div class="flex justify-between">
          <dt class="text-gray-400 dark:text-gray-500">started</dt>
          <dd class="text-gray-900 dark:text-gray-100"><%= @execution.started_at&.strftime("%Y-%m-%d %H:%M:%S.%L") || 'N/A' %></dd>
        </div>
        <div class="flex justify-between">
          <dt class="text-gray-400 dark:text-gray-500">completed</dt>
          <dd class="text-gray-900 dark:text-gray-100"><%= @execution.completed_at&.strftime("%Y-%m-%d %H:%M:%S.%L") || 'N/A' %></dd>
        </div>
        <div class="flex justify-between">
          <dt class="text-gray-400 dark:text-gray-500">duration</dt>
          <dd class="text-gray-900 dark:text-gray-100"><%= @execution.duration_ms ? "#{@execution.duration_ms}ms" : 'N/A' %></dd>
        </div>
        <% if @execution.streaming? && @execution.time_to_first_token_ms %>
          <div class="flex justify-between">
            <dt class="text-gray-400 dark:text-gray-500">time to first token</dt>
            <dd class="text-gray-900 dark:text-gray-100"><%= @execution.time_to_first_token_ms %>ms</dd>
          </div>
        <% end %>
        <div class="flex justify-between">
          <dt class="text-gray-400 dark:text-gray-500">created at</dt>
          <dd class="text-gray-900 dark:text-gray-100"><%= @execution.created_at.strftime("%Y-%m-%d %H:%M:%S") %></dd>
        </div>
      </dl>
    </div>

    <!-- Performance -->
    <div>
      <p class="text-[10px] text-gray-400 dark:text-gray-600 uppercase tracking-wider font-mono mb-1.5">performance</p>
      <dl class="font-mono text-xs space-y-1">
        <div class="flex justify-between">
          <dt class="text-gray-400 dark:text-gray-500">tokens/second</dt>
          <dd class="text-gray-900 dark:text-gray-100"><%= @execution.tokens_per_second&.round(1) || 'N/A' %></dd>
        </div>
        <div class="flex justify-between">
          <dt class="text-gray-400 dark:text-gray-500">input tokens</dt>
          <dd class="text-gray-900 dark:text-gray-100"><%= @execution.input_tokens || 0 %></dd>
        </div>
        <div class="flex justify-between">
          <dt class="text-gray-400 dark:text-gray-500">output tokens</dt>
          <dd class="text-gray-900 dark:text-gray-100"><%= @execution.output_tokens || 0 %></dd>
        </div>
        <div class="flex justify-between">
          <dt class="text-gray-400 dark:text-gray-500">cached tokens</dt>
          <dd class="text-gray-900 dark:text-gray-100"><%= @execution.cached_tokens || 0 %></dd>
        </div>
      </dl>
    </div>

    <!-- Cost -->
    <div>
      <p class="text-[10px] text-gray-400 dark:text-gray-600 uppercase tracking-wider font-mono mb-1.5">cost</p>
      <dl class="font-mono text-xs space-y-1">
        <div class="flex justify-between">
          <dt class="text-gray-400 dark:text-gray-500">input cost</dt>
          <dd class="text-gray-900 dark:text-gray-100">$<%= number_with_precision(@execution.input_cost || 0, precision: 6) %></dd>
        </div>
        <div class="flex justify-between">
          <dt class="text-gray-400 dark:text-gray-500">output cost</dt>
          <dd class="text-gray-900 dark:text-gray-100">$<%= number_with_precision(@execution.output_cost || 0, precision: 6) %></dd>
        </div>
        <div class="flex justify-between">
          <dt class="text-gray-400 dark:text-gray-500">total cost</dt>
          <dd class="text-gray-800 dark:text-gray-200 font-semibold">$<%= number_with_precision(@execution.total_cost || 0, precision: 6) %></dd>
        </div>
      </dl>
    </div>

    <!-- Configuration -->
    <div>
      <p class="text-[10px] text-gray-400 dark:text-gray-600 uppercase tracking-wider font-mono mb-1.5">configuration</p>
      <dl class="font-mono text-xs space-y-1">
        <div class="flex justify-between">
          <dt class="text-gray-400 dark:text-gray-500">agent type</dt>
          <dd class="text-gray-900 dark:text-gray-100"><%= @execution.agent_type %></dd>
        </div>
        <div class="flex justify-between">
          <dt class="text-gray-400 dark:text-gray-500">temperature</dt>
          <dd class="text-gray-900 dark:text-gray-100"><%= @execution.temperature || 'default' %></dd>
        </div>
        <% if @execution.respond_to?(:chosen_model_id) && @execution.chosen_model_id.present? && @execution.chosen_model_id != @execution.model_id %>
          <div class="flex justify-between">
            <dt class="text-gray-400 dark:text-gray-500">chosen model</dt>
            <dd class="text-amber-600 dark:text-amber-400"><%= @execution.chosen_model_id %></dd>
          </div>
        <% end %>
        <% if @execution.respond_to?(:attempts_count) && @execution.attempts_count && @execution.attempts_count > 1 %>
          <div class="flex justify-between">
            <dt class="text-gray-400 dark:text-gray-500">retry count</dt>
            <dd class="text-blue-600 dark:text-blue-400"><%= @execution.attempts_count - 1 %></dd>
          </div>
        <% end %>
      </dl>
    </div>

    <!-- Tracing -->
    <% if @execution.trace_id.present? || @execution.request_id.present? %>
      <div>
        <p class="text-[10px] text-gray-400 dark:text-gray-600 uppercase tracking-wider font-mono mb-1.5">tracing</p>
        <dl class="font-mono text-xs space-y-1">
          <% if @execution.request_id.present? %>
            <div class="flex justify-between">
              <dt class="text-gray-400 dark:text-gray-500">request id</dt>
              <dd class="text-gray-900 dark:text-gray-100 text-[11px]"><%= @execution.request_id %></dd>
            </div>
          <% end %>
          <% if @execution.trace_id.present? %>
            <div class="flex justify-between">
              <dt class="text-gray-400 dark:text-gray-500">trace id</dt>
              <dd class="text-gray-900 dark:text-gray-100 text-[11px]"><%= @execution.trace_id %></dd>
            </div>
          <% end %>
          <% if @execution.span_id.present? %>
            <div class="flex justify-between">
              <dt class="text-gray-400 dark:text-gray-500">span id</dt>
              <dd class="text-gray-900 dark:text-gray-100 text-[11px]"><%= @execution.span_id %></dd>
            </div>
          <% end %>
        </dl>
      </div>
    <% end %>

    <!-- Caching -->
    <% if @execution.cache_hit || @execution.response_cache_key.present? %>
      <div>
        <p class="text-[10px] text-gray-400 dark:text-gray-600 uppercase tracking-wider font-mono mb-1.5">caching</p>
        <dl class="font-mono text-xs space-y-1">
          <div class="flex justify-between">
            <dt class="text-gray-400 dark:text-gray-500">cache hit</dt>
            <dd class="<%= @execution.cache_hit ? 'text-green-600 dark:text-green-400' : 'text-gray-400' %>"><%= @execution.cache_hit ? 'yes' : 'no' %></dd>
          </div>
          <% if @execution.response_cache_key.present? %>
            <div class="flex justify-between">
              <dt class="text-gray-400 dark:text-gray-500">cache key</dt>
              <dd class="text-gray-900 dark:text-gray-100 text-[11px] truncate max-w-xs" title="<%= @execution.response_cache_key %>"><%= @execution.response_cache_key.truncate(30) %></dd>
            </div>
          <% end %>
          <% if @execution.cached_at.present? %>
            <div class="flex justify-between">
              <dt class="text-gray-400 dark:text-gray-500">cached at</dt>
              <dd class="text-gray-900 dark:text-gray-100"><%= @execution.cached_at.strftime("%Y-%m-%d %H:%M:%S") %></dd>
            </div>
          <% end %>
        </dl>
      </div>
    <% end %>

    <!-- Footer: id + copy all -->
    <div class="flex items-center justify-between pt-3 border-t border-gray-200 dark:border-gray-800">
      <span class="font-mono text-xs text-gray-400 dark:text-gray-500">
        id: <span class="text-gray-800 dark:text-gray-200"><%= @execution.id %></span>
      </span>
      <button
        type="button"
        onclick="copyDiagnostics()"
        class="font-mono text-xs text-gray-400 dark:text-gray-500 hover:text-gray-700 dark:hover:text-gray-300"
      >copy all</button>
    </div>
  </div>
</div>

<script>
  // Prompt toggle function
  function togglePrompt(type) {
    const content = document.getElementById(type + '-prompt-content');
    const preview = document.getElementById(type + '-prompt-preview');
    const toggle = document.getElementById(type + '-prompt-toggle');
    const isHidden = content.classList.contains('hidden');
    content.classList.toggle('hidden', !isHidden);
    if (preview) preview.classList.toggle('hidden', isHidden);
    toggle.textContent = isHidden ? 'collapse' : 'expand';
  }

  document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.copy-json-btn').forEach(function(button) {
      button.addEventListener('click', function() {
        const jsonText = atob(this.getAttribute('data-copy-json'));
        const btn = this;
        const originalText = btn.textContent;

        navigator.clipboard.writeText(jsonText).then(function() {
          btn.textContent = 'copied!';
          setTimeout(function() {
            btn.textContent = originalText;
          }, 2000);
        }).catch(function(err) {
          console.error('Failed to copy:', err);
          btn.textContent = 'failed';
          setTimeout(function() {
            btn.textContent = originalText;
          }, 2000);
        });
      });
    });
  });

  function copyDiagnostics() {
    const diagnostics = {
      execution_id: <%= @execution.id %>,
      agent_type: "<%= @execution.agent_type %>",
      model_id: "<%= @execution.model_id %>",
      status: "<%= @execution.status %>",
      temperature: <%= @execution.temperature || 'null' %>,
      duration_ms: <%= @execution.duration_ms || 'null' %>,
      input_tokens: <%= @execution.input_tokens || 0 %>,
      output_tokens: <%= @execution.output_tokens || 0 %>,
      cached_tokens: <%= @execution.cached_tokens || 0 %>,
      total_tokens: <%= @execution.total_tokens || 0 %>,
      input_cost: <%= @execution.input_cost || 0 %>,
      output_cost: <%= @execution.output_cost || 0 %>,
      total_cost: <%= @execution.total_cost || 0 %>,
      started_at: "<%= @execution.started_at&.iso8601 || '' %>",
      completed_at: "<%= @execution.completed_at&.iso8601 || '' %>",
      created_at: "<%= @execution.created_at.iso8601 %>"
    };

    const btn = event.currentTarget;
    navigator.clipboard.writeText(JSON.stringify(diagnostics, null, 2)).then(function() {
      btn.textContent = 'copied!';
      setTimeout(function() {
        btn.textContent = 'copy all';
      }, 2000);
    }).catch(function(err) {
      console.error('Failed to copy diagnostics:', err);
    });
  }
</script>
</div>
