<h2 class="text-2xl font-bold text-gray-900 dark:text-gray-100 mb-6">Executions</h2>

<div id="executions_content" x-data="{ activeTab: '<%= params[:execution_type] || 'all' %>', activeWorkflowType: '<%= params[:workflow_type_tab] %>' }">
  <!-- Top-Level Execution Type Tabs -->
  <div class="border-b border-gray-200 dark:border-gray-700 mb-4">
    <nav class="-mb-px flex space-x-6" aria-label="Execution Types">
      <button type="button" @click="activeTab = 'all'; activeWorkflowType = ''; submitFilters()"
              :class="activeTab === 'all' ? 'border-blue-500 text-blue-600 dark:text-blue-400' : 'border-transparent text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300'"
              class="whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm transition-colors">
        All
      </button>
      <button type="button" @click="activeTab = 'agents'; activeWorkflowType = ''; submitFilters()"
              :class="activeTab === 'agents' ? 'border-blue-500 text-blue-600 dark:text-blue-400' : 'border-transparent text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300'"
              class="whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm transition-colors">
        Agents Only
      </button>
      <button type="button" @click="activeTab = 'workflows'; activeWorkflowType = ''; submitFilters()"
              :class="activeTab === 'workflows' ? 'border-blue-500 text-blue-600 dark:text-blue-400' : 'border-transparent text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300'"
              class="whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm transition-colors">
        Workflows
      </button>
    </nav>
  </div>

  <!-- Workflow Sub-tabs -->
  <div x-show="activeTab === 'workflows'" x-cloak class="mb-4">
    <div class="flex flex-wrap gap-2">
      <button type="button" @click="activeWorkflowType = ''; submitFilters()"
              :class="activeWorkflowType === '' ? 'bg-gray-900 dark:bg-gray-100 text-white dark:text-gray-900' : 'bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-600'"
              class="px-3 py-1.5 rounded-md text-sm font-medium transition-colors">
        All Workflows
      </button>
      <button type="button" @click="activeWorkflowType = 'pipeline'; submitFilters()"
              :class="activeWorkflowType === 'pipeline' ? 'bg-indigo-600 text-white' : 'bg-indigo-100 dark:bg-indigo-900/50 text-indigo-700 dark:text-indigo-300 hover:bg-indigo-200 dark:hover:bg-indigo-800'"
              class="px-3 py-1.5 rounded-md text-sm font-medium transition-colors inline-flex items-center gap-1.5">
        <span aria-hidden="true">-></span> Pipeline
      </button>
      <button type="button" @click="activeWorkflowType = 'parallel'; submitFilters()"
              :class="activeWorkflowType === 'parallel' ? 'bg-cyan-600 text-white' : 'bg-cyan-100 dark:bg-cyan-900/50 text-cyan-700 dark:text-cyan-300 hover:bg-cyan-200 dark:hover:bg-cyan-800'"
              class="px-3 py-1.5 rounded-md text-sm font-medium transition-colors inline-flex items-center gap-1.5">
        <span aria-hidden="true">//</span> Parallel
      </button>
      <button type="button" @click="activeWorkflowType = 'router'; submitFilters()"
              :class="activeWorkflowType === 'router' ? 'bg-amber-600 text-white' : 'bg-amber-100 dark:bg-amber-900/50 text-amber-700 dark:text-amber-300 hover:bg-amber-200 dark:hover:bg-amber-800'"
              class="px-3 py-1.5 rounded-md text-sm font-medium transition-colors inline-flex items-center gap-1.5">
        <span aria-hidden="true">&lt;&gt;</span> Router
      </button>
    </div>
  </div>

  <!-- Hidden inputs for tab state -->
  <input type="hidden" id="execution-type-filter" name="execution_type" x-model="activeTab" form="filters-form">
  <input type="hidden" id="workflow-type-tab-filter" name="workflow_type_tab" x-model="activeWorkflowType" form="filters-form">

  <%= render partial: "ruby_llm/agents/executions/filters", locals: { agent_types: @agent_types, model_ids: @model_ids, workflow_types: @workflow_types, filter_stats: @filter_stats } %>
  <%= render partial: "ruby_llm/agents/executions/list", locals: { executions: @executions, pagination: @pagination, filter_stats: @filter_stats } %>
</div>

<script>
  // Toggle attempts expansion (used by executions list)
  function toggleAttempts(executionId) {
    const attemptsRow = document.getElementById('attempts-row-' + executionId);
    const expandBtn = document.querySelector(`button[data-execution-id="${executionId}"]`);

    if (attemptsRow) {
      const isHidden = attemptsRow.classList.contains('hidden');
      attemptsRow.classList.toggle('hidden');

      // Rotate the chevron
      if (expandBtn) {
        const svg = expandBtn.querySelector('svg');
        if (svg) {
          svg.classList.toggle('rotate-90', isHidden);
        }
        expandBtn.setAttribute('aria-expanded', isHidden ? 'true' : 'false');
      }
    }
  }

  // Submit filters when tabs change
  function submitFilters() {
    // Delay to allow Alpine to update x-model values
    setTimeout(function() {
      const form = document.getElementById('filters-form');
      if (form) form.requestSubmit();
    }, 50);
  }
</script>
