<%# Version comparison UI for agents %>
<% if versions.size >= 2 %>
  <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6 mb-6">
    <div class="flex items-center justify-between mb-4">
      <h3 class="text-lg font-semibold text-gray-900 dark:text-gray-100">Version Comparison</h3>
      <span class="text-xs text-gray-500 dark:text-gray-400">This month's data</span>
    </div>

    <!-- Version Selectors -->
    <div class="flex items-center gap-4 mb-6">
      <div class="flex-1">
        <label class="block text-xs text-gray-500 dark:text-gray-400 mb-1">Version A</label>
        <select
          id="compare-v1"
          onchange="updateVersionComparison()"
          class="w-full px-3 py-2 text-sm bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 dark:text-gray-200"
        >
          <% versions.each do |v| %>
            <option value="<%= v %>" <%= v == version_comparison&.dig(:v1) ? 'selected' : '' %>>
              v<%= v %>
            </option>
          <% end %>
        </select>
      </div>

      <div class="flex items-center justify-center pt-4">
        <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"/>
        </svg>
      </div>

      <div class="flex-1">
        <label class="block text-xs text-gray-500 dark:text-gray-400 mb-1">Version B</label>
        <select
          id="compare-v2"
          onchange="updateVersionComparison()"
          class="w-full px-3 py-2 text-sm bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 dark:text-gray-200"
        >
          <% versions.each do |v| %>
            <option value="<%= v %>" <%= v == version_comparison&.dig(:v2) ? 'selected' : '' %>>
              v<%= v %>
            </option>
          <% end %>
        </select>
      </div>
    </div>

    <% if version_comparison && version_comparison[:data] %>
      <% data = version_comparison[:data] %>
      <% v1_stats = data[:v1] || {} %>
      <% v2_stats = data[:v2] || {} %>

      <!-- Comparison Table -->
      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
          <thead>
            <tr>
              <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Metric</th>
              <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">v<%= version_comparison[:v1] %></th>
              <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">v<%= version_comparison[:v2] %></th>
              <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Change</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-gray-100 dark:divide-gray-700">
            <!-- Executions -->
            <tr>
              <td class="px-4 py-3 text-sm text-gray-700 dark:text-gray-300">Executions</td>
              <td class="px-4 py-3 text-sm text-right text-gray-900 dark:text-gray-100 font-medium">
                <%= number_with_delimiter(v1_stats[:count] || 0) %>
              </td>
              <td class="px-4 py-3 text-sm text-right text-gray-900 dark:text-gray-100 font-medium">
                <%= number_with_delimiter(v2_stats[:count] || 0) %>
              </td>
              <td class="px-4 py-3 text-sm text-right">
                <% diff = (v2_stats[:count] || 0) - (v1_stats[:count] || 0) %>
                <span class="<%= diff > 0 ? 'text-green-600' : diff < 0 ? 'text-red-600' : 'text-gray-500' %>">
                  <%= diff > 0 ? '+' : '' %><%= number_with_delimiter(diff) %>
                </span>
              </td>
            </tr>

            <!-- Success Rate -->
            <tr>
              <td class="px-4 py-3 text-sm text-gray-700 dark:text-gray-300">Success Rate</td>
              <td class="px-4 py-3 text-sm text-right text-gray-900 dark:text-gray-100 font-medium">
                <%= (v1_stats[:success_rate] || 0).round(1) %>%
              </td>
              <td class="px-4 py-3 text-sm text-right text-gray-900 dark:text-gray-100 font-medium">
                <%= (v2_stats[:success_rate] || 0).round(1) %>%
              </td>
              <td class="px-4 py-3 text-sm text-right">
                <% diff = (v2_stats[:success_rate] || 0) - (v1_stats[:success_rate] || 0) %>
                <span class="<%= diff > 0 ? 'text-green-600' : diff < 0 ? 'text-red-600' : 'text-gray-500' %>">
                  <%= diff > 0 ? '+' : '' %><%= diff.round(1) %>%
                </span>
              </td>
            </tr>

            <!-- Avg Cost -->
            <tr>
              <td class="px-4 py-3 text-sm text-gray-700 dark:text-gray-300">Avg Cost</td>
              <td class="px-4 py-3 text-sm text-right text-gray-900 dark:text-gray-100 font-medium">
                $<%= number_with_precision(v1_stats[:avg_cost] || 0, precision: 6) %>
              </td>
              <td class="px-4 py-3 text-sm text-right text-gray-900 dark:text-gray-100 font-medium">
                $<%= number_with_precision(v2_stats[:avg_cost] || 0, precision: 6) %>
              </td>
              <td class="px-4 py-3 text-sm text-right">
                <% if (v1_stats[:avg_cost] || 0) > 0 %>
                  <% pct = data[:cost_change_pct] || (((v2_stats[:avg_cost] || 0) - (v1_stats[:avg_cost] || 0)) / (v1_stats[:avg_cost] || 1) * 100) %>
                  <span class="<%= pct < 0 ? 'text-green-600' : pct > 0 ? 'text-red-600' : 'text-gray-500' %>">
                    <%= pct > 0 ? '+' : '' %><%= pct.round(1) %>%
                  </span>
                <% else %>
                  <span class="text-gray-500">-</span>
                <% end %>
              </td>
            </tr>

            <!-- Avg Tokens -->
            <tr>
              <td class="px-4 py-3 text-sm text-gray-700 dark:text-gray-300">Avg Tokens</td>
              <td class="px-4 py-3 text-sm text-right text-gray-900 dark:text-gray-100 font-medium">
                <%= number_with_delimiter((v1_stats[:avg_tokens] || 0).round) %>
              </td>
              <td class="px-4 py-3 text-sm text-right text-gray-900 dark:text-gray-100 font-medium">
                <%= number_with_delimiter((v2_stats[:avg_tokens] || 0).round) %>
              </td>
              <td class="px-4 py-3 text-sm text-right">
                <% if (v1_stats[:avg_tokens] || 0) > 0 %>
                  <% pct = data[:token_change_pct] || (((v2_stats[:avg_tokens] || 0) - (v1_stats[:avg_tokens] || 0)) / (v1_stats[:avg_tokens] || 1) * 100) %>
                  <span class="<%= pct < 0 ? 'text-green-600' : pct > 0 ? 'text-red-600' : 'text-gray-500' %>">
                    <%= pct > 0 ? '+' : '' %><%= pct.round(1) %>%
                  </span>
                <% else %>
                  <span class="text-gray-500">-</span>
                <% end %>
              </td>
            </tr>

            <!-- Avg Duration -->
            <tr>
              <td class="px-4 py-3 text-sm text-gray-700 dark:text-gray-300">Avg Duration</td>
              <td class="px-4 py-3 text-sm text-right text-gray-900 dark:text-gray-100 font-medium">
                <%= number_with_delimiter((v1_stats[:avg_duration_ms] || 0).round) %> ms
              </td>
              <td class="px-4 py-3 text-sm text-right text-gray-900 dark:text-gray-100 font-medium">
                <%= number_with_delimiter((v2_stats[:avg_duration_ms] || 0).round) %> ms
              </td>
              <td class="px-4 py-3 text-sm text-right">
                <% if (v1_stats[:avg_duration_ms] || 0) > 0 %>
                  <% pct = data[:speed_change_pct] || (((v2_stats[:avg_duration_ms] || 0) - (v1_stats[:avg_duration_ms] || 0)) / (v1_stats[:avg_duration_ms] || 1) * 100) %>
                  <span class="<%= pct < 0 ? 'text-green-600' : pct > 0 ? 'text-red-600' : 'text-gray-500' %>">
                    <%= pct > 0 ? '+' : '' %><%= pct.round(1) %>%
                  </span>
                <% else %>
                  <span class="text-gray-500">-</span>
                <% end %>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <p class="mt-4 text-xs text-gray-500 dark:text-gray-400">
        Lower cost, tokens, and duration are better (shown in green). Higher success rate is better.
      </p>
    <% else %>
      <p class="text-sm text-gray-500 dark:text-gray-400 text-center py-4">
        No comparison data available for selected versions
      </p>
    <% end %>
  </div>

  <script>
    function updateVersionComparison() {
      const v1 = document.getElementById('compare-v1').value;
      const v2 = document.getElementById('compare-v2').value;
      const currentUrl = new URL(window.location.href);
      currentUrl.searchParams.set('compare_v1', v1);
      currentUrl.searchParams.set('compare_v2', v2);
      window.location.href = currentUrl.toString();
    }
  </script>
<% end %>
