<%# Collapsible version comparison UI - simplified for quick scanning %>
<% if versions.size >= 2 %>
  <%
    v1 = version_comparison&.dig(:v1)
    v2 = version_comparison&.dig(:v2)
    data = version_comparison&.dig(:data) || {}
    v1_stats = data[:v1] || {}
    v2_stats = data[:v2] || {}

    # Calculate metrics with changes
    metrics = [
      { name: "Success Rate", v1: v1_stats[:success_rate] || 0, v2: v2_stats[:success_rate] || 0, format: :pct, better: :higher },
      { name: "Avg Cost", v1: v1_stats[:avg_cost] || 0, v2: v2_stats[:avg_cost] || 0, format: :cost, better: :lower },
      { name: "Avg Tokens", v1: v1_stats[:avg_tokens] || 0, v2: v2_stats[:avg_tokens] || 0, format: :num, better: :lower },
      { name: "Avg Duration", v1: v1_stats[:avg_duration_ms] || 0, v2: v2_stats[:avg_duration_ms] || 0, format: :ms, better: :lower },
      { name: "Executions", v1: v1_stats[:count] || 0, v2: v2_stats[:count] || 0, format: :num, better: :higher }
    ]

    # Count improvements/regressions for summary
    improvements = 0
    regressions = 0
    metrics.each do |m|
      next if m[:v1].zero? && m[:v2].zero?
      if m[:better] == :higher
        improvements += 1 if m[:v2] > m[:v1]
        regressions += 1 if m[:v2] < m[:v1]
      else
        improvements += 1 if m[:v2] < m[:v1]
        regressions += 1 if m[:v2] > m[:v1]
      end
    end
  %>

  <div class="bg-white dark:bg-gray-800 rounded-lg shadow mb-6">
    <!-- Collapsible Header -->
    <button
      type="button"
      onclick="toggleVersionComparison()"
      class="w-full px-6 py-4 flex items-center justify-between hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors rounded-lg"
    >
      <div class="flex items-center gap-3">
        <svg id="version-chevron" class="w-5 h-5 text-gray-400 transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
        </svg>
        <h3 class="text-lg font-semibold text-gray-900 dark:text-gray-100">Version Comparison</h3>
        <span class="text-sm text-gray-500 dark:text-gray-400">v<%= v1 %> → v<%= v2 %></span>
      </div>

      <!-- Quick Summary Pills -->
      <div class="flex items-center gap-2">
        <% if improvements > 0 %>
          <span class="px-2 py-0.5 text-xs font-medium text-green-700 dark:text-green-300 bg-green-100 dark:bg-green-900/50 rounded-full">
            <%= improvements %> improved
          </span>
        <% end %>
        <% if regressions > 0 %>
          <span class="px-2 py-0.5 text-xs font-medium text-red-700 dark:text-red-300 bg-red-100 dark:bg-red-900/50 rounded-full">
            <%= regressions %> regressed
          </span>
        <% end %>
        <% if improvements == 0 && regressions == 0 %>
          <span class="px-2 py-0.5 text-xs font-medium text-gray-600 dark:text-gray-400 bg-gray-100 dark:bg-gray-700 rounded-full">
            No changes
          </span>
        <% end %>
      </div>
    </button>

    <!-- Collapsible Content -->
    <div id="version-comparison-content" class="hidden border-t border-gray-100 dark:border-gray-700">
      <div class="p-6">
        <!-- Version Selectors -->
        <div class="flex items-center gap-4 mb-4">
          <select id="compare-v1" onchange="updateVersionComparison()" class="flex-1 px-3 py-2 text-sm bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-lg dark:text-gray-200">
            <% versions.each do |ver| %>
              <option value="<%= ver %>" <%= ver == v1 ? 'selected' : '' %>>v<%= ver %></option>
            <% end %>
          </select>
          <span class="text-gray-400">→</span>
          <select id="compare-v2" onchange="updateVersionComparison()" class="flex-1 px-3 py-2 text-sm bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-lg dark:text-gray-200">
            <% versions.each do |ver| %>
              <option value="<%= ver %>" <%= ver == v2 ? 'selected' : '' %>>v<%= ver %></option>
            <% end %>
          </select>
        </div>

        <% if version_comparison && version_comparison[:data] %>
          <!-- Simple Comparison Table -->
          <table class="w-full text-sm">
            <thead>
              <tr class="text-xs text-gray-500 dark:text-gray-400 uppercase">
                <th class="text-left py-2">Metric</th>
                <th class="text-right py-2">v<%= v1 %></th>
                <th class="text-right py-2">v<%= v2 %></th>
                <th class="text-right py-2">Change</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-gray-100 dark:divide-gray-700">
              <% metrics.each do |m| %>
                <%
                  # Format values
                  case m[:format]
                  when :pct
                    f_v1 = "#{m[:v1].round(1)}%"
                    f_v2 = "#{m[:v2].round(1)}%"
                    diff = m[:v2] - m[:v1]
                    change = "#{diff >= 0 ? '+' : ''}#{diff.round(1)}pp"
                  when :cost
                    f_v1 = "$#{number_with_precision(m[:v1], precision: 4)}"
                    f_v2 = "$#{number_with_precision(m[:v2], precision: 4)}"
                    pct = m[:v1] > 0 ? ((m[:v2] - m[:v1]) / m[:v1] * 100) : 0
                    change = "#{pct >= 0 ? '+' : ''}#{pct.round(1)}%"
                  when :ms
                    f_v1 = "#{number_with_delimiter(m[:v1].round)}ms"
                    f_v2 = "#{number_with_delimiter(m[:v2].round)}ms"
                    pct = m[:v1] > 0 ? ((m[:v2] - m[:v1]) / m[:v1] * 100) : 0
                    change = "#{pct >= 0 ? '+' : ''}#{pct.round(1)}%"
                  else
                    f_v1 = number_with_delimiter(m[:v1].round)
                    f_v2 = number_with_delimiter(m[:v2].round)
                    pct = m[:v1] > 0 ? ((m[:v2] - m[:v1]) / m[:v1] * 100) : 0
                    change = "#{pct >= 0 ? '+' : ''}#{pct.round(1)}%"
                  end

                  # Determine if change is good/bad
                  is_better = m[:better] == :higher ? m[:v2] > m[:v1] : m[:v2] < m[:v1]
                  is_worse = m[:better] == :higher ? m[:v2] < m[:v1] : m[:v2] > m[:v1]
                  change_class = is_better ? "text-green-600 dark:text-green-400" : is_worse ? "text-red-600 dark:text-red-400" : "text-gray-500"
                %>
                <tr>
                  <td class="py-2 text-gray-700 dark:text-gray-300"><%= m[:name] %></td>
                  <td class="py-2 text-right text-gray-900 dark:text-gray-100 font-medium"><%= f_v1 %></td>
                  <td class="py-2 text-right text-gray-900 dark:text-gray-100 font-medium"><%= f_v2 %></td>
                  <td class="py-2 text-right font-medium <%= change_class %>"><%= change %></td>
                </tr>
              <% end %>
            </tbody>
          </table>

          <p class="mt-4 text-xs text-gray-400 dark:text-gray-500 text-center">
            Based on this month's data
          </p>
        <% else %>
          <p class="text-sm text-gray-500 dark:text-gray-400 text-center py-4">
            No data available for selected versions
          </p>
        <% end %>
      </div>
    </div>
  </div>

  <script>
    function toggleVersionComparison() {
      const content = document.getElementById('version-comparison-content');
      const chevron = document.getElementById('version-chevron');
      content.classList.toggle('hidden');
      chevron.classList.toggle('-rotate-180');
    }

    function updateVersionComparison() {
      const v1 = document.getElementById('compare-v1').value;
      const v2 = document.getElementById('compare-v2').value;
      const url = new URL(window.location.href);
      url.searchParams.set('compare_v1', v1);
      url.searchParams.set('compare_v2', v2);
      window.location.href = url.toString();
    }

    // Restore collapsed state from localStorage
    document.addEventListener('DOMContentLoaded', function() {
      const expanded = localStorage.getItem('version_comparison_expanded');
      if (expanded === 'true') {
        document.getElementById('version-comparison-content').classList.remove('hidden');
        document.getElementById('version-chevron').classList.add('-rotate-180');
      }
    });

    // Save state when toggling
    const originalToggle = toggleVersionComparison;
    toggleVersionComparison = function() {
      originalToggle();
      const isExpanded = !document.getElementById('version-comparison-content').classList.contains('hidden');
      localStorage.setItem('version_comparison_expanded', isExpanded);
    };
  </script>
<% end %>
