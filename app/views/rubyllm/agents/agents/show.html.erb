<div class="mb-6">
  <%= link_to ruby_llm_agents.agents_path, class: "text-blue-600 hover:underline" do %>
    <span class="inline-flex items-center">
      <svg
        class="w-4 h-4 mr-1"
        fill="none"
        stroke="currentColor"
        viewBox="0 0 24 24"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M10 19l-7-7m0 0l7-7m-7 7h18"
        />
      </svg>
      Back to Agents
    </span>
  <% end %>
</div>

<!-- Header -->
<div class="bg-white rounded-lg shadow p-6 mb-6">
  <div class="flex items-start justify-between">
    <div>
      <div class="flex items-center space-x-3">
        <h1 class="text-2xl font-bold text-gray-900">
          <%= @agent_type.gsub(/Agent$/, '') %>
        </h1>

        <% if @agent_active %>
          <span
            class="
              inline-flex items-center px-2.5 py-0.5 rounded-full text-xs
              font-medium bg-green-100 text-green-800
            "
          >
            Active
          </span>
        <% else %>
          <span
            class="
              inline-flex items-center px-2.5 py-0.5 rounded-full text-xs
              font-medium bg-gray-100 text-gray-600
            "
          >
            Deleted
          </span>
        <% end %>

        <% if @config %>
          <span class="text-sm text-gray-500">v<%= @config[:version] %></span>
        <% end %>
      </div>

      <% if @config %>
        <p class="text-gray-500 mt-1">
          <%= @config[:model] %> &middot; temp <%= @config[:temperature] %>
          &middot; timeout <%= @config[:timeout] %>s
        </p>
      <% end %>
    </div>

    <div class="text-right text-sm text-gray-500">
      <p><%= @stats[:count] %> total executions</p>
    </div>
  </div>
</div>

<!-- Stats Grid -->
<% success_rate = @stats[:success_rate] || 0 %>
<% success_rate_color = success_rate >= 95 ? 'text-green-600' : success_rate >= 80 ? 'text-yellow-600' : 'text-red-600' %>
<div class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-6">
  <%= render "rubyllm/agents/shared/stat_card",
      title: "Executions",
      value: number_with_delimiter(@stats[:count]),
      subtitle: "Today: #{@stats_today[:count]}",
      icon: "M13 10V3L4 14h7v7l9-11h-7z",
      icon_color: "text-blue-500" %>

  <%= render "rubyllm/agents/shared/stat_card",
      title: "Success Rate",
      value: "#{success_rate}%",
      subtitle: "Error rate: #{@stats[:error_rate] || 0}%",
      icon: "M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z",
      icon_color: "text-green-500",
      value_color: success_rate_color %>

  <%= render "rubyllm/agents/shared/stat_card",
      title: "Total Cost",
      value: "$#{number_with_precision(@stats[:total_cost] || 0, precision: 4)}",
      subtitle: "Avg: $#{number_with_precision(@stats[:avg_cost] || 0, precision: 6)}",
      icon: "M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z",
      icon_color: "text-amber-500" %>

  <%= render "rubyllm/agents/shared/stat_card",
      title: "Total Tokens",
      value: number_with_delimiter(@stats[:total_tokens] || 0),
      subtitle: "Avg: #{number_with_delimiter(@stats[:avg_tokens] || 0)}",
      icon: "M7 20l4-16m2 16l4-16M6 9h14M4 15h14",
      icon_color: "text-indigo-500" %>

  <%= render "rubyllm/agents/shared/stat_card",
      title: "Avg Duration",
      value: "#{number_with_delimiter(@stats[:avg_duration_ms] || 0)} ms",
      icon: "M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z",
      icon_color: "text-purple-500" %>
</div>

<!-- Charts Section -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
  <!-- Executions Over Time -->
  <div class="bg-white rounded-lg shadow p-6 pb-20 overflow-hidden">
    <h3 class="text-lg font-semibold text-gray-900 mb-4">
      Executions (30 days)
    </h3>

    <div id="executions-chart" style="height: 250px;">
      <% success_data = @trend_data.map { |d| [d[:date].strftime("%b %d"), d[:count] - (d[:error_count] || 0)] }.to_h
        failed_data = @trend_data.map { |d| [d[:date].strftime("%b %d"), d[:error_count] || 0] }.to_h %>

      <%= area_chart [
        { name: "Success", data: success_data },
        { name: "Failed", data: failed_data }
      ], colors: ["#10B981", "#EF4444"], stacked: true, library: { maintainAspectRatio: false } %>
    </div>
  </div>

  <!-- Cost Over Time -->
  <div class="bg-white rounded-lg shadow p-6 pb-8 overflow-hidden">
    <h3 class="text-lg font-semibold text-gray-900 mb-4">Cost (30 days)</h3>

    <div id="cost-chart" style="height: 250px;">
      <% cost_data = @trend_data.map { |d| [d[:date].strftime("%b %d"), d[:total_cost].to_f.round(4)] }.to_h %>

      <%= line_chart cost_data, colors: ["#10B981"], prefix: "$", library: { maintainAspectRatio: false, plugins: { legend: { display: false } } } %>
    </div>
  </div>
</div>

<!-- Status Distribution (compact) -->
<div class="bg-white rounded-lg shadow p-4 mb-6">
  <div class="flex items-center justify-between">
    <p class="text-sm text-gray-500 uppercase">Status Distribution</p>

    <div class="flex flex-wrap gap-4">
      <% status_colors = {
          "success" => "#10B981",
          "error" => "#EF4444",
          "timeout" => "#F59E0B",
          "running" => "#3B82F6"
        } %>

      <% @status_distribution.each do |status, count| %>
        <div class="flex items-center">
          <span
            class="w-2 h-2 rounded-full mr-1.5"
            style="background-color: <%= status_colors[status] || '#6B7280' %>"
          ></span>

          <span class="text-sm text-gray-700 capitalize"><%= status %></span>

          <span class="text-sm font-medium text-gray-900 ml-1">
            (<%= number_with_delimiter(count) %>)
          </span>
        </div>
      <% end %>
    </div>
  </div>
</div>

<% if @config %>
  <!-- Configuration -->
  <div class="bg-white rounded-lg shadow p-6 mb-6">
    <h3 class="text-lg font-semibold text-gray-900 mb-4">Configuration</h3>

    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
      <div>
        <p class="text-sm text-gray-500">Model</p>
        <p class="font-medium"><%= @config[:model] %></p>
      </div>

      <div>
        <p class="text-sm text-gray-500">Temperature</p>
        <p class="font-medium"><%= @config[:temperature] %></p>
      </div>

      <div>
        <p class="text-sm text-gray-500">Timeout</p>
        <p class="font-medium"><%= @config[:timeout] %> seconds</p>
      </div>

      <div>
        <p class="text-sm text-gray-500">Cache</p>

        <p class="font-medium">
          <% if @config[:cache_enabled] %>
            Enabled (
            <%= @config[:cache_ttl].inspect %>
            )
          <% else %>
            Disabled
          <% end %>
        </p>
      </div>
    </div>

    <% if @config[:params].present? && @config[:params].any? %>
      <div class="border-t border-gray-100 pt-4">
        <p class="text-sm text-gray-500 mb-2">Parameters</p>

        <div class="space-y-2">
          <% @config[:params].each do |name, opts| %>
            <div class="flex items-center text-sm">
              <code class="bg-gray-100 px-2 py-0.5 rounded font-mono">
                <%= name %>
              </code>

              <% if opts[:required] %>
                <span class="ml-2 text-xs text-red-500 font-medium">
                  required
                </span>
              <% elsif opts[:default].present? %>
                <span class="ml-2 text-xs text-gray-400">
                  default: <%= opts[:default].inspect %>
                </span>
              <% else %>
                <span class="ml-2 text-xs text-gray-400">optional</span>
              <% end %>
            </div>
          <% end %>
        </div>
      </div>
    <% end %>
  </div>
<% end %>

<!-- Executions -->
<div class="bg-white rounded-lg shadow p-6">
  <div class="flex items-center justify-between mb-4">
    <h3 class="text-lg font-semibold text-gray-900">Executions</h3>
    <%= link_to "View all", ruby_llm_agents.executions_path(agent_type: @agent_type), class: "text-sm text-blue-600 hover:underline" %>
  </div>

  <%= turbo_frame_tag "executions_table" do %>
    <%= render "rubyllm/agents/shared/executions_table", executions: @executions, pagination: @pagination %>
  <% end %>
</div>
