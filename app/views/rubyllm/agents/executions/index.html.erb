<h2 class="text-2xl font-bold text-gray-900 mb-6">Executions</h2>

<!-- Filters -->
<% has_filters = params[:agent_type].present? || params[:status].present? || params[:days].present? %>
<div class="bg-white rounded-xl border border-gray-200 p-4 mb-6">
  <div class="flex items-center justify-between mb-4">
    <div class="flex items-center gap-2">
      <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"/>
      </svg>
      <span class="text-sm font-medium text-gray-700">Filters</span>
    </div>
    <% if has_filters %>
      <%= link_to ruby_llm_agents.executions_path, class: "text-sm text-red-500 hover:text-red-600 flex items-center gap-1 transition-colors" do %>
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
        </svg>
        Clear all
      <% end %>
    <% end %>
  </div>

  <%= form_with url: ruby_llm_agents.search_executions_path, method: :get, data: { turbo_frame: "executions_list" }, id: "filters-form" do |f| %>
    <div class="flex flex-wrap gap-3">
      <!-- Agent Type Filter -->
      <div class="relative filter-dropdown">
        <button type="button" onclick="toggleDropdown(this)" class="flex items-center gap-2 px-3 py-2 text-sm bg-gray-50 border border-gray-200 rounded-lg hover:bg-gray-100 transition-colors <%= params[:agent_type].present? ? 'ring-2 ring-blue-500 ring-offset-1' : '' %>">
          <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
          </svg>
          <span class="text-gray-700"><%= params[:agent_type].present? ? params[:agent_type].gsub(/Agent$/, '') : 'All Agents' %></span>
          <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
          </svg>
        </button>
        <div class="dropdown-menu hidden absolute z-10 mt-1 w-48 bg-white rounded-lg shadow-lg border border-gray-200 py-1">
          <a href="#" onclick="selectFilter('agent_type', '', this); return false;" class="flex items-center gap-2 px-3 py-2 text-sm text-gray-700 hover:bg-gray-50 <%= params[:agent_type].blank? ? 'bg-blue-50 text-blue-700' : '' %>">
            <span class="w-4 h-4"></span>
            All Agents
          </a>
          <% @agent_types.each do |agent_type| %>
            <a href="#" onclick="selectFilter('agent_type', '<%= agent_type %>', this); return false;" class="flex items-center gap-2 px-3 py-2 text-sm text-gray-700 hover:bg-gray-50 <%= params[:agent_type] == agent_type ? 'bg-blue-50 text-blue-700' : '' %>">
              <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
              </svg>
              <%= agent_type.gsub(/Agent$/, '') %>
            </a>
          <% end %>
        </div>
        <%= f.hidden_field :agent_type, value: params[:agent_type], id: "filter_agent_type" %>
      </div>

      <!-- Status Filter -->
      <div class="relative filter-dropdown">
        <button type="button" onclick="toggleDropdown(this)" class="flex items-center gap-2 px-3 py-2 text-sm bg-gray-50 border border-gray-200 rounded-lg hover:bg-gray-100 transition-colors <%= params[:status].present? ? 'ring-2 ring-blue-500 ring-offset-1' : '' %>">
          <% status_color = case params[:status]
             when 'success' then 'bg-green-500'
             when 'error' then 'bg-red-500'
             when 'running' then 'bg-blue-500'
             when 'timeout' then 'bg-yellow-500'
             else 'bg-gray-400'
             end %>
          <span class="w-2 h-2 rounded-full <%= status_color %>"></span>
          <span class="text-gray-700"><%= params[:status].present? ? params[:status].capitalize : 'All Statuses' %></span>
          <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
          </svg>
        </button>
        <div class="dropdown-menu hidden absolute z-10 mt-1 w-40 bg-white rounded-lg shadow-lg border border-gray-200 py-1">
          <a href="#" onclick="selectFilter('status', '', this); return false;" class="flex items-center gap-2 px-3 py-2 text-sm text-gray-700 hover:bg-gray-50 <%= params[:status].blank? ? 'bg-blue-50 text-blue-700' : '' %>">
            <span class="w-2 h-2 rounded-full bg-gray-400"></span>
            All Statuses
          </a>
          <a href="#" onclick="selectFilter('status', 'success', this); return false;" class="flex items-center gap-2 px-3 py-2 text-sm text-gray-700 hover:bg-gray-50 <%= params[:status] == 'success' ? 'bg-blue-50 text-blue-700' : '' %>">
            <span class="w-2 h-2 rounded-full bg-green-500"></span>
            Success
          </a>
          <a href="#" onclick="selectFilter('status', 'error', this); return false;" class="flex items-center gap-2 px-3 py-2 text-sm text-gray-700 hover:bg-gray-50 <%= params[:status] == 'error' ? 'bg-blue-50 text-blue-700' : '' %>">
            <span class="w-2 h-2 rounded-full bg-red-500"></span>
            Error
          </a>
          <a href="#" onclick="selectFilter('status', 'running', this); return false;" class="flex items-center gap-2 px-3 py-2 text-sm text-gray-700 hover:bg-gray-50 <%= params[:status] == 'running' ? 'bg-blue-50 text-blue-700' : '' %>">
            <span class="w-2 h-2 rounded-full bg-blue-500 animate-pulse"></span>
            Running
          </a>
          <a href="#" onclick="selectFilter('status', 'timeout', this); return false;" class="flex items-center gap-2 px-3 py-2 text-sm text-gray-700 hover:bg-gray-50 <%= params[:status] == 'timeout' ? 'bg-blue-50 text-blue-700' : '' %>">
            <span class="w-2 h-2 rounded-full bg-yellow-500"></span>
            Timeout
          </a>
        </div>
        <%= f.hidden_field :status, value: params[:status], id: "filter_status" %>
      </div>

      <!-- Time Range Filter -->
      <div class="relative filter-dropdown">
        <button type="button" onclick="toggleDropdown(this)" class="flex items-center gap-2 px-3 py-2 text-sm bg-gray-50 border border-gray-200 rounded-lg hover:bg-gray-100 transition-colors <%= params[:days].present? ? 'ring-2 ring-blue-500 ring-offset-1' : '' %>">
          <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
          </svg>
          <span class="text-gray-700">
            <% case params[:days]
               when '1' then %>Today<%
               when '7' then %>Last 7 Days<%
               when '30' then %>Last 30 Days<%
               else %>All Time<%
               end %>
          </span>
          <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
          </svg>
        </button>
        <div class="dropdown-menu hidden absolute z-10 mt-1 w-40 bg-white rounded-lg shadow-lg border border-gray-200 py-1">
          <a href="#" onclick="selectFilter('days', '', this); return false;" class="flex items-center gap-2 px-3 py-2 text-sm text-gray-700 hover:bg-gray-50 <%= params[:days].blank? ? 'bg-blue-50 text-blue-700' : '' %>">
            <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
            </svg>
            All Time
          </a>
          <a href="#" onclick="selectFilter('days', '1', this); return false;" class="flex items-center gap-2 px-3 py-2 text-sm text-gray-700 hover:bg-gray-50 <%= params[:days] == '1' ? 'bg-blue-50 text-blue-700' : '' %>">
            <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
            Today
          </a>
          <a href="#" onclick="selectFilter('days', '7', this); return false;" class="flex items-center gap-2 px-3 py-2 text-sm text-gray-700 hover:bg-gray-50 <%= params[:days] == '7' ? 'bg-blue-50 text-blue-700' : '' %>">
            <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
            </svg>
            Last 7 Days
          </a>
          <a href="#" onclick="selectFilter('days', '30', this); return false;" class="flex items-center gap-2 px-3 py-2 text-sm text-gray-700 hover:bg-gray-50 <%= params[:days] == '30' ? 'bg-blue-50 text-blue-700' : '' %>">
            <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
            </svg>
            Last 30 Days
          </a>
        </div>
        <%= f.hidden_field :days, value: params[:days], id: "filter_days" %>
      </div>
    </div>
  <% end %>
</div>

<script>
  function toggleDropdown(button) {
    // Close all other dropdowns first
    document.querySelectorAll('.filter-dropdown .dropdown-menu').forEach(menu => {
      if (menu !== button.nextElementSibling) {
        menu.classList.add('hidden');
      }
    });
    // Toggle this dropdown
    button.nextElementSibling.classList.toggle('hidden');
  }

  function selectFilter(name, value, element) {
    document.getElementById('filter_' + name).value = value;
    // Close dropdown
    element.closest('.dropdown-menu').classList.add('hidden');
    // Submit form
    document.getElementById('filters-form').requestSubmit();
  }

  // Close dropdowns when clicking outside
  document.addEventListener('click', function(e) {
    if (!e.target.closest('.filter-dropdown')) {
      document.querySelectorAll('.filter-dropdown .dropdown-menu').forEach(menu => {
        menu.classList.add('hidden');
      });
    }
  });
</script>

<!-- Executions List -->
<%= turbo_frame_tag "executions_list" do %>
  <%= render partial: "rubyllm/agents/executions/list", locals: { executions: @executions, pagination: @pagination } %>
<% end %>
