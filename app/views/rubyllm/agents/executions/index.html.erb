<h2 class="text-2xl font-bold text-gray-900 dark:text-gray-100 mb-6">Executions</h2>

<%= turbo_frame_tag "executions_content" do %>
  <%= render partial: "rubyllm/agents/executions/filters", locals: { agent_types: @agent_types, filter_stats: @filter_stats } %>
  <%= render partial: "rubyllm/agents/executions/list", locals: { executions: @executions, pagination: @pagination, filter_stats: @filter_stats } %>
<% end %>

<script>
  function toggleDropdown(button) {
    document.querySelectorAll('.filter-dropdown .dropdown-menu').forEach(menu => {
      if (menu !== button.nextElementSibling) {
        menu.classList.add('hidden');
      }
    });
    button.nextElementSibling.classList.toggle('hidden');
  }

  function selectSingleFilter(name, value, label) {
    document.getElementById('filter_' + name).value = value;
    // Update button label
    const dropdown = document.querySelector(`[data-filter="${name}"]`);
    dropdown.querySelector('.dropdown-label').textContent = label;
    // Update ring
    const button = dropdown.querySelector('button');
    if (value) {
      button.classList.add('ring-2', 'ring-blue-500', 'ring-offset-1');
    } else {
      button.classList.remove('ring-2', 'ring-blue-500', 'ring-offset-1');
    }
    // Close dropdown and submit
    dropdown.querySelector('.dropdown-menu').classList.add('hidden');
    document.getElementById('filters-form').requestSubmit();
  }

  function toggleAllOptions(checkbox, filterName) {
    const dropdown = document.querySelector(`[data-filter="${filterName}"]`);
    const checkboxes = dropdown.querySelectorAll('.filter-checkbox');

    if (checkbox.checked) {
      // Uncheck all specific options
      checkboxes.forEach(cb => cb.checked = false);
      updateMultiSelect(filterName);
    }
  }

  function updateMultiSelect(filterName) {
    const dropdown = document.querySelector(`[data-filter="${filterName}"]`);
    const checkboxes = dropdown.querySelectorAll('.filter-checkbox:checked');
    const selectAllCheckbox = dropdown.querySelector('.select-all-checkbox');
    const button = dropdown.querySelector('button');
    const label = dropdown.querySelector('.dropdown-label');

    const count = checkboxes.length;

    // Update "All" checkbox
    selectAllCheckbox.checked = (count === 0);

    // Update label
    if (count === 0) {
      label.textContent = filterName === 'agent_types' ? 'All Agents' : 'All Statuses';
      button.classList.remove('ring-2', 'ring-blue-500', 'ring-offset-1');
    } else if (count === 1) {
      const value = checkboxes[0].value;
      label.textContent = filterName === 'agent_types' ? value.replace(/Agent$/, '') : value.charAt(0).toUpperCase() + value.slice(1);
      button.classList.add('ring-2', 'ring-blue-500', 'ring-offset-1');
    } else {
      label.textContent = `${count} ${filterName === 'agent_types' ? 'Agents' : 'Statuses'}`;
      button.classList.add('ring-2', 'ring-blue-500', 'ring-offset-1');
    }

    // Submit form
    document.getElementById('filters-form').requestSubmit();
  }

  // Close dropdowns when clicking outside
  document.addEventListener('click', function(e) {
    if (!e.target.closest('.filter-dropdown')) {
      document.querySelectorAll('.filter-dropdown .dropdown-menu').forEach(menu => {
        menu.classList.add('hidden');
      });
    }
  });

  // Search debounce
  let searchDebounceTimer = null;
  function debounceSearch(input) {
    clearTimeout(searchDebounceTimer);
    searchDebounceTimer = setTimeout(function() {
      document.getElementById('filters-form').requestSubmit();
    }, 300);
  }

  // Attach debounce to search input
  document.addEventListener('turbo:load', function() {
    const searchInput = document.querySelector('input[name="q"]');
    if (searchInput) {
      searchInput.addEventListener('input', function() {
        debounceSearch(this);
      });
    }
  });

  // Clear search
  function clearSearch() {
    const searchInput = document.querySelector('input[name="q"]');
    if (searchInput) {
      searchInput.value = '';
      document.getElementById('filters-form').requestSubmit();
    }
  }

  // Toggle attempts expansion
  function toggleAttempts(executionId) {
    const attemptsRow = document.getElementById('attempts-row-' + executionId);
    const expandBtn = document.querySelector(`button[data-execution-id="${executionId}"]`);

    if (attemptsRow) {
      const isHidden = attemptsRow.classList.contains('hidden');
      attemptsRow.classList.toggle('hidden');

      // Rotate the chevron
      if (expandBtn) {
        const svg = expandBtn.querySelector('svg');
        if (svg) {
          svg.classList.toggle('rotate-90', isHidden);
        }
        expandBtn.setAttribute('aria-expanded', isHidden ? 'true' : 'false');
      }
    }
  }
</script>
