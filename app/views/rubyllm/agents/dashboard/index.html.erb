<!-- Action Center (only when critical alerts exist) -->
<%= render partial: "rubyllm/agents/dashboard/action_center", locals: { critical_alerts: @critical_alerts } %>

<!-- Now Strip -->
<%= render partial: "rubyllm/agents/dashboard/now_strip", locals: { now_strip: @now_strip } %>

<!-- Activity Chart -->
<div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700 mb-6">
  <div class="px-6 py-3 border-b border-gray-100 dark:border-gray-700">
    <h3 class="text-base font-semibold text-gray-900 dark:text-gray-100">Activity</h3>
  </div>

  <div id="activity-chart-container" class="p-4 h-[250px] sm:h-[300px]">
    <div id="activity-chart" style="width: 100%; height: 100%;"></div>
  </div>

  <script>
    (function() {
      const range = '<%= @selected_range %>';
      const chartUrl = '<%= ruby_llm_agents.chart_data_path %>?range=' + range;
      const hourMs = 3600000;
      const dayMs = 24 * hourMs;

      function convertToDatetimePoints(data, range) {
        const now = Date.now();
        const numPoints = data.length;

        if (range === 'today') {
          // Hourly points for last 24 hours
          return data.map((val, i) => [now - (numPoints - 1 - i) * hourMs, val]);
        } else {
          // Daily points
          return data.map((val, i) => [now - (numPoints - 1 - i) * dayMs, val]);
        }
      }

      function initChart() {
        fetch(chartUrl)
          .then(res => res.json())
          .then(data => {
            const now = Date.now();
            const successData = convertToDatetimePoints(data.series[0].data, range);
            const failedData = convertToDatetimePoints(data.series[1].data, range);

            const timeRange = range === 'today' ? dayMs : (range === '7d' ? 7 * dayMs : 30 * dayMs);
            const tooltipFormat = range === 'today' ? '{point.x:%H:%M} - {point.y}' : '{point.x:%b %d} - {point.y}';

            Highcharts.chart('activity-chart', {
              chart: { type: 'areaspline', backgroundColor: 'transparent' },
              title: { text: null },
              xAxis: {
                type: 'datetime',
                min: now - timeRange,
                max: now,
                labels: { style: { color: '#9CA3AF' } },
                lineColor: 'rgba(156, 163, 175, 0.2)'
              },
              yAxis: {
                title: { text: null },
                min: 0,
                allowDecimals: false,
                labels: { style: { color: '#9CA3AF' } },
                gridLineColor: 'rgba(156, 163, 175, 0.2)'
              },
              legend: { enabled: false },
              credits: { enabled: false },
              tooltip: {
                backgroundColor: 'rgba(17, 24, 39, 0.9)',
                borderColor: 'rgba(75, 85, 99, 0.5)',
                style: { color: '#F3F4F6' },
                headerFormat: '<b>{series.name}</b><br/>',
                pointFormat: tooltipFormat
              },
              plotOptions: {
                areaspline: {
                  fillOpacity: 0.2,
                  lineWidth: 2,
                  marker: { enabled: false }
                }
              },
              series: [
                { name: 'Success', color: '#10B981', data: successData },
                { name: 'Failed', color: '#EF4444', data: failedData }
              ]
            });
          })
          .catch(err => console.log('[RubyLLM::Agents] Chart error:', err));
      }

      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initChart);
      } else {
        initChart();
      }
    })();
  </script>
</div>

<!-- Live Activity Feed -->
<div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700 mb-6">
  <div class="px-6 py-3 border-b border-gray-100 dark:border-gray-700">
    <div class="flex justify-between items-center">
      <h3 class="text-base font-semibold text-gray-900 dark:text-gray-100">Recent Activity</h3>
      <%= link_to "View All", ruby_llm_agents.executions_path, data: { turbo: false }, class: "text-blue-600 dark:text-blue-400 hover:text-blue-700 dark:hover:text-blue-300 text-sm font-medium" %>
    </div>
  </div>
  <div id="activity-feed" class="px-6 py-2">
    <% if @recent_executions.any? %>
      <% @recent_executions.first(5).each do |execution| %>
        <%= render partial: "rubyllm/agents/dashboard/execution_item", locals: { execution: execution } %>
      <% end %>
    <% else %>
      <div class="py-8 text-center text-gray-500 dark:text-gray-400">
        <p class="text-sm">No executions yet</p>
      </div>
    <% end %>
  </div>
</div>

<!-- Agent Comparison + Top Errors -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
  <%= render partial: "rubyllm/agents/dashboard/agent_comparison", locals: { agent_stats: @agent_stats } %>
  <%= render partial: "rubyllm/agents/dashboard/top_errors", locals: { top_errors: @top_errors } %>
</div>
