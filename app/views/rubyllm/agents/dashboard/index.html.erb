<!-- Action Center (only when critical alerts exist) -->
<%= render partial: "rubyllm/agents/dashboard/action_center", locals: { critical_alerts: @critical_alerts } %>

<!-- Now Strip -->
<%= render partial: "rubyllm/agents/dashboard/now_strip", locals: { now_strip: @now_strip } %>

<!-- Today's Activity Chart -->
<div
  class="
    bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-100
    dark:border-gray-700 mb-6
  "
>
  <div class="px-6 py-4 border-b border-gray-100 dark:border-gray-700">
    <div class="flex justify-between items-center">
      <div class="flex items-center space-x-2">
        <h3 class="text-lg font-semibold text-gray-900 dark:text-gray-100">
          Activity
        </h3>

        <span class="flex items-center text-xs text-green-600 dark:text-green-400">
          <span class="w-1.5 h-1.5 bg-green-500 rounded-full mr-1 animate-pulse"></span>
          Live
        </span>
      </div>

      <span class="text-xs text-gray-400 dark:text-gray-500">
        Updates every 5s
      </span>
    </div>
  </div>

  <div
    id="hourly-chart"
    class="p-6 pb-3 pt-8 h-[280px] sm:h-[400px]"
    data-chart-url="<%= ruby_llm_agents.chart_data_path %>"
  >
    <div id="activity-chart" style="width: 100%; height: 100%;"></div>
  </div>

  <script>
    (function() {
      const chartUrl = '<%= ruby_llm_agents.chart_data_path %>';
      let activityChart = null;
      const hourMs = 3600000;
      const dayMs = 24 * hourMs;

      // Convert server data to datetime points
      function convertToDatetimePoints(data) {
        const now = Date.now();
        const numPoints = data.length;
        return data.map((val, i) => {
          // Each point is 1 hour apart, last point at current hour
          return [now - (numPoints - 1 - i) * hourMs, val];
        });
      }

      function initLiveChart() {
        fetch(chartUrl)
          .then(res => res.json())
          .then(data => {
            const now = Date.now();
            const successData = convertToDatetimePoints(data.series[0].data);
            const failedData = convertToDatetimePoints(data.series[1].data);

            activityChart = Highcharts.chart('activity-chart', {
              chart: {
                type: 'spline',
                backgroundColor: 'transparent',
                animation: { duration: 300 }
              },
              title: { text: null },
              xAxis: {
                type: 'datetime',
                tickPixelInterval: 150,
                min: now - dayMs,
                max: now,
                labels: { style: { color: '#9CA3AF' } },
                lineColor: 'rgba(156, 163, 175, 0.2)'
              },
              yAxis: {
                title: { text: null },
                min: 0,
                allowDecimals: false,
                labels: { style: { color: '#9CA3AF' } },
                gridLineColor: 'rgba(156, 163, 175, 0.2)'
              },
              legend: {
                align: 'center',
                verticalAlign: 'bottom',
                itemStyle: { color: '#9CA3AF' }
              },
              credits: { enabled: false },
              tooltip: {
                backgroundColor: 'rgba(17, 24, 39, 0.9)',
                borderColor: 'rgba(75, 85, 99, 0.5)',
                style: { color: '#F3F4F6' },
                headerFormat: '<b>{series.name}</b><br/>',
                pointFormat: '{point.x:%H:%M} - {point.y}'
              },
              plotOptions: {
                spline: {
                  lineWidth: 2,
                  marker: {
                    enabled: true,
                    radius: 4,
                    symbol: 'circle'
                  }
                }
              },
              series: [{
                name: 'Success',
                color: '#10B981',
                data: successData
              }, {
                name: 'Failed',
                color: '#EF4444',
                data: failedData
              }]
            });

            // Update chart every 5 seconds with fresh data
            setInterval(function() {
              fetch(chartUrl)
                .then(res => res.json())
                .then(newData => {
                  const now = Date.now();
                  const newSuccessData = convertToDatetimePoints(newData.series[0].data);
                  const newFailedData = convertToDatetimePoints(newData.series[1].data);

                  // Update x-axis range
                  activityChart.xAxis[0].setExtremes(now - dayMs, now, false);

                  // Replace series data
                  activityChart.series[0].setData(newSuccessData, false);
                  activityChart.series[1].setData(newFailedData, true);
                });
            }, 5000);
          })
          .catch(err => console.log('[RubyLLM::Agents] Chart init error:', err));
      }

      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initLiveChart);
      } else {
        initLiveChart();
      }
    })();
  </script>
</div>

<!-- Live Activity Feed -->
<div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700 mb-6">
  <div class="px-6 py-3 border-b border-gray-100 dark:border-gray-700">
    <div class="flex justify-between items-center">
      <h3 class="text-base font-semibold text-gray-900 dark:text-gray-100">Recent Activity</h3>
      <%= link_to "View All", ruby_llm_agents.executions_path, data: { turbo: false }, class: "text-blue-600 dark:text-blue-400 hover:text-blue-700 dark:hover:text-blue-300 text-sm font-medium" %>
    </div>
  </div>
  <div id="activity-feed" class="px-6 py-2">
    <% if @recent_executions.any? %>
      <% @recent_executions.first(5).each do |execution| %>
        <%= render partial: "rubyllm/agents/dashboard/execution_item", locals: { execution: execution } %>
      <% end %>
    <% else %>
      <div class="py-8 text-center text-gray-500 dark:text-gray-400">
        <p class="text-sm">No executions yet</p>
      </div>
    <% end %>
  </div>
</div>

<!-- Agent Comparison + Top Errors -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
  <%= render partial: "rubyllm/agents/dashboard/agent_comparison", locals: { agent_stats: @agent_stats } %>
  <%= render partial: "rubyllm/agents/dashboard/top_errors", locals: { top_errors: @top_errors } %>
</div>
