# frozen_string_literal: true

# Migration to create the tenants table for multi-tenancy support
#
# This table stores tenant configuration including:
# - Budget limits (cost, tokens, executions)
# - Enforcement mode (none, soft, hard)
# - Polymorphic link to user's tenant model
#
# Run with: rails db:migrate
class CreateRubyLLMAgentsTenants < ActiveRecord::Migration<%= migration_version %>
  def change
    create_table :ruby_llm_agents_tenants do |t|
      # Identity
      t.string :tenant_id, null: false
      t.string :name

      # Polymorphic association to user's tenant model (e.g., Organization, Account)
      # Uses string type for tenant_record_id to support both integer and UUID primary keys
      t.string :tenant_record_type
      t.string :tenant_record_id

      # Cost limits (in USD, 6 decimal precision)
      t.decimal :daily_limit, precision: 12, scale: 6
      t.decimal :monthly_limit, precision: 12, scale: 6

      # Token limits
      t.bigint :daily_token_limit
      t.bigint :monthly_token_limit

      # Execution/call limits
      t.bigint :daily_execution_limit
      t.bigint :monthly_execution_limit

      # Per-agent limits (JSON hash)
      # Format: { "AgentName" => limit_value }
      t.json :per_agent_daily, null: false, default: {}
      t.json :per_agent_monthly, null: false, default: {}

      # Enforcement mode: "none", "soft", or "hard"
      # - none: no enforcement, only tracking
      # - soft: log warnings when limits exceeded
      # - hard: block execution when limits exceeded
      t.string :enforcement, default: "soft"

      # Whether to inherit from global config for unset limits
      t.boolean :inherit_global_defaults, default: true

      # Status (for soft-delete/disable)
      t.boolean :active, default: true

      # Rate limiting
      # - rate_limit_per_minute: max requests per minute
      # - rate_limit_per_hour: max requests per hour
      t.integer :rate_limit_per_minute
      t.integer :rate_limit_per_hour

      # Feature flags (JSON hash)
      # Format: { "feature_name" => true/false }
      t.json :feature_flags, null: false, default: {}

      # Model restrictions (JSON arrays)
      # - allowed_models: whitelist of model IDs (empty = all allowed)
      # - blocked_models: blacklist of model IDs
      t.json :allowed_models, null: false, default: []
      t.json :blocked_models, null: false, default: []

      # Extensible metadata (JSON)
      t.json :metadata, null: false, default: {}

      t.timestamps
    end

    # Ensure unique tenant IDs
    add_index :ruby_llm_agents_tenants, :tenant_id, unique: true

    # Index for name lookups
    add_index :ruby_llm_agents_tenants, :name

    # Index for active/inactive filtering
    add_index :ruby_llm_agents_tenants, :active

    # Index for polymorphic tenant record lookup
    add_index :ruby_llm_agents_tenants,
              [:tenant_record_type, :tenant_record_id],
              name: "index_tenants_on_tenant_record"
  end
end
