# frozen_string_literal: true

class CreateRubyLLMAgentsExecutions < ActiveRecord::Migration<%= migration_version %>
  def change
    create_table :ruby_llm_agents_executions do |t|
      # Agent identification
      t.string :agent_type, null: false
      t.string :execution_type, null: false, default: "chat"

      # Model configuration
      t.string :model_id, null: false
      t.string :model_provider
      t.decimal :temperature, precision: 3, scale: 2
      t.string :chosen_model_id

      # Status
      t.string :status, null: false, default: "running"
      t.string :finish_reason
      t.string :error_class

      # Timing
      t.datetime :started_at, null: false
      t.datetime :completed_at
      t.integer :duration_ms

      # Token usage
      t.integer :input_tokens, default: 0
      t.integer :output_tokens, default: 0
      t.integer :total_tokens, default: 0
      t.integer :cached_tokens, default: 0

      # Costs (in dollars, 6 decimal precision)
      t.decimal :input_cost, precision: 12, scale: 6
      t.decimal :output_cost, precision: 12, scale: 6
      t.decimal :total_cost, precision: 12, scale: 6

      # Caching
      t.boolean :cache_hit, default: false

      # Streaming
      t.boolean :streaming, default: false

      # Retry / Fallback
      t.integer :attempts_count, default: 1, null: false

      # Tool calls
      t.integer :tool_calls_count, default: 0, null: false

      # Distributed tracing
      t.string :trace_id
      t.string :request_id

      # Execution hierarchy (self-join)
      t.bigint :parent_execution_id
      t.bigint :root_execution_id

      # Multi-tenancy
      t.string :tenant_id

      # Conversation context
      t.integer :messages_count, default: 0, null: false

      # Flexible storage (niche fields, trace context, custom tags)
      t.json :metadata, null: false, default: {}

      t.timestamps
    end

    # Indexes: only what's actually queried
    add_index :ruby_llm_agents_executions, [:agent_type, :created_at]
    add_index :ruby_llm_agents_executions, [:agent_type, :status]
    add_index :ruby_llm_agents_executions, :status
    add_index :ruby_llm_agents_executions, :created_at
    add_index :ruby_llm_agents_executions, [:tenant_id, :created_at]
    add_index :ruby_llm_agents_executions, [:tenant_id, :status]
    add_index :ruby_llm_agents_executions, :trace_id
    add_index :ruby_llm_agents_executions, :request_id
    add_index :ruby_llm_agents_executions, :parent_execution_id
    add_index :ruby_llm_agents_executions, :root_execution_id

    # Foreign keys for execution hierarchy
    add_foreign_key :ruby_llm_agents_executions, :ruby_llm_agents_executions,
                    column: :parent_execution_id, on_delete: :nullify
    add_foreign_key :ruby_llm_agents_executions, :ruby_llm_agents_executions,
                    column: :root_execution_id, on_delete: :nullify

    # GIN indexes for JSONB columns (PostgreSQL only)
    # Uncomment if using PostgreSQL:
    # add_index :ruby_llm_agents_executions, :metadata, using: :gin
  end
end
